<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>如何用 Blazor 实现 Ant Design 组件库（二）</title>
      <link href="/how-to-implement-ant-design-components-using-blazor-2.html"/>
      <url>/how-to-implement-ant-design-components-using-blazor-2.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前两周，我发表了上一篇文章《如何用 Blazor 实现 Ant Design 组件库？》，得到了很多朋友的响应，也有很多朋友加入我的钉钉群，并收听了我在第二天的直播。</p><p>这次直播是我人生第一次做直播，以至于没做什么准备，主要介绍了 AntBlazor 项目的情况，和介绍了 Blazor 框架的一些知识点，其中穿插了我之前用 Blazor 实现二维码多端登录。结果没有重点地一讲讲了4个小时。</p><p>这次直播我有录播，地址在：<a href="https://www.bilibili.com/video/BV1uE411c7Hc。大家也可以在钉钉群看回放。" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1uE411c7Hc。大家也可以在钉钉群看回放。</a></p><p>两周过去了，在这个清明假期，我准备在假期的最后一天再来直播，但不会讲那么久了，免得占用大家太多的时间。同样在钉钉群和B站同时直播，并开启录播。</p><ul><li>时间：4月6日 下午2:00 - 5:00</li><li>直播间：<a href="https://live.bilibili.com/22040564" target="_blank" rel="noopener">https://live.bilibili.com/22040564</a></li><li>钉钉群：项目 README 底部二维码（推荐）</li></ul><p>好了，预告说完了，本篇主要讲一讲关于开发 Blazor 的价值和我从 AntBlazor 项目中获得的不少益处。</p><p>项目地址: <a href="https://github.com/ElderJames/ant-design-blazor" target="_blank" rel="noopener">https://github.com/ElderJames/ant-design-blazor</a></p><h1 id="Blazor-是否值得关注"><a href="#Blazor-是否值得关注" class="headerlink" title="Blazor 是否值得关注"></a>Blazor 是否值得关注</h1><p>Blazor 是一个全新的框架，目前 WebAssembly 的版本还在 Preview 阶段，将于5月19日Build大会期间发布正式。</p><p>所以在我推广 AntBlazor 时就有很多人质疑：现在投入精力开发组件库是否值得？会不会跟 Webform 一样只有微软自己玩最后被放弃？是否需要等成熟了再去了解？</p><p>首先，大家要了解 Blazor 是一个全能的框架：</p><ul><li>服务端：使用 WebSocket 实现 dom 的节点渲染</li><li>浏览器端：利用 WebAssembly 托管.NET Runtime，运行完整的 SPA 应用</li><li>PWA：支持离线运行</li><li>移动端：基于Xamarin，实现原生控件的绑定</li><li>原生应用：.NET 5 正式发布时会有 Blazor 原生应用的预览版本</li></ul><p>相对于三大框架的初期版本，Blazor 基于 .NET 生态，已经有很多完备的组件。如路由、依赖注入、状态管理、国际化/本地化、权限控制、GC、调试工具、模板等……这些组件在已有前端框架中，哪些是一发布就全都有的？</p><p>当然，要是跟现在的前端框架比起来，Blazor 在生态上还是有很大的发展空间，但是我们依然能看到它的巨大潜力。作为一个受欢迎的开源项目，自然会吸引到开源社区的开发者一起来丰富生态。而且相对于后端，前端的生态发展应该是更容易的。</p><p>在这种情况下，我们除了等待官方开发组开发新特性之外，围绕已有的核心组件，还是可以做很多生态上的补充的。</p><p>AntBlazor 就是致力于丰富 Blazor 生态的众多开源项目之一。</p><h1 id="开发-Blazor-项目的价值"><a href="#开发-Blazor-项目的价值" class="headerlink" title="开发 Blazor 项目的价值"></a>开发 Blazor 项目的价值</h1><p>AntBlazor 是一个让大家在开源实践的同时学习 Blazor 以及其他技能的项目，它在 Blazor WebAssembly 3.1 preview 阶段被创建，有一段时间是实验性地开发组件和基于 WebAssembly 的文档项目。而在 3.2 preview 1 之后开始伴随着每个 preview 版本，都会在项目中尽量把最新特性都用上。</p><ul><li>从最开始的普通类库项目转换成 Razor Class Library，因发布文件的目录结构变更修改 Github Actions 的 CI 脚本</li><li>加入 PWA 特性支持，我们的文档页面可以安装成 PWA。</li><li>调整 Debugging 支持，现在文档的 WebAssembly 项目也支持断点调试了。</li></ul><p>除了官方发布的新特性，我自己也在创造性地让项目更具“前端气息”，利用 Blazor 做更多有用的实践。</p><h2 id="改造路由"><a href="#改造路由" class="headerlink" title="改造路由"></a>改造路由</h2><p>路由组件是最基础的组件，官方的路由实现了最基本的事情——路由表和导航，而为了让它更易于使用，我一直在改进它。</p><ul><li>既支持原来用特性指定的路由，也支持用目录的路径作为路由的约定方式</li><li>支持 Url QueryString 的属性绑定</li><li>支持默认终结点</li><li>支持切换语言，实现本地化</li></ul><p>路由的改造是在分析过源码后才实现的，这部分将来会统一以源码分析专题介绍给大家。</p><h2 id="添加多语言"><a href="#添加多语言" class="headerlink" title="添加多语言"></a>添加多语言</h2><p>目前版本还没官方的全球化/本地化支持，我自己就先实现了一个多语言服务，动态地切换当前使用语言。</p><p>这个多语言服务值得注意的地方：</p><ul><li>无需强制刷新页面，只需导航一下路由就能切换</li><li>用一个事件来触发需要刷新状态的位置，使组件重新渲染不同语言的字符串</li><li>使用 yaml 来配置资源文件</li></ul><p>在这个期间，更深入地学习到了状态刷新的要点。在下次直播中会分享给大家。</p><h2 id="文档构建的改进"><a href="#文档构建的改进" class="headerlink" title="文档构建的改进"></a>文档构建的改进</h2><p>本项目用 Blazor WebAssembly 来构建静态文档站点，为了让源码目录兼顾 .NET 项目与开放性，源文件会放置在项目目录外，在构建时会用到 MSBuild Tasks 来做一些文件拷贝和调用 Node.js 的步骤。Node.js 主要用来调用 gulp 来构建 less 文件和 typescript 文件。但是开发这个项目需要安装 Node.js 还是会让人难受的。所以我一直在寻找可用 C# 替代的方案。</p><p>我最近就在用 .NET Core 写一个 CLI，用来从分散在各个组件目录中的文件生成文档所需的元数据，比如菜单和组件示例页面的文档与源码。这部分在 Ant Design 三大框架的版本中，都是用 Node.js 运行 js 脚本实现的。而我还是想用 .NET 来实现构建过程。目前已经取得不错的进展，已经在 PR #64 进行中了。后期我会再继续寻找用 .NET 构建 less 和 typescript 的方法，集成进这个 CLI 项目中，这样我们在开发时也不需要用到 Node 了。</p><h2 id="CI-的不断改进"><a href="#CI-的不断改进" class="headerlink" title="CI 的不断改进"></a>CI 的不断改进</h2><p>为了做更开放的开源项目，吸引更多开发者加入到项目中，让大家容易入手，并把关注点集中在组件开发上，我在优化开发流程上做了很多努力，特别是在 CI 上花了好多功夫。在维护 AntBlazor 的这段时间，也让我获得了很多 Github Actions 的使用经验和一些 shell 脚本的应用技巧：</p><ul><li><p><strong>ant-design 仓库的样式同步：</strong></p><p>  ant-design 的样式一直在改进，所以对于我们这个从最开始就定位为一个 Ant Design 可持续发展的 Blazor 实现，样式同步并不断改进功能是很有必要的。</p><p>  我于是写了一个定时触发的 shell 脚本，克隆 ant-design 仓库，并把 components 目录下的所有 less 文件复制到 ant-design-blazor 项目，最后把变更以 PR 方式提交到仓库中。</p></li><li><p><strong>PR 预览页面 :</strong></p><p>  我看到 Ant Design 官方的文章中介绍了他们的CI，我也觉得里面的 PR 预览很有意思，于是我也做了一个类似的功能。不同点是，他们用了Azure Pipelines，而我依然只用 Github Actions。</p><p>  在 Github Actions 中，Fork 的仓库没有对原仓库进行写操作的权限，导致 PR 脚本中机器人的 token 不能创建issue 评论来显示浏览页面的链接。于是我就用手动出发的方式，先发一个 <code>/preview</code> 的评论，触发脚本运行预览页面的部署和链接显示。</p><p>  后期考虑写一个 Github Bot，这样就能给他授权写操作权限了。</p></li><li><p><strong>Gitee 同步与 Gitee Pages 刷新</strong></p><p>  如上篇文章提到，由于网络原因，国内用户访问 Github 和 Github Pages 都会有不同程度的困难。于是我在Gitee 创建了一个镜像仓库，并且也开通了 Gitee Pages 的服务。</p><p>  一开始每次推送代码到 Github 之后，我都要去 Gitee 点一下强制同步，再点一下更新 Gitee Pages，好辛苦。 Gitee Pages 的刷新还需要 99 元的 Pro 版本才支持，对于个人开源项目来说，是极为不友好的。于是我各处搜索，终于找到了 Gitee 同步和 Gitee Pages 刷新的 Github Action。虽然 Gitee Pages 刷新是需要获取 Cookie 的（连 SSH 都不能操作），但是总比手动进去点刷新强很多。具体的脚本大家可以到项目中参考，我认为这个对于使用 Github Pages 做博客或者的项目文档的开发者来说，是非常值得运用的。</p></li></ul><h1 id="总结：学习-反哺是一个良性循环"><a href="#总结：学习-反哺是一个良性循环" class="headerlink" title="总结：学习-反哺是一个良性循环"></a>总结：学习-反哺是一个良性循环</h1><p>可以看出，Blazor 让开源的 .NET 点亮了前端技能，从此用 .NET 就能做更多前端的事情了。</p><p>以上的这些实践，都让我们学习到了更多，有的甚至是不只作用于 Blazor 的更通用的技能；而每一项有意义的改进，又都可以成为丰富 Blazor 生态的重要元素。</p><p>其实不是只在 AntBlazor 项目中，在其他需要我们学习的技能上，创造性的实践通常都会让我们得到更多的进步。</p><p>欢迎关注 Blazor，欢迎参与 AntBlazor 和加入 Blazor 中文社区。</p><p>Github: <a href="https://github.com/ElderJames/ant-design-blazor" target="_blank" rel="noopener">https://github.com/ElderJames/ant-design-blazor</a><br>文档/Demo: <a href="https://ant-design-blazor.gitee.io" target="_blank" rel="noopener">https://ant-design-blazor.gitee.io</a><br>Blazor文档：<a href="https://docs.microsoft.com/zh-cn/aspnet/core/blazor" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/aspnet/core/blazor</a></p><hr><p><em>本项目以 MIT 协议开源，为了能得到够更好的且可持续的发展，我们期望获得更多的支持者，我们将把所得款项用于社区活动和推广。你可以通过文章的 <strong>【赞赏】</strong> 和 <strong>README</strong> 中的捐赠方式支持我们。我们会把详细的捐赠记录登记在捐赠者名单中。</em></p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
          <category> Blazor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Blazor </tag>
            
            <tag> AntDesignBlazor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何用 Blazor 实现 Ant Design 组件库？</title>
      <link href="/how-to-implement-ant-design-components-using-blazor.html"/>
      <url>/how-to-implement-ant-design-components-using-blazor.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文主要分享我创建 Ant Design of Blazor 项目的心路历程，已经文末有一个 Blazor 线上分享预告。</p><h1 id="Blazor-WebAssembly-来了！"><a href="#Blazor-WebAssembly-来了！" class="headerlink" title="Blazor WebAssembly 来了！"></a>Blazor WebAssembly 来了！</h1><p>Blazor 这个新推出的前端 Web 框架，想必是去年 .NET Core 3.0 发布时才进入 .NET 开发者的视线的。但其实，那时发布的是服务端托管版，而真正具有跨时代意义的，是即将在今年5月发布的 WebAssembly 托管版。</p><p>我早在两年前，2017年底，就已经在 Steve Sanderson 的<a href="https://blog.stevensanderson.com/2017/11/05/blazor-on-mono/" target="_blank" rel="noopener">一篇博客</a>中看到这个能完全运行在浏览器的前端框架。那时我还是个只会 vue 和一点 Angular 的年轻人，看到只用 C# 就能写一样的单页应用，哪能经得住这种激动。那时就很期待能快点正式发布。后来真的被纳入 AspNetCore 项目的一部分，不断发展完善。没想到最后会是服务端托管版本先发布，而一直发展了接近3年的 WebAssembly 版本，也终于将在今年5月正式发布！</p><p>发展至今，Blazor 已经从通过 SignalR 实现双向绑定的服务端托管模式、到通过 WebAssembly 在浏览器上运行 .NET 运行时，再到现在还实现了 PWA、移动端原生控件绑定等技术，Blazor 在未正式发布时就已经有如此多的功能，可见 ASP.NET 团队和整个社区在 Blazor 上付出了有多大的精力、诚意与期待。ASP.NET 团队还有一系列的开发计划，今年底预计还会发布基于原生UI渲染系统的预览版本。</p><p>也就是说，Blazor 目前还是前端 Web 框架，但是等到了明年，就会成为一个跨设备平台的客户端框架了！</p><h1 id="Blazor-现状"><a href="#Blazor-现状" class="headerlink" title="Blazor 现状"></a>Blazor 现状</h1><p>那么，现在我们就能马上用起来了吗？</p><p>能，也不能，这取决于你想怎么用。如果像官方给出的开发模板那样，使用 Bootstrap 作为样式库，而自己实现所有交互效果的话，完全可以用起来了。但是，如果希望有更具交互性更美观的组件库，能拿来就用，快速实现 UI 需求的话，能选择的组件库还不多，在 Awesome Blazor 列表中，完成度较高的开源的组件库，最好的就有 Material Design 的实现 MatBlazor，其他的基于Bootstrap 的，大多是靠JS实现交互，Blaozr只是渲染最基本的一个Html标签。再者还有收费的 Telerik UI、Radzen.Blazor 等等……国内还有好几个原来做 WPF、MVC组件的厂商也开始了Blazor组件的贩卖……</p><p>这种形势，就等于是手上只有一个 angluar-cli，是能创建空白的组件，但离搭建出高水准的UI组件就还差十万八千里了。那么，该让谁来填补组件库的空白呢？我们参考一下已有的前端框架吧。</p><h1 id="为什么想做-Blazor-组件库"><a href="#为什么想做-Blazor-组件库" class="headerlink" title="为什么想做 Blazor 组件库"></a>为什么想做 Blazor 组件库</h1><p>目前我们用在项目中的前端框架组件库，能数出名的 Ant Design、ElementUI、iView、Vuetify 莫不是依靠开源社区的力量打造出来的。所以，Blazor 的组件库也需要靠开源社区贡献！</p><p>那我们怎么做 Blazor 的组件库呢？</p><p>现代的前端组件库大体上可以分两个部分，一是设计语言与理论，二是具体框架实现。设计语言与理论更多地是 UI/UX 方面的设计。对我来说，最喜欢的设计以此是微软的 Fluent Design、谷歌的 Material Design、再到蚂蚁的 Ant Design。而具体框架实现就是由 React、Angular、Vue 等框架的实现了。</p><p>经过几年来的实践，还有对开源社区的观察，分别用过 Bootstrap、iView、Material、PrimeNG 等组件库之后，最终还是觉得 Ant Design 在 UI 设计、组件功能和实用性、项目工程、社区活跃度等方面总体上都做得很好。作为一个开源项目， 2019 年 7 月，Ant Design的 Github star 数超过 Material UI，成为全球 star 数最高的 React 组件库项目。</p><p>还翻到篇文章，蚂蚁UED接受采访时说：</p><blockquote><p>选择 Design 这个域名，是期待我们能将设计价值观、原则和模式逐步传承下去，因为前端框架、设计风格都会过时，antd （Ant Design of React：用 React 前端框架实现的 Ant Design）一定会被淘汰。但如果我们有 Ant Design ，下个潮流来的时候，我们能快速搭建新的 Ant Design of XXX。非常感动的是，除了 antd，我们已经有 10+ 不同前端框架实现的 Ant Design。 我们的 Design 梦得到了真正的延续。<p align="right"> —— 蚂蚁UED</p></p></blockquote><p>于是一语成谶，WebAssembly 这一潮流来了，Ant Design of Blazor 应运而生。</p><h1 id="我是如何做-Ant-Design-of-Blazor"><a href="#我是如何做-Ant-Design-of-Blazor" class="headerlink" title="我是如何做 Ant Design of Blazor"></a>我是如何做 Ant Design of Blazor</h1><h2 id="与-Ant-Design-官方一致"><a href="#与-Ant-Design-官方一致" class="headerlink" title="与 Ant Design 官方一致"></a>与 Ant Design 官方一致</h2><p>Ant Design of Blazor （以下简称 AntBlazor）从一开始我就定位在与官方 React 实现的代码仓库同规模的项目，并参考它的其他实现，如 NG-ZORRO、ant-design-vue 是如何做另一个框架的实现的。</p><ul><li>参考 ant-design-vue 的命名，我把 Blazor 仓库名改为 ant-design-blazor。</li><li>参考 NG-ZORRO 的 logo 改编，我把 Blazor 官网的 logo 抠下来，也把 Ant Design 的 logo 挖空并旋转 -45°，把 Blazor logo 填上并修改颜色。</li><li>参考 NG-ZORRO 的样式同步机器人，我也自己写了样式同步的 Github Action，定时检查 ant-design 是否有新版本发布，当有新版本时自动提交PR。</li><li>参考 ant-design 写了 README 和 demo 文档。</li><li>参考 NG-ZORRO，使用 Angular 的 commit lints。</li><li>为了项目工程质量，使用 TS 编写互操作脚本，编译脚本都是开源的，对外部贡献者尽量友好，而不是像已有的几个 Blazor 组件库那样只给出混淆后的 js、css。</li><li>还有一些在文档构建时衍生出的副产品，如约定式路由、组件渲染服务等。</li></ul><p>在为了与官方高度一致上的努力，还会继续。希望有一天能在丰富 Blazor 生态的同时，还能成为被 Ant Design 生态认可的框架实现，能成为他们 Design 梦的一个延续。</p><h2 id="发起-Blazor-中文社区"><a href="#发起-Blazor-中文社区" class="headerlink" title="发起 Blazor 中文社区"></a>发起 Blazor 中文社区</h2><p>对与社区来说，Blazor 还是新鲜事物，就算发布半年了，真正有在项目中运用的还是极少数。因此我建了个微信群，希望对 Blazor 真有兴趣的朋友加入，为了发广告的就免了。想加入，可找张队帮忙邀请，他加的人多😂。</p><p>当然，社区运营不是拉个群就完成的，还需要定期地举办线上线下的分享，还有邀请不同领域的大佬一起交流。目前来自前端圈的于航老师和敖天羽大大也被邀请进来了。</p><h2 id="制定开发路线"><a href="#制定开发路线" class="headerlink" title="制定开发路线"></a>制定开发路线</h2><p>在今年年中，我们打算能发布第一个版本 0.1.0，其中完成以下开发项：</p><ul><li>基本实现 Ant Design 组件</li><li>组件的独立发布脚本</li><li>完整文档的构建脚本</li></ul><p>如果进展顺利，在年末 .NET 5 发布时，我们能发布生产可用的 1.0 版。</p><h2 id="寻找贡献者"><a href="#寻找贡献者" class="headerlink" title="寻找贡献者"></a>寻找贡献者</h2><p>要实现这些目标，光靠我一个人是不行的，我需要在社区中寻找到其他开发者一起贡献这个项目。在社区中，目前已经为 AntBlazor 项目邀请到几个开发者参与了代码贡献，并希望有更多对 Ant Design 和 Blazor 有兴趣的开源爱好者加入。特别是希望能有企业用户在有需求的情况下慷慨贡献。</p><p>我们欢迎感兴趣的前端开发者加入，Blazor 是一个完完全全的前端框架，我们在做的也是前端组件库，是十分需要与感激有前端开发者加入到我们，推动 Blazor 在前端的发展。</p><p>我能做的是完善开发流程和引入一些好用的工具，尽量让社区贡献更方便。</p><h2 id="开展技术分享"><a href="#开展技术分享" class="headerlink" title="开展技术分享"></a>开展技术分享</h2><p>考虑到很多朋友还不太了解 Blazor，因此我会在社区中不定期举办分享和培训。会找 Microsoft Reactor 的老师帮忙安排场地，也会在线上举办直播会议，给大家分享一下 Blazor 与参与开源项目的知识，让他们能更好地入手给 AntBlazor 提交代码。</p><p>在本周日（即3月21日）下午，我将在钉钉发起直播会议，讲解 Blazor 的官方文档以及 ant-design-blazor 的项目结构以及示范写 Ant Design 组件。钉钉群入口就是ant-design-blazor 项目README最下面的二维码，大家扫码之前记得点个 Star！</p><p>项目地址: <a href="https://github.com/ElderJames/ant-design-blazor" target="_blank" rel="noopener">https://github.com/ElderJames/ant-design-blazor</a></p><hr><p>参考：</p><ul><li><a href="https://www.zcool.com.cn/article/ZOTU0NjA0.html" target="_blank" rel="noopener">专访蚂蚁金服体验技术UED：Ant Design希望成为世界级设计体系</a></li><li><a href="https://zhuanlan.zhihu.com/p/110863773" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/110863773</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
          <category> Blazor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Blazor </tag>
            
            <tag> AntDesignBlazor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【译】探索更轻量的Electron替代品来托管Blazor桌面应用程序</title>
      <link href="/exploring-lighter-alternatives-to-electron-for-hosting-a-blazor-desktop-app.html"/>
      <url>/exploring-lighter-alternatives-to-electron-for-hosting-a-blazor-desktop-app.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><em>本文翻译自 ASP.NET 项目组的 Steve Sanderson 的博客，发表于 2019 年 11 月 1 日。Steve Sanderson 是 Blazor 最早的创造者。这篇文章发布后还有一篇后续，是介绍一个在本文提到的跨平台 webview 概念的落地项目 WebWindow ，我也会接着翻译过来。</em></p><hr><p>我们能否以更少的资源消耗，获得 Electron 的利用 web 技术构建的桌面应用程序的优势?</p><p>Electron 在 2014 首次开源，作为一种使用 Web 技术（HTML+CSS+JS）构建桌面应用程序的方式，它迅速流行起来。其设计的核心思想是将可预测的环境捆绑在一起:</p><ul><li><strong>它捆绑了自己的 Chromium 副本</strong>， 因此，你可以确定你的 HTML/CSS 将如何被渲染，不必担心 IE 浏览器（等） 随机的旧版本。</li><li><strong>它捆绑了自己的 Node.js 副本</strong>， 因此，你拥有已知的一个可移植编程平台的版本，它超越了浏览器沙箱，可以直接与本机系统交互。</li></ul><p>这些选择在五年前很有价值，但到了 2019 年底，你可能会做出不同的选择。这些选择也是为什么 Electron 对资源极度渴求却也会闻名的关键。默认的空白 Electron 8.0.0 应用程序需要下载 164MB（压缩后 66MB），并作为 4 个单独的进程运行，总共消耗 150MB。</p><p>这些数字在您看来完全可以满足您的场景。如果是这样，那太好了！这篇文章并不是要抨击 Electron，它是一个运行良好的项目，人们显然已经成功地使用了它。在这篇文章中，我只是想思考一下我们还有什么其他的选择。</p><h1 id="它能有多轻"><a href="#它能有多轻" class="headerlink" title="它能有多轻?"></a>它能有多轻?</h1><p>假如…</p><ul><li><strong>…我们没有绑定 Chromium</strong>， 而是使用了操作系统中已经存在的 webview？到了 2019 年，几乎所有的桌面操作系统都将拥有一个足够现代的、通常基于 Chromium 的浏览器可以拿来即用。对于你的应用程序来说，它是上周的 Chromium 还是去年的都不重要。</li><li><strong>… 我们没有绑定 Node</strong>， 而是使用了操作系统中已经存在的编程环境，或者选择引入一个不同的？一个框架相关的 .NET Core 应用程序的大小可以很容易地在 1MB 以下，而一个独立的 .NET Core 应用程序（即绑定了自己的 .NET Core 副本）经链接和压缩后可以减少到约 20MB。</li></ul><p>各种 Electron 的轻量替代项目已经如雨后春笋般涌现出来[1]。当然，也包括 PWA，但这不是这篇文章的目的，因为 PWA 不能进行对底层操作系统的本机访问。</p><h1 id="Electron-上的-Blazor"><a href="#Electron-上的-Blazor" class="headerlink" title="Electron 上的 Blazor"></a>Electron 上的 Blazor</h1><p>我们对使用 Blazor 构建跨平台的桌面应用程序很感兴趣。这并不奇怪：将 C#/.NET 的性能和生产率，与熟悉的 HTML/CSS UI 渲染结合在一起是强大的和有吸引力的。</p><p>因此，我们发布了<a href="https://github.com/aspnet/AspLabs/tree/master/src/ComponentsElectron" target="_blank" rel="noopener">一个示例和一个实验性的包来托管 Electron 上的 Blazor</a>。这里的关键创新之处在于它不是运行在 WebAssembly 上，而是使用普通的跨平台的 .NET Core 运行时来实现完全的原生 .NETb 性能，并在不受任何浏览器沙箱限制的情况下完全访问本机操作系统。</p><p>你今天可以试试。但要注意，这只是一个“asplabs”项目，因为我们还没有作出任何承诺，以推出和支持这项技术。</p><h1 id="纯-webview-上的-Blazor"><a href="#纯-webview-上的-Blazor" class="headerlink" title="纯 webview 上的 Blazor"></a>纯 webview 上的 Blazor</h1><p>不难想象，一个 Blazor 混合桌面应用程序将如何进一步大幅减小体积。我们可以用一个纯粹的系统原生的 web view 替换掉 Electron，因为在 2019 年，在你的目标机器上总会有一个足够好的来用的。另外，我们并不需要 Node 作为跨平台的编程环境，因为 .NET Core 已经为我们扮演了这样的角色。</p><p>为了验证这一点，我构建了 <a href="https://github.com/steveSandersonMS/BlazorDesktop" target="_blank" rel="noopener">一项名为 BlazorDesktop 的实验</a>。这与 <a href="https://github.com/aspnet/AspLabs/tree/master/src/ComponentsElectron" target="_blank" rel="noopener">BlazorElectron</a> 非常相似，实际上大部分代码都是复制粘贴过来的。同样，它运行在原生的 .NET Core 上（所以不是在 WebAssembly 上），但是现在它运行在一个更小的渲染堆栈上，没有任何的 Chromium 或 Node.js 绑定。</p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2019/11/01/blazor-desktop.png" alt=""></p><p>这是一个功能齐全的 Blazor 应用程序，你可以在其中添加任何基于 .NET Core 的原生功能，并作为一个非常轻量级的桌面应用程序运行——具体数字见下文。与 PWA 不同，它不局限于浏览器沙箱。</p><p>如果您有兴趣尝试一下，请注意这只是一个概念验证，目前仅适用于 Windows。将其扩展为跨平台并不难（我将使用诸如 webview 之类的东西来添加 Mac+Linux 支持），但是我现在还没有在积极地做这件事。如果您感兴趣，请提交一份 PR。</p><h1 id="统计数据"><a href="#统计数据" class="headerlink" title="统计数据"></a>统计数据</h1><p>毫不奇怪，这个最小的 Blazor + webview 应用程序比构建在整个 Chromium + Node 技术栈上的应用程序要小得多，也不需要太多内存:</p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2019/11/01/download-size-chart.png" alt=""></p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2019/11/01/memory-use-chart.png" alt=""></p><p>.NET Core 的好处之一是，通过一个简单的开关，您可以控制生成的输出是否绑定了它自己的 .NET Core 运行时副本（也称为独立的），或者它是否假设运行时已经安装在目标 OS 上（也称为依赖于框架）。在上面的第一个图中可以看到这一点，您可以看到它对输出大小有很大的影响，因为 Blazor 库本身非常紧凑。</p><p>在企业环境中，如果您知道已经安装了某些软件，那么可以安全地分发与框架相关的小于 1MB 的应用程序，其中相同的二进制文件可以在任何受支持的操作系统上运行。但是对于公共发行版，您很可能会发布一个独立的应用程序——为每个 Windows、Mac 和 Linux 用户分别生成不同的二进制文件。</p><p>请注意，上述压缩的 Blazor webview 应用程序大约有 200KB 的大小，其中还包含了 Bootstrap 样式，因此如果您正在使用其他的则可以删除它。</p><h1 id="需要做什么才能使其可行"><a href="#需要做什么才能使其可行" class="headerlink" title="需要做什么才能使其可行"></a>需要做什么才能使其可行</h1><p>正如我所说的，Blazor Desktop 目前只是一个快速的概念验证，完全是在我从 <a href="https://ndcsydney.com/" target="_blank" rel="noopener">NDC Sydney</a> 返回的旅途中开发的。要成为可行的产品还有很长的路要走。</p><p>它需要：</p><ul><li><strong>跨平台支持</strong>， 例如使用 webview</li><li><strong>Edge (Chromium) 支持</strong>，因此，在 Windows 10 上，我们使用的是操作系统自己的基于 Chromium 的浏览器，而不是我的原型中使用的基于 Edge 的 webview。</li><li><strong>处理找不到合适的 webview 的情况</strong>。在极少数情况下，用户的操作系统没有提供可接受的 webview 技术，我们可以提示用户并下载一个独立的 Chromium 发行版（可能通过 CEF）。</li><li><strong>桌面 API</strong> ——一个重大的需求，需要付出高成本地从零开始实现。Electron 不只是使用 Node 作为通用的编程环境;它还提供了一组跨平台的 api，用于与桌面操作系统进行交互，执行诸如复制到剪贴板、更改任务栏或 dock 图标、显示本机下拉菜单、显示本机提示或对话框等任务。.NET Core 本身提供了大量应用程序需要的 API，但是目前它并没有解决很多桌面应用的问题，因为现在还没有任何标准的基于.NET Core 的跨平台 UI 技术。但是任何实际的应用程序都需要这些功能。可以想象，仅仅为了获得这些 API 的跨平台实现而绑定 Node 也是值得的（但仍然不绑定 Chromium）。</li><li><strong>自动发布和下载更新</strong></li></ul><h1 id="反馈要求"><a href="#反馈要求" class="headerlink" title="反馈要求"></a>反馈要求</h1><p>我写这篇文章的原因主要是为了更多地了解开发人员社区对这些技术的感受。你有使用 .NET+HTML+CSS 构建混合桌面应用程序的场景吗？你会乐意将 Blazor 与 Electron 一起使用，还是认为有必要更轻量？</p><h1 id="注脚：现有的-Electron-替代品"><a href="#注脚：现有的-Electron-替代品" class="headerlink" title="注脚：现有的 Electron 替代品"></a>注脚：现有的 Electron 替代品</h1><p>多年来，许多人都在考虑制造更轻的 Electron 替代品。现在有各种各样的开源项目，尽管还不清楚是否有关键的真正去大规模采用的动力。其中一些，如 <a href="https://github.com/chromelyapps/Chromely" target="_blank" rel="noopener">Chromely</a>，移除了 Node，只捆绑了 Chromium。其他的，如 <a href="https://github.com/neutralinojs/neutralinojs" target="_blank" rel="noopener">Neutralino</a>，则消除了 Chromium，只将基于 Node 的编程模型与本机操作系统的浏览器技术捆绑在一起。在最基本的方面，<a href="https://github.com/zserge/webview" target="_blank" rel="noopener">webview</a> 只是对 webview 概念的一个抽象：它以构建在主机操作系统中的任何浏览器技术来显示 HTML/CSS，并且不提供任何自己的跨平台编程模型。</p><hr><p>本文翻译自：<a href="https://blog.stevensanderson.com/2019/11/01/exploring-lighter-alternatives-to-electron-for-hosting-a-blazor-desktop-app/" target="_blank" rel="noopener">https://blog.stevensanderson.com/2019/11/01/exploring-lighter-alternatives-to-electron-for-hosting-a-blazor-desktop-app/</a></p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> Blazor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【译】来看看WebWindow，一个跨平台的.NET Core webview 库</title>
      <link href="/webwindow-a-cross-platform-webview-for-dotnet-core.html"/>
      <url>/webwindow-a-cross-platform-webview-for-dotnet-core.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><em>本文翻译自 ASP.NET 项目组的 Steve Sanderson 的博客，发表于 2019年11月18日。Steve Sanderson 是 Blazor 最早的创造者。</em></p><hr><p>它类似于 Electron，但没有捆绑 Node.js 和 Chromium，也没有大部分 API。</p><p>我的上一篇文章研究了如何用 web 渲染的 UI 构建一个 .NET Core 桌面或控制台应用程序，而不需要引入全部的 Electron 部件。这似乎引起了很多人的兴趣，所以我决定将其升级到新的技术并添加跨平台支持。</p><p>最终成果是一个名为 <a href="https://www.nuget.org/packages/WebWindow" target="_blank" rel="noopener">WebWindow</a> 的小 NuGet 包，你可以将它添加到任何 .NET Core 控制台应用程序中。它可以打开一个包含基于 web 的 UI 的本机操作系统窗口（Windows/Mac/Linux），而无需您的应用程序绑定 Node 或 Chromium。</p><p>我还把它和 Blazor 解耦了。您现在可以在窗口内托管任何类型的 web UI。repo 中包含一个使用Vue 的示例，还有一个使用了 Blazor。</p><blockquote><p><strong><em>注意：</em></strong> <em>这个库是超前 alpha 质量的。如果你想用它来构建一些真实的东西，请看这篇文章末尾的注释。到目前为止，这只是另一个原型。</em></p></blockquote><h1 id="“Hello-World”-示例"><a href="#“Hello-World”-示例" class="headerlink" title="“Hello World” 示例"></a>“Hello World” 示例</h1><p>创建一个新的 .NET Core 3 C# 控制台应用程序，然后添加一个引用到 <code>WebWindow</code> NuGet包:</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>WebWindow<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0.1.0-20191120.3<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>接下来，将代码添加到 <code>Program</code>  类中的 <code>Main</code> 方法。</p><pre class="line-numbers language-cs"><code class="language-cs">static void Main(string[] args){    var window = new WebWindow("My super app");    window.NavigateToString("<h1>Hello, world!</h1> This window is from a .NET Core app.");    window.WaitForExit();}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样就完成了！现在根据你运行的操作系统，你的应用程序会显示如下窗口：</p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2019/11/18/hello-windows.png" alt=""></p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2019/11/18/hello-macos.png" alt=""></p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2019/11/18/hello-ubuntu.png" alt=""></p><p>这个示例使用 <code>NavigateToString(html)</code> 从硬编码的 .NET 字符串渲染 HTML。你也可以：</p><ul><li>使用 <code>NavigateToUrl(url)</code> 来显示来自HTTP服务器的内容(本地或远程)</li><li>使用 <code>NavigateToLocalFile(path)</code> 来显示来自本地磁盘的 HTML 文件，其中 <code>path</code> 是绝对路径或相对于当前工作目录的路径。<a href="https://github.com/SteveSandersonMS/WebWindow/blob/a01537a9328b085075866a965191d6323ad2cf7d/samples/HelloWorldApp/Program.cs#L11" target="_blank" rel="noopener">示例在这里</a></li></ul><p>作为一个稍微高级一些的选项，您可以配置 <code>WebWindow</code> 来处理自定义协议，如 <code>myapp://</code>，并指定一个委托（回调），它可以为该协议中的每个 URL 返回任意内容。示例在<a href="https://github.com/SteveSandersonMS/WebWindow/blob/a01537a9328b085075866a965191d6323ad2cf7d/testassets/HelloWorldApp/Program.cs#L14" target="_blank" rel="noopener">这里</a>和<a href="https://github.com/SteveSandersonMS/WebWindow/blob/a01537a9328b085075866a965191d6323ad2cf7d/testassets/HelloWorldApp/wwwroot/index.html#L11" target="_blank" rel="noopener">这里</a>。</p><p>一旦您的 web 内容正在运行，JavaScript 和 .NET 之间的底层通信方式就是在 JS 中使用 <code>window.external.sendMessage/receiveMessage</code> API（<a href="https://github.com/SteveSandersonMS/WebWindow/blob/a01537a9328b085075866a965191d6323ad2cf7d/testassets/HelloWorldApp/wwwroot/index.html#L14-L20" target="_blank" rel="noopener">示例</a>）和在.NET中使用 <code>webWindowInstance.SendMessage</code> 和 <code>webWindowInstance.OnWebMessageReceived</code> API -（<a href="https://github.com/SteveSandersonMS/WebWindow/blob/a01537a9328b085075866a965191d6323ad2cf7d/testassets/HelloWorldApp/Program.cs#L21-L24" target="_blank" rel="noopener">示例</a>）。但是，如果您正在构建一个 Blazor 应用程序，则不需要使用这些底层 API，而可以使用 Blazor 常规的 JS 互操作特性。</p><h1 id="托管一个-Blazor-应用程序"><a href="#托管一个-Blazor-应用程序" class="headerlink" title="托管一个 Blazor 应用程序"></a>托管一个 Blazor 应用程序</h1><p>WebWindow 并没有与 Blazor 耦合。这里是一个<a href="https://github.com/SteveSandersonMS/WebWindow/tree/master/samples/VueFileExplorer" target="_blank" rel="noopener">使用 Vue.js 在 WebWindow 内呈现一个简单的目录资源管理器应用程序的例子</a>。</p><p>但如果你真的想用 Blazor，那是非常整洁和简单的。我还做了一个小插件包，<a href="https://www.nuget.org/packages/WebWindow.Blazor" target="_blank" rel="noopener">WebWindow.Blazor</a>，它可以让你在你的 <code>Program.Main</code> 中只用一行代码就能运行一个 Blazor 应用程序。</p><pre><code>static void Main(string[] args){    ComponentsDesktop.Run&lt;Startup&gt;(&quot;My Blazor App&quot;, &quot;wwwroot/index.html&quot;);}</code></pre><p>概括地说，这 <em>并不</em> 涉及 WebAssembly、Node.js 或者是一份私有绑定的 Chromium。它只是在本地运行 .NET Core，直接与操作系统自己的 web 渲染技术进行通信。这一次在 macOS 上的运行结果是:</p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2019/11/18/blazor-macos.jpg" alt=""></p><p>完整的 <a href="https://github.com/SteveSandersonMS/WebWindow/tree/master/samples/BlazorDesktopApp" target="_blank" rel="noopener">WebWindow+Blazor 示例在这里</a>。</p><h1 id="他是如何工作的"><a href="#他是如何工作的" class="headerlink" title="他是如何工作的"></a>他是如何工作的</h1><ul><li>在 <strong>Windows</strong> 上，WebWindow <a href="https://docs.microsoft.com/en-us/microsoft-edge/hosting/webview2" target="_blank" rel="noopener">通过 <code>webview2</code> 使用新的基于 Chromium 的 Edge</a>，假设你已经安装了那个浏览器（如果你不安装，它可能会退回到旧的Edge，但我还没有实现）</li><li>在 <strong>Mac</strong> 上，它使用了操作系统内置的<a href="https://developer.apple.com/documentation/webkit/wkwebview" target="_blank" rel="noopener">WKWebView</a>，这与 Safari 背后的技术相同</li><li>在 <strong>Linux</strong> 上，它使用了 <a href="https://webkitgtk.org/" target="_blank" rel="noopener">WebKitGTK+2</a>，这也是一种基于 WebKit 的技术</li></ul><p>这一切的关键在于，与使用 Electron 相比，开发出下载体积更小和内存使用更少的应用程序。但事实果真如此吗？以下是下载大小的统计数据：</p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2019/11/18/download-size-chart.png" alt=""></p><p>正如您所看到的，无论您选择“独立”（捆绑了.NET Core 运行时的一个副本）还是“依赖于框架”（依赖于已安装在目标系统中的 .NET Core），都会对最终的应用程序大小产生巨大的影响。依赖于框架的 WebWindow 应用程序真的可以很小，因为它们只包含您自己的应用程序的二进制文件，并且没有捆绑运行时或浏览器。</p><p>接下来，是内存使用统计:</p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2019/11/18/memory-use-chart.png" alt=""></p><p>在 Windows 上，WebWindow 和 Electron 使用的是相同的浏览器技术（Chromium），这种技术占用了大部分内存。这就解释了为什么他们之间的差异并不是很大。在 Linux 和 Mac 上，使用自绑定浏览器（指 Electron）与使用操作系统内置技术之间的区别更为明显。</p><h1 id="这个项目会得到支持和维护吗？"><a href="#这个项目会得到支持和维护吗？" class="headerlink" title="这个项目会得到支持和维护吗？"></a>这个项目会得到支持和维护吗？</h1><p>目前我还没有做出任何承诺！现在最好把它看作是另一个实验。如果有足够多的人想参与进来，就有可能创建一个合适的开源社区项目。</p><p>最迫切需要的是有 C++ 经验的人来重写我的原型质量的 C++ 和 Objective-C 代码，使其真正完善。我已完成所有内存管理的概率接近于0。也许它也应该使用 CMake 或其他健全的构建配置系统。（注意：它确实有一个<a href="https://dev.azure.com/SteveSandersonMS/WebWindow/_build?definitionId=2" target="_blank" rel="noopener">基于 Azure DevOps 的跨平台 CI</a>。）</p><p>如果您打算在生产中使用它，那么您还需要添加大量的特性。例如，设置应用程序图标、添加本地菜单栏等功能。如果您有兴趣贡献这样的功能，并将使其跨平台工作，请<a href="https://github.com/SteveSandersonMS/WebWindow" target="_blank" rel="noopener">来这个 repo</a>！</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> Blazor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通过 Serverless 加速 Blazor WebAssembly</title>
      <link href="/run-blazor-webassembly-on-serverless.html"/>
      <url>/run-blazor-webassembly-on-serverless.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Blazor-❤-Serverless"><a href="#Blazor-❤-Serverless" class="headerlink" title="Blazor ❤ Serverless"></a>Blazor ❤ Serverless</h1><p>我正在开发 Ant Design 的 Blazor 版本，预览页面部署在 Github Pages 上，但是加载速度很不理想，往往需要 1 分钟多钟才完成。</p><p>项目地址：<a href="https://github.com/ElderJames/ant-design-blazor" target="_blank" rel="noopener">https://github.com/ElderJames/ant-design-blazor</a> 求 Star。</p><p>当寻求解决方案时，了解到了 Serverless 可以轻松地部署静态网站到腾讯云的对象存储服务上，经过尝试之后，体验非常好！访问速度就变成了 3 秒钟，心想 Blazor 与 Serverless 结合后，是一定能成功的。</p><h2 id="Blazor-WebAssembly-简介"><a href="#Blazor-WebAssembly-简介" class="headerlink" title="Blazor WebAssembly 简介"></a>Blazor WebAssembly 简介</h2><p>Blazor 是 .NET 实现的前端框架，它使一套代码可分别支持服务端 WebSocket 双向绑定或者是运行在 WebAssembly上。Blazor WebAssembly 可以让开发者使用跟熟悉的 Razor 模版同样的开发模型，来开发基于 WebAssembly 的 SPA 应用。目前 Blazor WebAssembly 已经是在 WebAssembly 领域中发展得最完善的 Web 框架。</p><h2 id="Serverless-简介"><a href="#Serverless-简介" class="headerlink" title="Serverless 简介"></a>Serverless 简介</h2><p>Serverless 是开发者和企业用户共同推动的,它可以使开发者在构建和运行应用时无需管理服务器等基础设施，将构建应用的成本进一步降低，函数是部署和运行的基本单位。</p><p>开发者无需关心底层资源即可部署完整可用的 Serverless 应用架构。</p><h1 id="创建-Blazor-WebAssembly-应用程序"><a href="#创建-Blazor-WebAssembly-应用程序" class="headerlink" title="创建 Blazor WebAssembly 应用程序"></a>创建 Blazor WebAssembly 应用程序</h1><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><p>安装.NET Core SDK 3.1.2 以上版本 <a href="https://dotnet.microsoft.com/download/dotnet-core" target="_blank" rel="noopener">下载地址</a></p><h2 id="安装模版"><a href="#安装模版" class="headerlink" title="安装模版"></a>安装模版</h2><p>Blazor WebAssembly 目前还在 preview 阶段，所以正式发布的.NET Core SDK 还没有内置模版，但是我们可以手动安装模版。</p><p>运行命令</p><pre><code>dotnet new -i Microsoft.AspNetCore.Blazor.Templates::3.2.0-preview1.20073.1</code></pre><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>运行命令</p><pre><code>dotnet new blazorwasm -o BlazorServerless</code></pre><p>可以看到在 BlazorServerless 已经创建好了 Web WebAssembly 应用。我们进入目录，运行 <code>dotnet run</code> ，访问 <code>https://localhost:5001</code> 就能浏览了。</p><pre><code>cd BlazorServerlessdotnet run</code></pre><p><img src="/images/blazor_serverless/blazor.png" alt=""></p><p>可以看到，加载时要加载 2.1MB 的文件，首次加载时对网速的压力还是很大的。如果部署在境外，例如 Github Pages，可能就需要等上好几分钟了。</p><p>所幸，我们可以用 Serverless 把它部署到国内服务器上，解决了加载问题。</p><h2 id="发布项目"><a href="#发布项目" class="headerlink" title="发布项目"></a>发布项目</h2><p>现在，我们需要发布这个项目，生成需要部署的文件。</p><pre><code>dotnet publish -o publish</code></pre><p>这样，<code>publish\BlazorServerless\dist</code> 目录里的文件就是我们需要部署的文件了！</p><p><img src="/images/blazor_serverless/publish.png" alt=""></p><h1 id="部署到腾讯云-Serverless-平台"><a href="#部署到腾讯云-Serverless-平台" class="headerlink" title="部署到腾讯云 Serverless 平台"></a>部署到腾讯云 Serverless 平台</h1><h2 id="前置准备-1"><a href="#前置准备-1" class="headerlink" title="前置准备"></a>前置准备</h2><p>首先确保系统包含以下环境：</p><ul><li><a href="https://nodejs.org/dist/v12.16.1/node-v12.16.1-x64.msi" target="_blank" rel="noopener">Node.js</a> (Node.js 版本需不低于 8.6，建议使用最新版本)</li></ul><h2 id="安装-serverless-cli"><a href="#安装-serverless-cli" class="headerlink" title="安装 serverless cli"></a>安装 serverless cli</h2><pre><code>npm install -g serverless</code></pre><p>在 Windows 系统上，如果报错，错误提示是<code>因为在此系统上禁止运行脚本...</code>，那么请执行命令开启 <code>.ps1</code> 脚本</p><pre><code>set-ExecutionPolicy RemoteSigned</code></pre><h2 id="添加配置文件"><a href="#添加配置文件" class="headerlink" title="添加配置文件"></a>添加配置文件</h2><p>现在，需要在上面我们的发布目录 <code>publish\BlazorServerless</code> （跟 <code>dist</code> 目录同级）中，创建 <code>serverless.yml</code> 文件，内容如下：</p><pre class="line-numbers language-yml"><code class="language-yml"># serverless.ymlblazor-wasm:  component: "@serverless/tencent-website"  inputs:    code:      src: ./dist # Upload static files      index: index.html      error: index.html    region: ap-guangzhou    bucketName: blazor-bucket<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意的是，如果我们部署的是依赖路由系统的 SPA 站点，<code>error</code> 项也要指向 <code>index.html</code>，这样在直接访问子路由时，还能回到index页面加载路由。否则会有 404 错误。</p><p>配置完成后，文件目录如下：</p><pre><code>/BlazorServerless  ├── publish/BlazorServerless  |    ├── dist  |    |   ├── _framework  |    |   ├── css  |    |   ├── sample-data  |    |   └── index.html  |    └── serverless.yml  └── README.md</code></pre><p><img src="/images/blazor_serverless/yml.png" alt=""></p><h2 id="三、部署并浏览"><a href="#三、部署并浏览" class="headerlink" title="三、部署并浏览"></a>三、部署并浏览</h2><p>在上图所示，即 <code>serverless.yml</code> 文件所在目录下，通过 <code>serverless</code> 命令进行部署，添加 –debug 参数查看部署详情：</p><pre><code>serverless --debug</code></pre><p>如果这个目录是第一次授权，或者没有创建环境变量文件设置授权信息，则会出现一个二维码，不管有没有注册过腾讯云，都能通过微信扫码授权开通，非常方便。</p><p>以下是输入以上命令后的控制台的输出：</p><pre><code>PS D:\code\net\blazor\BlazorServerless\publish\BlazorServerless&gt; serverless --debug  DEBUG ─ Resolving the template&#39;s static variables.  DEBUG ─ Collecting components from the template.  DEBUG ─ Downloading any NPM components found in the template.  DEBUG ─ Analyzing the template&#39;s components dependencies.  DEBUG ─ Creating the template&#39;s components graph.  DEBUG ─ Syncing template state.  DEBUG ─ Executing the template&#39;s components graph.(此处会出现二维码)Please scan QR code login from wechat. Wait login...Login successful for TencentCloud.   DEBUG ─ Preparing website Tencent COS bucket blazor-bucket-1256169759.  DEBUG ─ Bucket &quot;blazor-bucket-1256169759&quot; in the &quot;ap-guangzhou&quot; region already exist.  DEBUG ─ Setting ACL for &quot;blazor-bucket-1256169759&quot; bucket in the &quot;ap-guangzhou&quot; region.  DEBUG ─ Ensuring no CORS are set for &quot;blazor-bucket-1256169759&quot; bucket in the &quot;ap-guangzhou&quot; region.  DEBUG ─ Ensuring no Tags are set for &quot;blazor-bucket-1256169759&quot; bucket in the &quot;ap-guangzhou&quot; region.  DEBUG ─ Configuring bucket blazor-bucket-1256169759 for website hosting.  DEBUG ─ Uploading website files from D:\code\net\blazor\BlazorServerless\publish\BlazorServerless\dist to bucket blazor-bucket-1256169759.  DEBUG ─ Starting upload to bucket blazor-bucket-1256169759 in region ap-guangzhou  DEBUG ─ Uploading directory D:\code\net\blazor\BlazorServerless\publish\BlazorServerless\dist to bucket blazor-bucket-1256169759  DEBUG ─ Website deployed successfully to URL: http://blazor-bucket-1256169759.cos-website.ap-guangzhou.myqcloud.com.  blazor-wasm:     url: http://blazor-bucket-1256169759.cos-website.ap-guangzhou.myqcloud.com    env:   116s » blazor-wasm » done</code></pre><p>这样，最后出现绿色的 Done 字样，就说明部署成功了！访问给出的url，就能看到部署在腾讯云对象存储服务中的站点了！</p><p><img src="/images/blazor_serverless/deploy.png" alt=""></p><p>访问时加载速度非常快！</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> Blazor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端 JS/TS 调用 ASP.NET Core gRPC-Web</title>
      <link href="/call-asp_net_core-grpc-web-with-js-and-ts.html"/>
      <url>/call-asp_net_core-grpc-web-with-js-and-ts.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在上两篇文章中，介绍了<a href="/asp_net_core-support-grpc-web.html">ASP.NET Core 中的 gRPC-Web 实现</a> 和 <a href="/Using-gRPC-Web-with-Blazor-WebAssembly.html">在 Blazor WebAssembly 中使用 gRPC-Web</a>，实现了 Blazor WebAssembly 调用 ASP.NET Core gRPC-Web。虽然 ASP.NET Core 中的 gRPC-Web 实现目前还是试验性项目，但是鉴于它在生态上的重大意义，说不定我们很快就能在正式版本中使用。</p><p>虽然 Blazor WebAssembly 现在已经是 .NET 进军前端的大热门，但有同学说，只介绍了 Blazor WebAssembly 的调用方法还不够呀，现在比较常用的还是 JS/TS 前端，那么本篇，我就介绍一下在前端 JS/TS 中调用 ASP.NET Core gRPC-Web。</p><p>其实 gRPC-Web 项目本身，就是为 JS/TS 提供 gRPC 能力的，让不支持 HTTP/2 的客户端和服务端也能使用 gRPC 的大部分特性。gRPC-Web 项目提供了一个 protoc CLI 插件，可用于把 proto 协议文件转换为 JS/TS 语言可导入的对应 gRPC 服务的客户端，还生成了 <code>.d.ts</code> 文件来支持 Typescript。</p><h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p>接下来，我就来展示一下，用 Visual Studio 自带的 ASP.NET Core + Angular 模板创建的项目，把原来的 WebApi 调用改造成 gRPC-Web 调用。</p><p>本示例基于 .NET Core 3.1，请安装好最新的 .NET Core SDK 和 Visual Studio 2019。</p><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>打开 Visual Studio 2019，创建新项目 -&gt; 选择”ASP.NET Core Web 应用程序” -&gt; 填写项目名 -&gt; 选择 “Angular” 项目模板。如图：</p><p><img src="/images/aspnetcore-grpc-web/1.png" alt=""></p><p>我们就是用这个项目，把 fetch-data 页面获取数据的方式修改为 gRPC-Web 。</p><h2 id="添加-gRPC-proto-文件"><a href="#添加-gRPC-proto-文件" class="headerlink" title="添加 gRPC proto 文件"></a>添加 gRPC proto 文件</h2><p>在项目中新建一个目录 <code>Protos</code>，创建文件 <code>weather.proto</code> :</p><pre><code>syntax = &quot;proto3&quot;;import &quot;google/protobuf/empty.proto&quot;;import &quot;google/protobuf/timestamp.proto&quot;;option csharp_namespace = &quot;AspNetCoreGrpcWeb&quot;;package WeatherForecast;service WeatherForecasts {  rpc GetWeather (google.protobuf.Empty) returns (WeatherReply);}message WeatherReply {  repeated WeatherForecast forecasts = 1;}message WeatherForecast {  google.protobuf.Timestamp dateTimeStamp = 1;  int32 temperatureC = 2;  int32 TemperatureF = 3;  string summary = 4;}</code></pre><p>可以看到 proto 中导入了官方库的其他 proto 文件，它们是编译用的辅助文件。对于.NET Core 项目，可以通过引用 <code>Google.Protobuf</code> 这个包引入。</p><h2 id="修改-ASP-NET-Core-服务端"><a href="#修改-ASP-NET-Core-服务端" class="headerlink" title="修改 ASP.NET Core 服务端"></a>修改 ASP.NET Core 服务端</h2><p>我们先修改服务端，让 ASP.NET Core 提供 gRPC-Web 服务。</p><p>由于 gRPC-Web 包还没有发布到 NuGet.org，现在你需要添加一个临时的包管理源来获得 nightly 预览。在你的解决方案的根目录下添加<code>NuGet.config</code>文件：</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packageSources</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!--To inherit the global NuGet package sources remove the &lt;clear/> line below --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clear</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>nuget<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://api.nuget.org/v3/index.json<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gRPC-nightly<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://grpc.jfrog.io/grpc/api/nuget/v3/grpc-nuget-dev<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packageSources</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再添加必要的 Nuget 包引用：</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.AspNetCore<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001100801<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.AspNetCore.Web<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001100801<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>接着，修改原来的 <code>WeatherForecastController</code> 改为 <code>WeatherForecastService</code>:</p><pre class="line-numbers language-csharp"><code class="language-csharp">    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastsService</span> <span class="token punctuation">:</span> WeatherForecasts<span class="token punctuation">.</span>WeatherForecastsBase    <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> Summaries <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">"Freezing"</span><span class="token punctuation">,</span> <span class="token string">"Bracing"</span><span class="token punctuation">,</span> <span class="token string">"Chilly"</span><span class="token punctuation">,</span> <span class="token string">"Cool"</span><span class="token punctuation">,</span> <span class="token string">"Mild"</span><span class="token punctuation">,</span> <span class="token string">"Warm"</span><span class="token punctuation">,</span> <span class="token string">"Balmy"</span><span class="token punctuation">,</span> <span class="token string">"Hot"</span><span class="token punctuation">,</span> <span class="token string">"Sweltering"</span><span class="token punctuation">,</span> <span class="token string">"Scorching"</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">override</span> Task<span class="token operator">&lt;</span>WeatherReply<span class="token operator">></span> <span class="token function">GetWeather</span><span class="token punctuation">(</span>Empty request<span class="token punctuation">,</span> ServerCallContext context<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">var</span> reply <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeatherReply</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            reply<span class="token punctuation">.</span>Forecasts<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>index <span class="token operator">=</span><span class="token operator">></span>            <span class="token punctuation">{</span>                <span class="token keyword">var</span> temperatureC <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WeatherForecast</span>                <span class="token punctuation">{</span>                    DateTimeStamp <span class="token operator">=</span> Timestamp<span class="token punctuation">.</span><span class="token function">FromDateTime</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    TemperatureC <span class="token operator">=</span> temperatureC<span class="token punctuation">,</span>                    TemperatureF <span class="token operator">=</span> <span class="token number">32</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>temperatureC <span class="token operator">/</span> <span class="token number">0.5556</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    Summary <span class="token operator">=</span> Summaries<span class="token punctuation">[</span>rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>Summaries<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span>                <span class="token punctuation">}</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在，在你的服务器的 <code>Startup.cs</code> 文件中，修改 <code>ConfigureServices</code> 以添加以下行:</p><pre class="line-numbers language-csharp"><code class="language-csharp">  services<span class="token punctuation">.</span><span class="token function">AddGrpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><em>注意:如果你只打算公开 gRPC 服务，你可能不再需要 MVC 控制器，在这种情况下，你可以从下面删除<code>services.AddMvc()</code> 和 <code>endpoints.MapDefaultControllerRoute()</code>。</em></p><p>只是在 <code>app.AddRouting();</code> 的下面添加以下内容，它会处理将传入的 gRPC-web 请求映射到服务端，使其看起来像 gRPC 请求:</p><pre class="line-numbers language-csharp"><code class="language-csharp">  app<span class="token punctuation">.</span><span class="token function">UseGrpcWeb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最后，在<code>app.UseEndpoints</code>语句块中注册你的 gRPC-Web 服务类，并在该语句块的顶部使用以下代码行:</p><pre class="line-numbers language-csharp"><code class="language-csharp">  endpoints<span class="token punctuation">.</span><span class="token generic-method function">MapGrpcService<span class="token punctuation">&lt;</span>WeatherForecastsService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">EnableGrpcWeb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>就这样，你的 gRPC-Web 服务端已经准备好了!</p><h2 id="修改-Angular-项目"><a href="#修改-Angular-项目" class="headerlink" title="修改 Angular 项目"></a>修改 Angular 项目</h2><p>项目的 <code>ClientApp</code> 目录中，就是 Angular 的项目文件，使用 ASP.NET Core 托管，是这个项目模板约定的。</p><p>我们需要先通过 <code>proto</code> 生成需要的 js 文件。</p><h3 id="安装-npm-包"><a href="#安装-npm-包" class="headerlink" title="安装 npm 包"></a>安装 npm 包</h3><p>运行命令：</p><pre class="line-numbers language-bash"><code class="language-bash"> <span class="token function">npm</span> i protoc google-protobuf ts-protoc-gen @improbable-eng/grpc-web -s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="生成-js-文件"><a href="#生成-js-文件" class="headerlink" title="生成 js 文件"></a>生成 js 文件</h3><p>在 ClientApp 目录下创建目录 <code>proto</code> ，再运行命令：</p><pre class="line-numbers language-bash"><code class="language-bash">./node_modules/protoc/protoc/bin/protoc --plugin<span class="token operator">=</span><span class="token string">"protoc-gen-ts=.\node_modules\.bin\protoc-gen-ts.cmd"</span> --js_out<span class="token operator">=</span><span class="token string">"import_style=commonjs,binary:./../Protos"</span> --ts_out<span class="token operator">=</span><span class="token string">"service=grpc-web:src/app/proto"</span> -I ./<span class="token punctuation">..</span>/Protos <span class="token punctuation">..</span>/Protos/*.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以在<code>proto</code>目录中看到生成了 4 个文件（每个 proto 会生成 4 个）</p><ul><li><code>weather_pb_service.js</code>: 包含了 rpc 调用客户端 <code>WeatherForecastsClient</code>。</li><li><code>weather_pb.js</code>: 包含了传输对象 <code>WeatherForecast</code>。这个文件在原 proto 的目录下，需要手动移过来。</li><li>两个 <code>*.d.ts</code> 文件是对应以上两个文件的类型描述，用于 TS。</li></ul><p><img src="/images/aspnetcore-grpc-web/2.png" alt=""></p><h3 id="修改-fetch-data-页面组件"><a href="#修改-fetch-data-页面组件" class="headerlink" title="修改 fetch-data 页面组件"></a>修改 fetch-data 页面组件</h3><p>接下来，需要引用生成的文件，创建一个 <code>WeatherForecastsClient</code> 来调用 gRPC-Web 服务端。</p><ul><li><p>fetch-data.component.ts</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> WeatherForecast <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../proto/weather_pb'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> WeatherForecastsClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../proto/weather_pb_service'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token punctuation">{</span> Empty <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'google-protobuf/google/protobuf/empty_pb'</span><span class="token punctuation">;</span>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    selector<span class="token punctuation">:</span> <span class="token string">'app-fetch-data'</span><span class="token punctuation">,</span>    templateUrl<span class="token punctuation">:</span> <span class="token string">'./fetch-data.component.html'</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">FetchDataComponent</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> forecasts<span class="token punctuation">:</span> WeatherForecast<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> client<span class="token punctuation">:</span> WeatherForecastsClient<span class="token punctuation">;</span>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeatherForecastsClient</span><span class="token punctuation">(</span><span class="token string">'https://localhost:5001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">getWeather</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> reply<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>forecasts <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">getForecastsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>fetch-data.component.html</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tableLabel<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Weather forecast<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>This component demonstrates fetching data from the server.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>!forecasts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">></span></span>Loading...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>table table-striped<span class="token punctuation">"</span></span> <span class="token attr-name">aria-labelledby</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tableLabel<span class="token punctuation">"</span></span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>forecasts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>thead</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>Date<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>Temp. (C)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>Temp. (F)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">></span></span>Summary<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>thead</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tbody</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let forecast of forecasts<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{ forecast.getDatetimestamp().toDate() }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{ forecast.getTemperaturec() }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{ forecast.getTemperaturef() }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{ forecast.getSummary() }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tbody</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><p>可以看到：</p><ul><li>创建 <code>WeatherForecastsClient</code> 对象需要传入服务端的 HostName，要注意不要用 <code>/</code>后缀。</li><li>生成出来的 <code>WeatherForecast</code> 类型包含<code>getter/setter</code>, 而 <code>WeatherForecast.AsObject</code> 类才是值对象，可以直接访问属性值，需要调用 <code>.toObject()</code> 方法进行转换。</li><li><code>datetimestamp</code> 属性的类型 <code>proto.google.protobuf.Timestamp</code> 是 protobuf 里的关键字，调用 <code>toDate()</code> 方法可转换为 TS 的 <code>Date</code> 类型。</li></ul><h2 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h2><p>完事具备，我们可以运行项目了。访问 <code>https://localhost:5001/fetch-data</code>，就可以看到前端是通过 gRPC-Web 获取数据了。</p><p><img src="/images/aspnetcore-grpc-web/3.png" alt=""></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>可以看出，要在前端 JS/TS 使用 gRPC-Web 虽然在开发工具上没有 Blazor WebAssembly 方便，但是从 <code>proto</code> 生成客户端之后，前端的 TS 代码就能直接获得强类型的调用方法和路由，很简单地得到 gRPC 带来的好处。另外，gRPC-Web 项目本身已经 GA，所以我们可以先在后端使用它的 gRPC 代理，而前端可以放心大胆地在我们的生产项目中使用它。等到 ASP.NET Core 正式支持 gRPC-Web 后，就可以不需要代理了，比其他平台和语言都更有优势。</p><p>本示例的源码已发布到 Github：<a href="https://github.com/ElderJames/AspNetCoreGrpcWeb" target="_blank" rel="noopener">https://github.com/ElderJames/AspNetCoreGrpcWeb</a></p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
            <tag> gRPC-Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core Support gRPC-Web</title>
      <link href="/asp_net_core-support-grpc-web.html"/>
      <url>/asp_net_core-support-grpc-web.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>grpc-dotnet 项目在 PR #695 完成了 ASP.NET Core 服务与 .NET Core gRPC 客户端的 gRPC-Web 实现。<br>虽然目前还是实验性项目，但是并不阻碍我们为之兴奋。下面我们来看看如何使用。</p></blockquote><h2 id="gRPC-Web-简介"><a href="#gRPC-Web-简介" class="headerlink" title="gRPC-Web 简介"></a>gRPC-Web 简介</h2><p>gRPC-Web 允许从浏览器应用程序使用 gRPC，gRPC-Web 支持在新场景中使用 gRPC：</p><ul><li>JavaScript 浏览器应用程序可以使用 gRPC-Web JavaScript 客户端调用 gRPC 服务。</li><li>Blazor WebAssembly 应用程序可以使用.Net Core gRPC 客户端调用 gRPC 服务。</li><li>可以让 gRPC 服务被用于不完全支持 HTTP/2 的环境中。</li><li>可以让 gRPC 用于 HTTP/2 中没有的技术，例如 Windows 身份验证。</li></ul><p>Grpc.AspNetCore.Web 和 Grpc.Net.Client.Web 提供了扩展来为 .NET Core 支持端到端的 gRPC-Web。</p><h2 id="服务端使用-Grpc-AspNetCore-Web"><a href="#服务端使用-Grpc-AspNetCore-Web" class="headerlink" title="服务端使用 Grpc.AspNetCore.Web"></a>服务端使用 Grpc.AspNetCore.Web</h2><p>Grpc.AspNetCore.Web 提供了中间件使 ASP.NET Core gRPC 服务接受 gRPC- web 调用。</p><p><em>Startup.cs</em></p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span><span class="token punctuation">{</span>    services<span class="token punctuation">.</span><span class="token function">AddGrpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    services<span class="token punctuation">.</span><span class="token function">AddGrpcWeb</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> o<span class="token punctuation">.</span>GrpcWebEnabled <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">)</span><span class="token punctuation">{</span>    app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    app<span class="token punctuation">.</span><span class="token function">UseGrpcWeb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">></span>    <span class="token punctuation">{</span>        endpoints<span class="token punctuation">.</span><span class="token generic-method function">MapGrpcService<span class="token punctuation">&lt;</span>GreeterService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>gRPC-Web 可以通过设置 <code>GrpcWebOptions.GrpcWebEnabled = true</code> 来被应用于所有 gRPC 服务，或者通过<code>EnableGrpcWeb()</code>方法被应用于单个服务：</p><pre class="line-numbers language-c"><code class="language-c">app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    endpoints<span class="token punctuation">.</span>MapGrpcService<span class="token operator">&lt;</span>GreeterService<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">EnableGrpcWeb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="客户端使用-Grpc-Net-Client-Web"><a href="#客户端使用-Grpc-Net-Client-Web" class="headerlink" title="客户端使用 Grpc.Net.Client.Web"></a>客户端使用 Grpc.Net.Client.Web</h2><p>Grpc.Net.Client.Web 提供了一个 HttpClient delegating handler 来配置 .NET Core gRPC 客户端发送 gRPC-Web 请求。</p><pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Create channel</span>var handler <span class="token operator">=</span> ew <span class="token function">GrpcWebHandler</span><span class="token punctuation">(</span>GrpcWebMode<span class="token punctuation">.</span>GrpcWebText<span class="token punctuation">,</span> new <span class="token function">HttpClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>var channel <span class="token operator">=</span> GrpcChannel<span class="token punctuation">.</span><span class="token function">ForAddress</span><span class="token punctuation">(</span><span class="token string">"https://localhost:5001"</span><span class="token punctuation">,</span> new GrpcChannelOptions    <span class="token punctuation">{</span>        HttpClient <span class="token operator">=</span> new <span class="token function">HttpClient</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// Make call with a client</span>var client <span class="token operator">=</span> Greeter<span class="token punctuation">.</span><span class="token function">GreeterClient</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>var response <span class="token operator">=</span> await client<span class="token punctuation">.</span><span class="token function">SayHelloAsync</span><span class="token punctuation">(</span>new GreeterRequest <span class="token punctuation">{</span> Name <span class="token operator">=</span> <span class="token string">".NET"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>可以看出，得益于 ASP.NET Core 3.0 以来对 gRPC 的深度集成，增加 gRPC 相关的新特性已经非常容易，使.NET Core 成为云原生家族的重要成员。</p><p>近期，观测分析平台 SkyWalking 的 .NET 自动探针 (SkyAPM-dotnet) 也已经支持了 grpc-dotnet 远程调用的链路跟踪采集，欢迎大家使用！如果喜欢，也请大家给点个星星！</p><p>项目地址：<a href="https://github.com/SkyAPM/SkyAPM-dotnet" target="_blank" rel="noopener">https://github.com/SkyAPM/SkyAPM-dotnet</a></p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
            <tag> gRPC-Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在 Blazor WebAssembly 中使用 gRPC-Web</title>
      <link href="/Using-gRPC-Web-with-Blazor-WebAssembly.html"/>
      <url>/Using-gRPC-Web-with-Blazor-WebAssembly.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>对于单页面应用程序，gRPC-Web 是 JSON-over-HTTP 的一种方便、高性能的替代方案。</p></blockquote><p><em>如果你已经了解关于 gRPC 和 gRPC-Web 的一切，你可以跳到 添加 gRPC 服务到一个Blazor WebAssembly 应用程序 一节。如果你只是想要一些简单的 Blazor WebAssembly + gRPC-Web 应用程序，请看这个仓库 <a href="https://github.com/SteveSandersonMS/BlazorGrpcSamples。" target="_blank" rel="noopener">https://github.com/SteveSandersonMS/BlazorGrpcSamples。</a></em></p><h1 id="现状"><a href="#现状" class="headerlink" title="现状"></a>现状</h1><p>与其他所有基于浏览器的单页应用程序（SPA）技术一样，在 Blazor WebAssembly 中，数据交互和触发服务器端操作的最常见方式是 JSON-over-HTTP。它很简单：客户端使用预先约定的 HTTP 方法向某个预先约定的 URL 发出 HTTP 请求，然后服务器执行操作并使用预先约定的 HTTP 状态码和预先约定格式的 JSON 数据进行应答。</p><p>这种方法通常很有效，这样做的人往往能过上充实的生活。然而，它也有两个显而易见的弱点：</p><ul><li>JSON 是一种非常冗长的数据格式，它没有优化带宽。</li><li>没有任何机制可以保证所有这些预先约定的 url、HTTP 方法、状态码 等等的细节在服务器和客户端之间实际上是一致的。</li></ul><h2 id="什么是-gRPC"><a href="#什么是-gRPC" class="headerlink" title="什么是 gRPC?"></a>什么是 gRPC?</h2><p>gRPC 是一种远程过程调用（RPC）机制，最初由谷歌开发。对于 SPA，你可以将其视为 JSON-over-HTTP 的替代方案。它直接修复了上面列出的两个弱点:</p><ul><li>它被优化为最小的网络流量，发送有效的二进制序列化消息</li><li>你可以在编译时保证服务器和客户端对端点的存在、数据的发送和接收形式达成一致，而不需要指定任何URL、状态码 等等。</li></ul><h2 id="这是怎么做到的呢？"><a href="#这是怎么做到的呢？" class="headerlink" title="这是怎么做到的呢？"></a>这是怎么做到的呢？</h2><p>要编写gRPC服务，你需要编写一个<code>.proto</code>文件，它是一组 RPC 服务及其数据形状的独立于语言的描述。从这里，你可以用任何语言生成强类型的服务器和客户端类，从而保证在编译时符合你的协议。然后在运行时，gRPC 处理(反)序列化数据并以有效的格式（默认为 protobuf ）发送/接收消息。</p><p>另一个很大的好处是它不是 REST，所以你不必与同事经常争论哪些 HTTP 方法和状态代码在你的场景中是最幸福和幸运的。它只是简单的 RPC，在我们还是小孩子的时候就真情实感想要的。</p><h2 id="为什么不是每个人都在他们的-SPA-中使用-gRPC"><a href="#为什么不是每个人都在他们的-SPA-中使用-gRPC" class="headerlink" title="为什么不是每个人都在他们的 SPA 中使用 gRPC ?"></a>为什么不是每个人都在他们的 SPA 中使用 gRPC ?</h2><p>传统上，从基于浏览器的应用程序中使用 gRPC 是不可能的，因为 gRPC 需要 HTTP/2，而且浏览器不公开任何 api，让 JS、WASM 代码直接控制 HTTP/2 请求。</p><p>但是现在有一个解决方案！gRPC-Web 是 gRPC的扩展，它使 gRPC 与基于浏览器的代码兼容（从技术上讲，它是通过 HTTP/1.1 请求执行 gRPC 的一种方式）。gRPC-Web 还没有流行起来，因为到目前为止还没有多少服务器或客户端框架提供对它的支持。</p><p>ASP.NET Core 从 3.0 版本开始就提供了强大的 gRPC 支持。现在，在此基础上，我们将在服务器和客户端提供对 gRPC-Web的预览支持。如果你想深入了解细节，可以在来自 James Newton-King 的优秀的 pull request 查看全部实现（<em><a href="https://github.com/grpc/grpc-dotnet/pull/695" target="_blank" rel="noopener">https://github.com/grpc/grpc-dotnet/pull/695</a></em>）。</p><h1 id="添加-gRPC-服务到一个-Blazor-WebAssembly-应用程序"><a href="#添加-gRPC-服务到一个-Blazor-WebAssembly-应用程序" class="headerlink" title="添加 gRPC 服务到一个 Blazor WebAssembly 应用程序"></a>添加 gRPC 服务到一个 Blazor WebAssembly 应用程序</h1><p>目前还没有这方面的项目模板，所以将 gRPC 支持添加到 Blazor WebAssembly 应用程序需要很多步骤，本文是详细的介绍。但好消息是你只需要做一次这样的设置。当你完成起步与运行起来后，添加更多的 gRPC 端点并调用它们是非常简单的。<br>首先，由于 gRPC-Web 包还没有发布到 NuGet.org，现在你需要添加两个临时的包管理源来获得 nightly 预览。<br>你可以在你的解决方案的根目录下添加<code>NuGet.config</code>文件。希望一两个月后就不需要了。</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packageSources</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!--To inherit the global NuGet package sources remove the &lt;clear/> line below --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clear</span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>nuget<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://api.nuget.org/v3/index.json<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gRPC-nightly<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://grpc.jfrog.io/grpc/api/nuget/v3/grpc-nuget-dev<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>blazor-nightly<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://dotnetfeed.blob.core.windows.net/aspnet-blazor/index.json<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packageSources</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="添加-gRPC-服务到一个托管部署的-Blazor-WebAssembly-应用程序"><a href="#添加-gRPC-服务到一个托管部署的-Blazor-WebAssembly-应用程序" class="headerlink" title="添加 gRPC 服务到一个托管部署的 Blazor WebAssembly 应用程序"></a>添加 gRPC 服务到一个托管部署的 Blazor WebAssembly 应用程序</h2><p>如果你已经在 ASP.NET Core 服务端上托管了一个Blazor WebAssembly 应用程序，默认情况下，你有三个项目：客户端、服务端和共享项目。我发现定义 gRPC 服务最方便的地方是在共享项目中，因为这样生成的类对服务器和客户机都可用。<br>首先，编辑你的共享项目的<code>.csproj</code>添加必要的 gRPC 包引用：</p><pre class="line-numbers language-xml"><code class="language-xml">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Google.Protobuf<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3.11.2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.Net.Client<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001100801<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.Tools<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001081219<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PrivateAssets</span><span class="token punctuation">></span></span>all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PrivateAssets</span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>IncludeAssets</span><span class="token punctuation">></span></span>runtime; build; native; contentfiles; analyzers; buildtransitive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>IncludeAssets</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PackageReference</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果这些包不能正确恢复，请确保添加了 nightly 源。</p><p>现在可以创建<code>.proto</code>文件来定义服务了。例如，在共享项目中添加一个名为<code>greet.proto</code>的文件。包含如下内容：</p><pre class="line-numbers language-proto"><code class="language-proto">syntax = "proto3";option csharp_namespace = "GrpcGreeter";package greet;service Greeter {  rpc SayHello (HelloRequest) returns (HelloReply);}message HelloRequest {  string name = 1;}message HelloReply {  string message = 1;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>要使gRPC工具从这里生成服务器和客户端类，请进入共享项目的<code>.csproj</code>并添加以下内容:</p><pre class="line-numbers language-xml"><code class="language-xml">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ItemGroup</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Protobuf</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>greet.proto<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ItemGroup</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>此时，解决方案应该可以没有错误地编译通过。</p><h3 id="从服务端公开gRPC服务"><a href="#从服务端公开gRPC服务" class="headerlink" title="从服务端公开gRPC服务"></a>从服务端公开gRPC服务</h3><p>在你的服务器项目中，创建一个名为<code>GreeterService</code>的新类，包含以下内容:</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">using</span> Grpc<span class="token punctuation">.</span>Core<span class="token punctuation">;</span><span class="token keyword">using</span> GrpcGreeter<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GreeterService</span> <span class="token punctuation">:</span> Greeter<span class="token punctuation">.</span>GreeterBase<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">override</span> Task<span class="token operator">&lt;</span>HelloReply<span class="token operator">></span> <span class="token function">SayHello</span><span class="token punctuation">(</span>HelloRequest request<span class="token punctuation">,</span> ServerCallContext context<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> reply <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HelloReply</span> <span class="token punctuation">{</span> Message <span class="token operator">=</span> $<span class="token string">"Hello from gRPC, {request.Name}!"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个类继承自 <code>Greeter.GreeterBase</code>，它是从 <code>.proto</code> 文件自动生成的。因此，当你将新断点添加到 <code>.proto</code> 中时，你将有新方法可以在这里进行重写来提供具体实现。</p><p>服务端的最后一部分是使用新的 api 将其公开为一个 <code>gRPC-Web</code> 服务。你需要为此引用一个包，因此在你的服务端项目的<code>.csproj</code>中，添加以下包引用:</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.AspNetCore<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001100801<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.AspNetCore.Web<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001100801<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>现在，在你的服务器的<code>Startup.cs</code>文件中，修改<code>ConfigureServices</code>以添加以下行:</p><pre class="line-numbers language-csharp"><code class="language-csharp">  services<span class="token punctuation">.</span><span class="token function">AddGrpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><em>注意:如果你只打算公开gRPC服务，你可能不再需要MVC控制器，在这种情况下，你可以从下面删除<code>services.AddMvc()</code>和<code>endpoints.MapDefaultControllerRoute()</code>。</em></p><p>只是在 <code>app.AddRouting();</code> 的下面添加以下内容，它会处理将传入的gRPC-web请求映射到服务端，使其看起来像 gRPC请求:</p><pre><code>  app.UseGrpcWeb();</code></pre><p>最后，在<code>app.UseEndpoints</code>语句块中注册你的 gRPC-Web 服务类，并在该语句块的顶部使用以下代码行:</p><pre class="line-numbers language-csharp"><code class="language-csharp">  endpoints<span class="token punctuation">.</span><span class="token generic-method function">MapGrpcService<span class="token punctuation">&lt;</span>GreeterService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">EnableGrpcWeb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>就这样，你的gRPC-Web服务端已经准备好了!</p><h3 id="在客户端中使用gRPC服务"><a href="#在客户端中使用gRPC服务" class="headerlink" title="在客户端中使用gRPC服务"></a>在客户端中使用gRPC服务</h3><p>在你的客户端项目的<code>.csproj</code>中，你需要添加以下两个 nightly 包的引用:</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.Net.Client.Web<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001100801<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Blazor.Mono<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3.2.0-preview1.20052.1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>后者是为了修复 Blazor WebAssembly 中的一个问题的变通方案，这个问题将在几周后的下一次预览中得到修复。如果这些包不能正常恢复，请确保添加了 nightly 源。</p><p>现在设置你的客户端应用程序的依赖项注入系统，以便能够提供<code>GreeterClient</code>的实例。这将允许你在客户端应用程序的任何位置调用 gRPC 服务。在客户端项目的<code>Startup.cs</code>中的<code>ConfigureServices</code>方法中添加以下内容:</p><pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>services <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// Create a gRPC-Web channel pointing to the backend server</span>    <span class="token keyword">var</span> httpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GrpcWebHandler</span><span class="token punctuation">(</span>GrpcWebMode<span class="token punctuation">.</span>GrpcWeb<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> baseUri <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token generic-method function">GetRequiredService<span class="token punctuation">&lt;</span>NavigationManager<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BaseUri<span class="token punctuation">;</span>    <span class="token keyword">var</span> channel <span class="token operator">=</span> GrpcChannel<span class="token punctuation">.</span><span class="token function">ForAddress</span><span class="token punctuation">(</span>baseUri<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GrpcChannelOptions</span> <span class="token punctuation">{</span> HttpClient <span class="token operator">=</span> httpClient <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Now we can instantiate gRPC clients for this channel</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Greeter<span class="token punctuation">.</span>GreeterClient</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意的是<code>Greeter.GreeterClient</code>是从<code>.proto file</code>文件中为你生成的代码。你不必手动实现它！但你还需要添加以下使用语句，使上述代码编译通过：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">using</span> GrpcGreeter<span class="token punctuation">;</span><span class="token keyword">using</span> Grpc<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Client<span class="token punctuation">;</span><span class="token keyword">using</span> Grpc<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Client<span class="token punctuation">.</span>Web<span class="token punctuation">;</span><span class="token keyword">using</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Components<span class="token punctuation">;</span><span class="token keyword">using</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们快完成了！现在有一个可工作的服务端，并希望还有一个可工作的客户端。我们只需要从 UI 调用一些 gRPC 服务。例如，在你的<code>Index.razor</code>文件中，替换成如下内容： </p><pre class="line-numbers language-csharp"><code class="language-csharp">@page <span class="token string">"/"</span>@<span class="token keyword">using</span> GrpcGreeter@inject Greeter<span class="token punctuation">.</span>GreeterClient GreeterClient<span class="token operator">&lt;</span>h1<span class="token operator">></span>Invoke gRPC service<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token operator">&lt;</span>p<span class="token operator">></span>    <span class="token operator">&lt;</span>input @bind<span class="token operator">=</span><span class="token string">"yourName"</span> placeholder<span class="token operator">=</span><span class="token string">"Type your name"</span> <span class="token operator">/</span><span class="token operator">></span>    <span class="token operator">&lt;</span>button @onclick<span class="token operator">=</span><span class="token string">"GetGreeting"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-primary"</span><span class="token operator">></span>Call gRPC service<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>Server response<span class="token punctuation">:</span> <span class="token operator">&lt;</span>strong<span class="token operator">></span>@serverResponse<span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">></span>@code <span class="token punctuation">{</span>    <span class="token keyword">string</span> yourName <span class="token operator">=</span> <span class="token string">"Bert"</span><span class="token punctuation">;</span>    <span class="token keyword">string</span> serverResponse<span class="token punctuation">;</span>    <span class="token keyword">async</span> Task <span class="token function">GetGreeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HelloRequest</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> yourName <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> reply <span class="token operator">=</span> <span class="token keyword">await</span> GreeterClient<span class="token punctuation">.</span><span class="token function">SayHelloAsync</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>        serverResponse <span class="token operator">=</span> reply<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在在浏览器中尝试一下。用户界面看起来是这样的:</p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2020/01/15/greeter-ui.png" alt=""></p><p>如果你查看浏览器开发者工具的 network 选项卡中的请求，你会看到它在发送和接收二进制protobuf消息:</p><p><img src="https://blog.stevensanderson.com/wp-content/uploads/2020/01/15/greeter-request.png" alt=""></p><h3 id="总结和示例"><a href="#总结和示例" class="headerlink" title="总结和示例"></a>总结和示例</h3><p>现在你已经有了基础，如果你愿意，还可以进一步使用 gRPC 来进行服务器和客户机之间的所有数据交换。gRPC 工具将为你生成所有的数据传输类，提高网络流量的效率，并消除 url、HTTP 方法、状态代码和序列化等 HTTP-over-JSON 的问题。</p><p>还有一个更详细的示例（<em><a href="https://github.com/SteveSandersonMS/BlazorGrpcSamples/tree/master/Hosted" target="_blank" rel="noopener">https://github.com/SteveSandersonMS/BlazorGrpcSamples/tree/master/Hosted</a></em>），它是一个完整的 Blazor WebAssembly 托管应用程序，使用 gRPC 获取“天气预报”数据。如果你对从默认的基于json的解决方案升级到基于gRPC-Web的解决方案所需的具体步骤感兴趣，请参阅这个准确地显示了我所做的更改的差异对比（<em><a href="https://github.com/SteveSandersonMS/BlazorGrpcSamples/commit/72544c54085a35cd89aae20030d7f91d75317a2f" target="_blank" rel="noopener">https://github.com/SteveSandersonMS/BlazorGrpcSamples/commit/72544c54085a35cd89aae20030d7f91d75317a2f</a></em>）。</p><h2 id="添加-gRPC-服务到一个独立部署的-Blazor-WebAssembly-应用程序"><a href="#添加-gRPC-服务到一个独立部署的-Blazor-WebAssembly-应用程序" class="headerlink" title="添加 gRPC 服务到一个独立部署的 Blazor WebAssembly 应用程序"></a>添加 gRPC 服务到一个独立部署的 Blazor WebAssembly 应用程序</h2><p>如果你正在构建一个纯独立的 Blazor WebAssembly 应用程序，而不是托管在 ASP.NET Core，那么我们就不能对你将拥有什么样的服务器做任何假设（意思是你只开发客户端，而服务端是由别人开发的场景）。我们只能假设你要调用一些与 gRPC-Web 兼容的服务端点，它们可能是在其他主机上的 ASP.NET Core 服务上暴露，或者是一个在另一个 gRPC 服务周围的 Envoy gRPC-Web 包装器（<em><a href="https://blog.envoyproxy.io/envoy-and-grpc-web-a-fresh-new-alternative-to-rest-6504ce7eb880" target="_blank" rel="noopener">https://blog.envoyproxy.io/envoy-and-grpc-web-a-fresh-new-alternative-to-rest-6504ce7eb880</a></em>）。在这里我们唯一关心的是配置你的 Blazor WebAssembly 应用程序来使用它。<br>设置客户端应用程序的大多数步骤与上面的“托管部署”情况相同。然而，在某些方面，它有点棘手，因为我们不能依赖于我们在“托管”情况下所做的一些假设。区别如下:</p><ul><li><p>获取和使用.proto文件</p><p>假定你的外部 gRPC 服务维护者可以为你提供定义该服务的<code>.proto</code>文件。你可以将其复制到你的客户端项目中，并在<code>.csproj</code>中添加一个引用它的<code>&lt;Proto&gt;</code>项。为了让工具工作，你还需要添加类似这样的包引用:</p><pre class="line-numbers language-xml"><code class="language-xml">  <span class="token comment" spellcheck="true">&lt;!-- Needed temporarily until the next Blazor WebAssembly preview release --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Blazor.Mono<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3.2.0-preview1.20052.1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token comment" spellcheck="true">&lt;!-- gRPC-Web packages --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Google.Protobuf<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3.11.2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.Net.Client<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001100801<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.Net.Client.Web<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001100801<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Grpc.Tools<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.27.0-dev202001081219<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PrivateAssets</span><span class="token punctuation">></span></span>all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PrivateAssets</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>IncludeAssets</span><span class="token punctuation">></span></span>runtime; build; native; contentfiles; analyzers; buildtransitive<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>IncludeAssets</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PackageReference</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>配置客户端DI服务</p><p>与“托管托管”情况类似，你将向Startup.cs中添加代码以添加gRPC-Web客户端服务。这里的主要区别是，你必须知道用于访问外部服务的 Base URL 是什么，因为我们不能再假设它的 Base URL 跟托管你的客户端应用程序的服务端的 Base URL 一样。因此，你的DI服务注册可能看起来更像以下内容:</p><pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>services <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token preprocessor property">#<span class="token directive keyword">if</span> DEBUG</span>    <span class="token keyword">var</span> backendUrl <span class="token operator">=</span> <span class="token string">"https://localhost:5001"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Local debug URL</span><span class="token preprocessor property">#<span class="token directive keyword">else</span></span>    <span class="token keyword">var</span> backendUrl <span class="token operator">=</span> <span class="token string">"https://some.external.url:12345"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Production URL</span><span class="token preprocessor property">#<span class="token directive keyword">endif</span></span>    <span class="token comment" spellcheck="true">// Now we can instantiate gRPC clients for this channel</span>    <span class="token keyword">var</span> httpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GrpcWebHandler</span><span class="token punctuation">(</span>GrpcWebMode<span class="token punctuation">.</span>GrpcWeb<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HttpClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> channel <span class="token operator">=</span> GrpcChannel<span class="token punctuation">.</span><span class="token function">ForAddress</span><span class="token punctuation">(</span>backendUrl<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GrpcChannelOptions</span> <span class="token punctuation">{</span> HttpClient <span class="token operator">=</span> httpClient <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Greeter<span class="token punctuation">.</span>GreeterClient</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这将根据你是否在调试模式下构建而改变URL。</p></li></ul><h3 id="总结和示例-1"><a href="#总结和示例-1" class="headerlink" title="总结和示例"></a>总结和示例</h3><p>就是这样！现在，你的独立部署的 Blazor WebAssembly 应用程序可以使用外部的 gRPC-Web 服务。对于完整的可运行示例，下面是一个示例独立应用程序（<code>https://github.com/SteveSandersonMS/BlazorGrpcSamples/tree/master/Standalone</code>），它在外部 URL 上调用一个 gRPC-Web 服务。 这个示例附带了一个实际的用于测试的 gRPC-Web 服务器，但是你可以分开考虑它。如果你想确切地看到我更改了什么，这里是与默认项目模板输出的差异（<code>https://github.com/SteveSandersonMS/BlazorGrpcSamples/commit/d6ec609f2b7e6591958d38e4a207c9b4f52f0feb</code>）。</p><h1 id="你的反馈要求"><a href="#你的反馈要求" class="headerlink" title="你的反馈要求"></a>你的反馈要求</h1><p>如果你想进一步了解 gRPC，看看 ASP.NET Core gRPC 文档。请给我们关于你对 gRPC-Web 的意见和经验的反馈，因为这将帮助我们选择如何以及是否在未来的 ASP.NET Core 版本中使 gRPC-Web 成 一个标准特性。你可以在这里发布评论，或者在 GitHub 上发布标题中带有“反馈”的 issue。</p><blockquote><p>翻译自原文：<a href="https://blog.stevensanderson.com/2020/01/15/2020-01-15-grpc-web-in-blazor-webassembly" target="_blank" rel="noopener">https://blog.stevensanderson.com/2020/01/15/2020-01-15-grpc-web-in-blazor-webassembly</a></p><p>相关文章：</p><ul><li>ASP.NET Core 现已支持gRPC-Web</li><li>.NET Core ❤ gRPC</li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> Blazor </tag>
            
            <tag> ASP.NET Core </tag>
            
            <tag> gRPC-Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记2020年1月5日的一次 .NET 线下MeetUp</title>
      <link href="/.NET-Meetup-20200105.html"/>
      <url>/.NET-Meetup-20200105.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>今年 1 月 5 日，微软上海 Reactor 与 中国 .NET 社区举办了一次线下 Meetup，很荣幸邀请了我进行一次分享。</p><ul><li>活动时间：1 月 4 日 周六 13:00-17:00</li><li>活动地址：上海徐汇田林路 192 号 J 座 1 楼 微软 Reactor</li></ul><p>活动宣传页面：<a href="https://mp.weixin.qq.com/s/pqWM3J4Wq6hDl-wgnmoaiQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/pqWM3J4Wq6hDl-wgnmoaiQ</a></p><p>我分享的主题是 《浅谈 .NET 上“佛系”的反应式架构开发框架 Orleans》</p><p>Orleans 是.NET 实现的开源跨平台框架，用于构建健壮的、可伸缩的分布式应用程序。在如今微服务和云原生热火朝天的氛围中，Orleans 不该缺席。Orleans 已开源 5 年，并一直在不断发展中，最新版本已支持.NET Core 3.1。本次分享主要带领开发者认识 Orleans 实现的反应式架构，以及 Orleans 的优秀特性，通过代码示例体会它“佛系”却强大的编程模型。</p><p>我的演讲现场：</p><p><img src="/images/dotnet-meetup/meetup-orleans-share.png" alt=""></p><p>当天活动大合照：</p><p><img src="/images/dotnet-meetup/20200105-meetup-people.jpg" alt=""></p><p>除了我的分享，其他几位大牛也讲得非常好，受益匪浅！！希望以后能有更多的机会在线下与大家分享我热爱的技术！</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Orleans </tag>
            
            <tag> .NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Angular 利用 marked.js 添加 Markdown + HTML 同时渲染的 Pipe</title>
      <link href="/add-Markdown-and-html-rendering-pipe-in-Angular-using-markedjs.html"/>
      <url>/add-Markdown-and-html-rendering-pipe-in-Angular-using-markedjs.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近在公司开发的一个项目需要在 Angular 上展示图文，并且需要同时支持 Markdown 和 HTML</p><p>对于同时支持 Markdown 和 HTML ，应该要分为编辑和渲染两部分考虑。</p><p>对于编辑，目前尚未找到同时支持两种格式的编辑器。我个人认为 Markdown 最好的开源编辑器是 <a href="https://pandao.github.io/editor.md/" target="_blank" rel="noopener">Editor.md</a>，最好的 HTML 编辑器是 <a href="https://github.com/fex-team/ueditor" target="_blank" rel="noopener">UEditor</a>，虽然他们俩都已经很久很久没更新过……</p><p>所以在编辑页面就只能提供两个编辑器的切换，对于 Markdown 和 HTML 分部用各自的编辑器。 但是，我可以存到同一个字段吗？</p><p>这就要考虑到渲染了，如果能找到同时支持渲染 Markdown 和 HTML 的组件，我就不需要在后端把 Markdown 原文和渲染后的 HTML 分开字段存储了，还有利于对 Markdown 文本的修改。</p><p>于是找到了 marked.js</p><h2 id="marked-js-介绍"><a href="#marked-js-介绍" class="headerlink" title="marked.js 介绍"></a>marked.js 介绍</h2><p><a href="https://marked.js.org/" target="_blank" rel="noopener">官方文档</a></p><p>marked.js 是一个普通的js库，并不是 Angular 特有的组件，所以我们在集成时还是需要进行一些编码。同时也说明它能支持其他前端框架，甚至是普通 HTML 的直接引用，非常轻量。</p><h2 id="给-Angular-添加一个用于-Markdown-渲染的-Pipe"><a href="#给-Angular-添加一个用于-Markdown-渲染的-Pipe" class="headerlink" title="给 Angular 添加一个用于 Markdown 渲染的 Pipe"></a>给 Angular 添加一个用于 Markdown 渲染的 Pipe</h2><p>Angular Pipe 是 Angular 中用于字符格式转换的组件，专门处理输出字符的转换，如日期、翻译等等在Angular开发中都比较常用。今天我们就给项目添加一个用于 Markdown 渲染的 Pipe。</p><h3 id="一、npm-引用"><a href="#一、npm-引用" class="headerlink" title="一、npm 引用"></a>一、npm 引用</h3><p>需要引用marked.js和它的 typescript 类型库来辅助模块声明</p><pre class="line-numbers language-bash"><code class="language-bash">    <span class="token function">npm</span> <span class="token function">install</span> marked    <span class="token function">npm</span> <span class="token function">install</span> @types/marked<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="二、创建-Pipe"><a href="#二、创建-Pipe" class="headerlink" title="二、创建 Pipe"></a>二、创建 Pipe</h3><p>通过 angular-cli 创建 Pipe 文件</p><pre class="line-numbers language-bash"><code class="language-bash">ng generate pipe marked<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这样它能自动创建一个名为 “marked” 的 Pipe (<code>marked.pipe.ts</code>)，并导入到你的 <code>app.module.ts</code> 文件中了。</p><h3 id="修改-marked-pipe-ts"><a href="#修改-marked-pipe-ts" class="headerlink" title="修改 marked.pipe.ts"></a>修改 <code>marked.pipe.ts</code></h3><p>生成出来的 <code>marked.pipe.ts</code> 文件如下：</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Pipe<span class="token punctuation">,</span> PipeTransform <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>@<span class="token function">Pipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">'marked'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MarkedPipe</span> <span class="token keyword">implements</span> <span class="token class-name">PipeTransform</span> <span class="token punctuation">{</span>  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">,</span> args<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">any</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们需要导入 marked , 然后修改 transform 方法来解析 Markdown 并返回 HTML 字符串。</p><p>更改之后的代码如下：</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> Pipe<span class="token punctuation">,</span> PipeTransform <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@angular/core"</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token operator">*</span> as marked <span class="token keyword">from</span> <span class="token string">"marked"</span><span class="token punctuation">;</span>@<span class="token function">Pipe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  name<span class="token punctuation">:</span> <span class="token string">"marked"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MarkedPipe</span> <span class="token keyword">implements</span> <span class="token class-name">PipeTransform</span> <span class="token punctuation">{</span>  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">any</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">marked</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> value<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中的 <code>transform</code> 方法将接受文本作为值，如果它有长度，则返回解析后的 HTML。否则，它只返回传递的值。</p><h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><p>使用方法跟其他 Pipe 几乎差不多，但是有一点，就是如果渲染出来的是 HTML 字符串，需要让 Angular 自己在渲染成最终的 HTML，我们需要把 HTML 字符串传入到 Angular 模版中一个 HTML 元素的 <code>innerHTML</code> 属性中，举个例子：</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token comment" spellcheck="true">// app.component.ts</span><span class="token operator">...</span><span class="token keyword">public</span> markdownString<span class="token punctuation">:</span> <span class="token keyword">string</span> <span class="token operator">=</span> <span class="token string">'This is text with **markdown**'</span><span class="token punctuation">;</span><span class="token operator">...</span><span class="token comment" spellcheck="true">// app.component.html</span><span class="token operator">...</span><span class="token operator">&lt;</span>div <span class="token punctuation">[</span>innerHTML<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"markdownString | marked"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这样就大功告成啦！你可以尝试使用同时含有 Markdown 和 HTML 的字符串，就像 Github 里众多开源项目的 README 文档一样，使用穿插着 HTML 排版的文档来渲染美观的图文。</p>]]></content>
      
      
      <categories>
          
          <category> Angular </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Angular </tag>
            
            <tag> Typescript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Asp.Net Core 3.0 Identity 集成 Microsoft Account OAuth</title>
      <link href="/AspNet-Core-3_0-Identity-For-Microsoft-Account-OAuth.html"/>
      <url>/AspNet-Core-3_0-Identity-For-Microsoft-Account-OAuth.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最近在给使用 Identity Server 开发的登录中心添加第三方授权登录，集成了微信、钉钉、Github，最后还想到使用Windows 10系统的用户，大多数都有 Microsoft 帐号了，如果集成了 Microsoft 帐号，会带来更多方便！于是就研究了 Microsoft Account OAuth 授权的集成。</p><p>使用 Microsoft Account 授权的方式有几种:</p><ul><li>Azure Active Directory</li><li>Microsoft Graph</li><li>Azure WebApp</li></ul><p>本示例就用注册简单的 WebApp 实现吧！</p><h3 id="一、注册-Azure-WebApp"><a href="#一、注册-Azure-WebApp" class="headerlink" title="一、注册 Azure WebApp"></a>一、注册 Azure WebApp</h3><ul><li>访问应用注册页面 <a href="https://ms.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps" target="_blank" rel="noopener">https://ms.portal.azure.com/#blade/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/RegisteredApps</a></li></ul><p><img src="/images/msaccount/1.png" alt=""></p><ul><li>选择个人账户中的应用程序选项卡，点击新注册，选择“仅与个人账户关联”，输入名称，点击注册。</li></ul><p><img src="/images/msaccount/2.png" alt=""></p><ul><li>注册后，看到应用列表中有这个新注册的应用，点击进入设置页面，可以应用程序(客户端) ID。</li></ul><p><img src="/images/msaccount/3.png" alt=""></p><p><img src="/images/msaccount/4.png" alt=""></p><p><img src="/images/msaccount/5.png" alt=""></p><ul><li>进入证书与密码页面，点击新客户端密码，创建一个客户端密码。</li></ul><p><img src="/images/msaccount/6.png" alt=""></p><h3 id="二、在ASP-NET-Core-应用中注册一个ExternalProvider"><a href="#二、在ASP-NET-Core-应用中注册一个ExternalProvider" class="headerlink" title="二、在ASP.NET Core 应用中注册一个ExternalProvider"></a>二、在ASP.NET Core 应用中注册一个ExternalProvider</h3><ul><li><p>安装Nuget包</p><pre class="line-numbers language-xml"><code class="language-xml">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Authentication.MicrosoftAccount<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>3.0.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>注册 Microsoft Account OAuth 验证组件，配置ClientId和ClientSecret，以及回调路径</p><pre class="line-numbers language-cs"><code class="language-cs">  services.AddAuthentication()      .AddMicrosoftAccount(options =>      {          //options.SignInScheme = IdentityServerConstants.ExternalCookieAuthenticationScheme;          options.ClientId = Configuration["Microsoft:ClientId"];          options.ClientSecret = Configuration["Microsoft:ClientSecret"];          options.CallbackPath = new PathString("/signin-microsoft");      });<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  PS. 集成 Identity Server 4 之后，可能需要设置 <code>options.SignInScheme = IdentityServerConstants.ExternalCookieAuthenticationScheme;</code></p><p>  <img src="/images/msaccount/7.png" alt=""></p></li></ul><h3 id="三、完成！"><a href="#三、完成！" class="headerlink" title="三、完成！"></a>三、完成！</h3>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>.NET Core 3.0中用 Code-First 方式创建 gRPC 服务与客户端</title>
      <link href="/code-first-generate-gRPC-services-and-clients-in-dotnet-Core-3_0.html"/>
      <url>/code-first-generate-gRPC-services-and-clients-in-dotnet-Core-3_0.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="NET-Core-love-gRPC"><a href="#NET-Core-love-gRPC" class="headerlink" title=".NET Core love gRPC"></a>.NET Core love gRPC</h2><p>千呼万唤的 .NET Core 3.0 终于在 9 月份正式发布，在它的众多新特性中，除了性能得到了大大提高，比较受关注的应该是 ASP.NET Core 3.0 对 gRPC 的集成了。<br>它的源码托管在 grpc-dotnet 这个 Github 库中，由微软 .NET 团队与谷歌 gRPC 团队共同维护.</p><p>.NET Core 对 gRPC 的支持在 grpc 官方仓库早已有实现（grpc/csharp），但服务端没有很好地与 ASP.NET Core 集成，使用起来还需要自己进行一些集成扩展。<br>而 ASP.NET Core 3.0 新增了 gRPC 服务的托管功能，能让 gRPC 与 ASP.NET Core 框架本身的特性很好地结合，如日志、依赖注入、身份认证和授权，并由 Kestrel 服务器提供 HTTP/2 链接，性能上得到充分保障。</p><p>推荐把项目中已有的 RPC 框架或者内部服务间 REST 调用都迁移到 gRPC 上，因为它已经是云原生应用的标准 RPC 框架，在整个 CNCF 主导下的云原生应用开发生态里 gRpc 有着举足轻重的地位。</p><p>对于 gRPC 的使用方式，前段时间已经有其他大神写的几篇文章了，这里就不再赘述了。<br>本文主要介绍的是区别于标准使用规范的，但对.NET 应用更加友好的使用方式，最后会提供源码来展示。</p><p>作为对比，还是要列一下标准的使用步骤：</p><ol><li>定义 proto 文件，包含服务、方法、消息对象的定义</li><li>引入 <code>Grpc.Tools</code> Nuget 包并添加指定 proto 路径和生成模式</li><li>生成项目，得到服务端的抽象类或客户端的调用客户端组件</li><li>实现服务端抽象类，并在 ASP.NET Core 注册这个服务的路由端点</li><li>DI 注册 gRPC 服务。</li><li>客户端用 <code>Grpc.Net.ClientFactory</code> Nuget 包进行统一配置和依赖注入</li></ol><p>.NET Core 对 gRPC 的大力支持使开发者开发效率大大提高，入门难度也减少了许多，完全可以成为跟 WebApi 等一样的 .NET Core 技术栈的标配。</p><h2 id="proto-在单一语言系统架构中的局限性"><a href="#proto-在单一语言系统架构中的局限性" class="headerlink" title="proto 在单一语言系统架构中的局限性"></a>proto 在单一语言系统架构中的局限性</h2><p>使用 proto 文件的好处是多语言支持，同一份 proto 可以生成各种语言的服务和客户端，可以让用不同语言开发的微服务直接互相远程调用。但 proto 文件作为不同服务间的契约，不可以经常修改，否则就会对使用了它的服务造成不同程度的影响，因此对 proto 文件的版本控制需要得到重视。</p><p>另外，我们的应用程序还不应该与 gRPC 耦合，否则就会导致系统架构被这些实现细节所绑架。直接依赖 proto 文件和由它生成的代码，就是对 gRPC 的强耦合。</p><p>例如，当应用程序在演进的过程中，复杂度还未达到完全部署隔离的必要时，为了避免因“完全边界”引入的部署运维复杂性，又能预留隔离的可能性，需要有一层接口层作为“不完全边界”。</p><p>又比如，目前在 windows 系统的 iis 上还不支持 grpc-dotnet，当有 windows 上的应用程序需要使用 RPC，就需要换成 REST 的实现了。</p><p>因此，为了不让应用程序对 gRPC 过于依赖，还应该使用一层抽象（接口）层与其解耦，用接口来隔离对 RPC 实现的依赖，这样在需要使用不同的实现时，可以通过注册不同的实现来方便地切换。</p><p>在这些场景下，本文要介绍的 Code-First gRPC 使用方法就发挥作用了。</p><h2 id="Code-First-gRPC"><a href="#Code-First-gRPC" class="headerlink" title="Code-First gRPC"></a>Code-First gRPC</h2><p>说了这么久，我好像还没正式介绍 Code-First gRPC，到底他有多适合在单一语言系统架构中实现 gRPC 呢？下面要介绍的就是基于大名鼎鼎的 protobuf-net 实现的 gRPC 框架，<strong>protobuf-net.Grpc</strong>。</p><p>protobuf-net 是在过去十几年前到现在一直在 .NET 中有名的 Protobuf 库，想用 Protobuf 序列化时就会用到这个库。他的特性就是可以把 C# 代码编写的类能以 Protobuf 的协议进行序列化和反序列化，而不是 proto 文件再生成这些类。而 protobuf-net.Grpc 则是一脉相承，可以把 C# 写的接口，在服务端方便地把接口的实现类注册成 ASP.NET Core 的 gRPC 服务，在客户端把接口动态代理实现为调用客户端，调用前面的这个服务端。</p><p>用法很简单，只要声明一个接口为您的服务契约：</p><pre class="line-numbers language-cs"><code class="language-cs">[ServiceContract]public interface IMyAmazingService {    ValueTask<SearchResponse> SearchAsync(SearchRequest request);    // ...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后实现该接口的服务端：</p><pre class="line-numbers language-cs"><code class="language-cs">public class MyServer : IMyAmazingService {    // ...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>或者向系统获取客户端：</p><pre class="line-numbers language-cs"><code class="language-cs">var client = http.CreateGrpcService<IMyAmazingService>();var results = await client.SearchAsync(request);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这相当于以下 .proto 中的服务：</p><pre class="line-numbers language-proto"><code class="language-proto">service MyAmazingService {    rpc Search (SearchRequest) returns (SearchResponse) {}    // ...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><code>protobuf-net.Grpc</code> 同样通过普通类型定义支持 gRPC 的四种模式，把 C# 8.0 中最新的 <code>IAsyncEnumerable</code> 类型识别成 proto 中的 <code>stream</code>，单向流、双向流都可以实现！而且用 <code>IAsyncEnumerable</code> 实现可比 proto 生成的类方便很多。</p><p>例如 proto 双向流定义：</p><pre><code>rpc chat(stream ChatRequest) returns ( stream ChatResponse);</code></pre><p>生成出来的方法是：</p><pre class="line-numbers language-cs"><code class="language-cs">Task BathTheCat(IAsyncStreamReader<ChatRequest> requestStream, IServerStreamWriter<ChatResponse> responseStream)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>而 <code>protobuf-net.Grpc</code> 只要定义一个方法：</p><pre class="line-numbers language-cs"><code class="language-cs">IAsyncEnumerable<ChatResponse> SubscribeAsync(IAsyncEnumerable<ChatRequest> requestStream);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>由此可见，<code>protobuf-net.Grpc</code> 无需在契约层引入第三方库，充分运用了 C# 类型系统，把方法、类型映射到兼容了 gRPC 的服务定义上。</p><p>上文所说的 proto 局限也迎刃而解了，函数调用、gRPC、REST 都能方便切换。（REST 实现可以参考我的开源框架 shriek-fx 中的 Shriek.ServiceProxy.Http ）组件。</p><p>下一篇，我将主要介绍利用 <code>protobuf-net.Grpc</code> 的 gRPC 双向流模式与 <code>Blazor</code> 实现一个简单的在线即时聊天室。</p><p><img src="https://raw.githubusercontent.com/ElderJames/GrpcChat/master/grpc-chat.gif" alt=""></p><p>相关链接：</p><ul><li>protobuf-net.Grpc：<a href="https://github.com/protobuf-net/protobuf-net.Grpc" target="_blank" rel="noopener">https://github.com/protobuf-net/protobuf-net.Grpc</a></li><li>shriek-fx：<a href="https://github.com/Shriek-Projects/shriek-fx" target="_blank" rel="noopener">https://github.com/Shriek-Projects/shriek-fx</a></li><li>GrpcChat: <a href="https://github.com/ElderJames/GrpcChat" target="_blank" rel="noopener">https://github.com/ElderJames/GrpcChat</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>利用Topshelf把.NET Core Generic Host管理的应用程序部署为Windows服务</title>
      <link href="/Using-Topshelf-To-Deploy-Net-Core-Generic-Host-App-To-Windows-Services.html"/>
      <url>/Using-Topshelf-To-Deploy-Net-Core-Generic-Host-App-To-Windows-Services.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>2019第一篇文章。</p><p>此文源于前公司在迁移项目到.NET Core的过程中，希望使用Generic Host来管理定时任务程序时，没法部署到Windows服务的问题，而且官方也没给出解决方案，只能关注一下<a href="https://github.com/aspnet/Extensions/issues/809" target="_blank" rel="noopener">官方issue #809</a> 等他们方解决了。</p><p>官方文档只提供了一个<a href="https://docs.microsoft.com/en-us/aspnet/core/host-and-deploy/windows-service?spm=a2c4e.11153940.blogcont676413.12.65753eb0BIzfmE&view=aspnetcore-2.1" target="_blank" rel="noopener">《在 Windows 服务中托管 ASP.NET Core》</a>的方案，可以使用<code>Microsoft.AspNetCore.Hosting.WindowsServices</code>类库来把Web应用部署为Windows服务。但是ASP.NET Core虽然是控制台程序，但是它本身是使用了含有HTTP管道的Web Host来负责应用程序的生命周期管理，用它来作为定时任务的话，会有很多不必要的工作负载，例如占用端口、增加了很多依赖等等。</p><p>官方意识到这个问题之后，在.NET Core 2.1版本新增了Generic Host通用主机，剥离了原来WebHost的Http管道相关的API，源码中可以发现Web Host已经基于Generic Host实现。它才是作为纯粹定时任务程序的最佳拍档。</p><p>但是由于Generic Host本身非常简单，用它运行的程序设置在注册为Windows服务启动之后会自动停止。研究很久之后才知道，想在Windows上启动服务，还是不能像Linux上那么简单——</p><p>于是尝试结合Topshelf来创建Windows服务，最终成功了。</p><h2 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h2><ol><li>先实现<code>IHostLifetime</code>接口来接管应用程序的生命周期，其实就是用空的实现来替换掉默认的ConsoleLifetime，这样就可以在之后由Topshelf框架内部去管理生命周期。</li></ol><pre class="line-numbers language-cs"><code class="language-cs">    internal class TopshelfLifetime : IHostLifetime    {        public TopshelfLifetime(IApplicationLifetime applicationLifetime, IServiceProvider services)        {            ApplicationLifetime = applicationLifetime ?? throw new ArgumentNullException(nameof(applicationLifetime));        }        private IApplicationLifetime ApplicationLifetime { get; }        public Task WaitForStartAsync(CancellationToken cancellationToken)        {            return Task.CompletedTask;        }        public Task StopAsync(CancellationToken cancellationToken)        {            return Task.CompletedTask;        }    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>然后实现<code>IHostedService</code>接口，把后台任务逻辑写到<code>StartAsync</code>方法中，参见官方文档<a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-2.1#ihostedservice-interface" target="_blank" rel="noopener">《在 ASP.NET Core 中使用托管服务实现后台任务》</a>，本文示例使用定时写入文本到一个文件来测试定时任务是否成功运行。</li></ol><pre class="line-numbers language-cs"><code class="language-cs">    internal class FileWriterService : IHostedService, IDisposable    {        private static string path = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, @"test.txt");        private Timer _timer;        public Task StartAsync(CancellationToken cancellationToken)        {            if (cancellationToken.IsCancellationRequested) return Task.FromCanceled(cancellationToken);            _timer = new Timer(                (e) => WriteTimeToFile(),                null,                TimeSpan.Zero,                TimeSpan.FromSeconds(10));            return Task.CompletedTask;        }        public void WriteTimeToFile()        {            if (!File.Exists(path))            {                using (var sw = File.CreateText(path))                {                    sw.WriteLine(DateTime.Now);                }            }            else            {                using (var sw = File.AppendText(path))                {                    sw.WriteLine(DateTime.Now);                }            }        }        public Task StopAsync(CancellationToken cancellationToken)        {            _timer?.Change(Timeout.Infinite, 0);            return Task.CompletedTask;        }        public void Dispose()        {            _timer?.Dispose();        }    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>构建Generic Host，在<code>ConfigureServices</code>方法中注册<code>TopshelfLifetime</code>，并且注册一个托管服务<code>FileWriterService</code>，就能完成Generic Host的简单构建，当然完整的项目应该还包含配置、日志等等。最后，使用Topshelf来接管Generic Host，创建Windows服务。</li></ol><pre class="line-numbers language-cs"><code class="language-cs">    internal class Program    {        private static void Main(string[] args)        {            var builder = new HostBuilder()                .ConfigureServices((hostContext, services) =>                {                    services.AddSingleton<IHostLifetime, TopshelfLifetime>();                    services.AddHostedService<FileWriterService>();                });            HostFactory.Run(x =>            {                x.SetServiceName("GenericHostWindowsServiceWithTopshelf");                x.SetDisplayName("Topshelf创建的Generic Host服务");                x.SetDescription("运行Topshelf创建的Generic Host服务");                x.Service<IHost>(s =>                {                    s.ConstructUsing(() => builder.Build());                    s.WhenStarted(service =>                    {                        service.Start();                    });                    s.WhenStopped(service =>                    {                        service.StopAsync();                    });                });            });        }    }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>最后发布应用程序，并安装到Windows服务。</li></ol><p>以管理员权限开启终端，执行命令：</p><pre class="line-numbers language-bash"><code class="language-bash">  dotnet publish -c release -r win-x64  <span class="token function">cd</span> path-to-project/bin/release/netcoreapp2.1/win-x64/publish  ./project-name <span class="token function">install</span>  net start GenericHostWindowsServiceWithTopshelf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="/images/generic-host/generic-host-install.png" alt=""></p><p>这样这个Windows服务就启动了！查看输出文件，可以看到定时写入成功，服务也一直没关闭~</p><p><img src="/images/generic-host/generic-host-result.png" alt=""></p><h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><p><a href="https://github.com/ElderJames/GenericHostWindowsServiceWithTopshelf" target="_blank" rel="noopener">https://github.com/ElderJames/GenericHostWindowsServiceWithTopshelf</a></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>官方文档<a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-2.1" target="_blank" rel="noopener">《.NET 通用主机》</a></p><p>官方文档<a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/host/hosted-services?view=aspnetcore-2.1" target="_blank" rel="noopener">《在 ASP.NET Core 中使用托管服务实现后台任务》</a></p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core 中的Ajax全局Antiforgery Token配置</title>
      <link href="/The-Ajax-global-Antiforgery-Token-configuration-in-ASP.NET-Core.html"/>
      <url>/The-Ajax-global-Antiforgery-Token-configuration-in-ASP.NET-Core.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文基于官方文档 <a href="https://docs.microsoft.com/zh-cn/aspnet/core/security/anti-request-forgery?view=aspnetcore-2.1" target="_blank" rel="noopener">《在 ASP.NET Core 防止跨站点请求伪造 (XSRF/CSRF) 攻击》</a>扩展另一种全局配置Antiforgery方法，适用于使用ASP.NET Core Razor + JQuery Ajax的项目，喜欢玩前后端分离的同学可以酌情参考，但希望不要对XSRF/CSRF掉以轻心，更不要不做处理。</p><h1 id="Antiforgery-Token-介绍"><a href="#Antiforgery-Token-介绍" class="headerlink" title="Antiforgery Token 介绍"></a>Antiforgery Token 介绍</h1><p>跨站点请求伪造(XSRF/CSRF)攻击跟浏览器中登录验证之后保存的Cookie有关，恶意站点通过向攻击目标站点发起非法请求时，浏览器按规则是会带上Cookie信息的，此时被攻击站点就会认为是用户操作行为，如果被利用在修改密码等操作上，对用户的信息安全就会带来威胁。为抵御 CSRF 攻击最常用的方法是使用同步器标记模式(STP)。 而Antiforgery Token（防伪令牌）是ASP.NET Core中的STP实现方案。</p><p>STP的防御过程：</p><ol><li>服务器发送到客户端的当前用户的标识相关联的令牌。</li><li>客户端返回将令牌发送到服务器进行验证。</li><li>如果服务器收到与经过身份验证的用户的标识不匹配的令牌，将拒绝请求。</li></ol><p>熟悉ASP.NET和ASP.NET Core的同学应该都不陌生，因为在ASP.NET时期就有防止XSRF攻击的方法，ASP.NET MVC中，IHtmlHelper.BeginForm默认情况下生成防伪令牌，而ASP.NET Core中，使用FormTagHelper默认也会生成防伪令牌的。</p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><h2 id="Form表单提交"><a href="#Form表单提交" class="headerlink" title="Form表单提交"></a>Form表单提交</h2><p>TagHelper用法：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">asp-controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Manage<span class="token punctuation">"</span></span> <span class="token attr-name">asp-action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ChangePassword<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    ...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>HtmlHelper 生成Form的用法：</p><pre class="line-numbers language-cs"><code class="language-cs">@using (Html.BeginForm("ChangePassword", "Manage")){    ...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>普通html form表单用法：</p><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    @Html.AntiForgeryToken()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>那么在Razor渲染之后，表单中就会生成一个隐藏的表单字段：</p><pre class="line-numbers language-html"><code class="language-html">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>__RequestVerificationToken<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>CfDJ8NrAkS ... s2-m9Yw<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="那么Ajax中要怎么处理呢？"><a href="#那么Ajax中要怎么处理呢？" class="headerlink" title="那么Ajax中要怎么处理呢？"></a>那么Ajax中要怎么处理呢？</h2><p>官方文档虽然有提到Ajax的处理方法，但是它指的Ajax是js原生实现<code>XMLHttpRequest</code>，而不是我们一般所认识的<code>JQuery.ajax</code>。所以本文就要介绍一下在使用<code>JQuery.ajax</code>时的全局配置。</p><h3 id="场景一、从普通表单获取Antiforgery-Token"><a href="#场景一、从普通表单获取Antiforgery-Token" class="headerlink" title="场景一、从普通表单获取Antiforgery Token"></a>场景一、从普通表单获取Antiforgery Token</h3><p>这种方法跟上面提到的Form表单提交一致，只要把所生成的隐藏的表单字段也一并提交到服务器即可。</p><pre class="line-numbers language-js"><code class="language-js">$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    url<span class="token punctuation">:</span><span class="token string">"/Manage/ChangePassword"</span><span class="token punctuation">,</span>    type<span class="token punctuation">:</span><span class="token string">"post"</span>    data<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">"__RequestVerificationToken"</span><span class="token punctuation">:</span><span class="token string">"CfDJ8NrAkS ... s2-m9Yw"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是这种方法有个弊端，就是需要配置的东西很多，又要在Contorller中加<code>[ValidateAntiForgeryToken]</code>特性，又要在表单中处理使其生成隐藏字段。</p><p>有没有更方便的方法？当然有！而且即使是文档中号称自动防范 XSRF/CSRF的Razor Pages都同样需要！因为它并没有处理Ajax的场景。</p><h3 id="场景二、全局配置，自动处理"><a href="#场景二、全局配置，自动处理" class="headerlink" title="场景二、全局配置，自动处理"></a>场景二、全局配置，自动处理</h3><h4 id="全局获取Forgery-Token"><a href="#全局获取Forgery-Token" class="headerlink" title="全局获取Forgery Token"></a>全局获取Forgery Token</h4><p>全局（每个页面）获取Forgery Token就是文档中提到的注入<code>Microsoft.AspNetCore.Antiforgery.IAntiforgery</code>并调用<code>GetAndStoreTokens</code>方法，但是由于需要达到全局获取，我需要把这个方法的调用写到布局页,如默认MVC模版的<code>Views/Shared/_Layout.cshtml</code></p><pre class="line-numbers language-aspnet"><code class="language-aspnet">@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf@functions{    public string GetAntiXsrfRequestToken()    {        return Xsrf.GetAndStoreTokens(Context).RequestToken;    }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">    <span class="token keyword">var</span> csrfToken <span class="token operator">=</span> <span class="token string">'@GetAntiXsrfRequestToken()'</span><span class="token punctuation">;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Ajax全局配置"><a href="#Ajax全局配置" class="headerlink" title="Ajax全局配置"></a>Ajax全局配置</h4><p><code>JQuery.ajax</code>里全局设置头部的方法是<code>$.ajaxSetup</code>，按照文档，把所需的头部字段<code>RequestVerificationToken</code>配置上上面获取到的令牌变量<code>csrfToken</code>，即可实现在每个Ajax请求都带有Forgery Token。</p><pre class="line-numbers language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>window<span class="token punctuation">,</span> document<span class="token punctuation">,</span> $<span class="token punctuation">)</span> <span class="token punctuation">{</span>    $<span class="token punctuation">.</span><span class="token function">ajaxSetup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>        headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">'RequestVerificationToken'</span><span class="token punctuation">:</span> csrfToken        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> document<span class="token punctuation">,</span> jQuery<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>虽然现在流行前后端分离了，包括我在内，也用上高大上的React、Angular、Vue等优秀框架，Github前端也把JQuery去掉了，但是Razor在ASP.NET Core中的份量有增无减，2.0版本带来了更轻量的Razor Pages, 因此Razor+JQuery的热度不会那么快退去，希望这篇文章能给大家在Razor+JQuery技术的使用过程中带来一点参考价值。</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
            <tag> JQuery </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>利用.NET Core类库System.Reflection.DispatchProxy实现简易Aop</title>
      <link href="/implement-simple-Aop-using-a-dotnet-core-library-System-Reflection-DispatchProxy.html"/>
      <url>/implement-simple-Aop-using-a-dotnet-core-library-System-Reflection-DispatchProxy.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Aop即是面向切面编程，众多Aop框架里Castle是最为人所知的，另外还有死去的Spring.NET，当然，.NET Core社区新秀AspectCore在性能与功能上都非常优秀，已经逐渐被社区推崇和有越来越多的人使用。感谢柠檬同学的礼物！</p><p>如果大家出于自身需求或者学习，想实现一个Aop，是不是觉得一来就要使用Emit去做？最近我了解到了System.Reflection.DispatchProxy这个corefx类库，已经实现了动态代理功能。</p><p>下面演示一下它的使用方法：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">class</span> <span class="token class-name">Program</span><span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//创建代理类，并把SamepleProxy作为拦截器注入</span>        <span class="token keyword">var</span> samepleProxy <span class="token operator">=</span> <span class="token punctuation">(</span>targetInterface<span class="token punctuation">)</span>SamepleProxy<span class="token punctuation">.</span><span class="token generic-method function">Create<span class="token punctuation">&lt;</span>targetInterface<span class="token punctuation">,</span> SamepleProxy<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//执行接口方法</span>        samepleProxy<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token string">"here is invoke by proxy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//需要被生成代理实例的接口</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">targetInterface</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//这个方法会被代理类实现</span>    <span class="token keyword">void</span> <span class="token function">Write</span><span class="token punctuation">(</span><span class="token keyword">string</span> writesomeshing<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SamepleProxy</span> <span class="token punctuation">:</span> DispatchProxy<span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/// &lt;summary></span>    <span class="token comment" spellcheck="true">/// 拦截调用</span>    <span class="token comment" spellcheck="true">/// &lt;/summary></span>    <span class="token comment" spellcheck="true">/// &lt;param name="method">所拦截的方法信息&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;param name="parameters">所拦截方法被传入的参数指&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">object</span> <span class="token function">Invoke</span><span class="token punctuation">(</span>MethodInfo targetMethod<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>System.Reflection.DispatchProxy</code>只有一个Api，就是<code>objecct Create&lt;T,TProxy&gt;() where TProxy:DispatchProxy</code>,约束了只能传入泛型参数，并不能从方法传入类型，这就会带来很多问题。而更可气的是，给官方提了issue之后，还是不给增加这个api……<br>幸好，在那个issue下，issue作者提供了一个解决方案，就是用反射来构造这个泛型方法。我还在这基础上，封装了一下，加入了传入拦截器实例和传入拦截器构造方法参数的功能。</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">/// &lt;summary></span><span class="token comment" spellcheck="true">/// 拦截器接口</span><span class="token comment" spellcheck="true">/// &lt;/summary></span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IInterceptor</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/// &lt;summary></span>    <span class="token comment" spellcheck="true">/// 拦截器调用</span>    <span class="token comment" spellcheck="true">/// &lt;/summary></span>    <span class="token comment" spellcheck="true">/// &lt;param name="target">代理实例&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;param name="method">所拦截的方法&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;param name="parameters">所拦截方法传入的参数值&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;returns>返回值会传递给方法返回值&lt;/returns>    </span>    <span class="token keyword">object</span> <span class="token function">Intercept</span><span class="token punctuation">(</span><span class="token keyword">object</span> target<span class="token punctuation">,</span> MethodInfo method<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>拦截器要实现这个接口，下面是对DispatchProxy的封装，实现更多创建代理实例的方法</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxyGenerator</span> <span class="token punctuation">:</span> DispatchProxy<span class="token punctuation">{</span>    <span class="token keyword">private</span> IInterceptor interceptor <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">object</span> proxy <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/// &lt;summary></span>    <span class="token comment" spellcheck="true">/// 创建代理实例</span>    <span class="token comment" spellcheck="true">/// &lt;/summary></span>    <span class="token comment" spellcheck="true">/// &lt;param name="targetType">所要代理的接口类型&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;param name="interceptor">拦截器&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;returns>代理实例&lt;/returns></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">object</span> <span class="token function">Create</span><span class="token punctuation">(</span>Type targetType<span class="token punctuation">,</span> IInterceptor interceptor<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">object</span> proxy <span class="token operator">=</span> <span class="token function">GetProxy</span><span class="token punctuation">(</span>targetType<span class="token punctuation">)</span><span class="token punctuation">;</span>        MethodInfo method <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>ProxyGenerator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>CreateInstance<span class="token punctuation">)</span><span class="token punctuation">,</span> BindingFlags<span class="token punctuation">.</span>NonPublic <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>Instance<span class="token punctuation">,</span> Type<span class="token punctuation">.</span>DefaultBinder<span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>IInterceptor<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> interceptor <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/// &lt;summary></span>    <span class="token comment" spellcheck="true">/// 创建代理实例</span>    <span class="token comment" spellcheck="true">/// &lt;/summary></span>    <span class="token comment" spellcheck="true">/// &lt;param name="targetType">所要代理的接口类型&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;param name="interceptorType">拦截器类型&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;param name="parameters">拦截器构造函数参数值&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;returns>代理实例&lt;/returns></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">object</span> <span class="token function">Create</span><span class="token punctuation">(</span>Type targetType<span class="token punctuation">,</span> Type interceptorType<span class="token punctuation">,</span> <span class="token keyword">params</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">object</span> proxy <span class="token operator">=</span> <span class="token function">GetProxy</span><span class="token punctuation">(</span>targetType<span class="token punctuation">)</span><span class="token punctuation">;</span>        MethodInfo method <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>ProxyGenerator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>CreateInstance<span class="token punctuation">)</span><span class="token punctuation">,</span> BindingFlags<span class="token punctuation">.</span>NonPublic <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>Instance<span class="token punctuation">,</span> Type<span class="token punctuation">.</span>DefaultBinder<span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>Type<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> interceptorType<span class="token punctuation">,</span> parameters <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/// &lt;summary></span>    <span class="token comment" spellcheck="true">/// 创建代理实例 TTarget:所要代理的接口类型 TInterceptor:拦截器类型</span>    <span class="token comment" spellcheck="true">/// &lt;/summary></span>    <span class="token comment" spellcheck="true">/// &lt;param name="parameters">拦截器构造函数参数值&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;returns>代理实例&lt;/returns></span>    <span class="token keyword">public</span> <span class="token keyword">static</span> TTarget <span class="token generic-method function">Create<span class="token punctuation">&lt;</span>TTarget<span class="token punctuation">,</span> TInterceptor<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">params</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">)</span> <span class="token keyword">where</span> TInterceptor <span class="token punctuation">:</span> IInterceptor    <span class="token punctuation">{</span>        <span class="token keyword">object</span> proxy <span class="token operator">=</span> <span class="token function">GetProxy</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>TTarget<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        MethodInfo method <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>ProxyGenerator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>CreateInstance<span class="token punctuation">)</span><span class="token punctuation">,</span> BindingFlags<span class="token punctuation">.</span>NonPublic <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>Instance<span class="token punctuation">,</span> Type<span class="token punctuation">.</span>DefaultBinder<span class="token punctuation">,</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>Type<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>TInterceptor<span class="token punctuation">)</span><span class="token punctuation">,</span> parameters <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>TTarget<span class="token punctuation">)</span>proxy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">object</span> <span class="token function">GetProxy</span><span class="token punctuation">(</span>Type targetType<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        MethodInfo method <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>DispatchProxy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>DispatchProxy<span class="token punctuation">.</span>Create<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        method <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">MakeGenericMethod</span><span class="token punctuation">(</span>targetType<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>ProxyGenerator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        proxy <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">CreateInstance</span><span class="token punctuation">(</span>Type interceptorType<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>interceptor <span class="token operator">=</span> <span class="token punctuation">(</span>IInterceptor<span class="token punctuation">)</span>Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>interceptorType<span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">CreateInstance</span><span class="token punctuation">(</span>IInterceptor interceptor<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>interceptor <span class="token operator">=</span> interceptor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">object</span> <span class="token function">Invoke</span><span class="token punctuation">(</span>MethodInfo method<span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameters<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span><span class="token function">Intercept</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用方法：</p><pre class="line-numbers language-CS"><code class="language-CS">class Program{    static void Main(string[] args)    {        // var poxy = (targetInterface)ProxyGenerator.Create(typeof(targetInterface), new SamepleProxy());        // 或        //var poxy = (targetInterface)ProxyGenerator.Create(typeof(targetInterface), typeof(SamepleProxy));        // 或        var poxy = ProxyGenerator.Create<targetInterface, SamepleProxy>();        poxy.Write("here is invoked by coreproxy");    }}public class SamepleProxy : IInterceptor{    public object Intercept(object target, MethodInfo method, object[] parameters)    {        Console.WriteLine(parameters[0]);        return null;    }}public interface targetInterface{    void Write(string writesome);}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>总结一下就是，微软爸爸给我们的这个轮子还是即轻便又很好用的。<br>本文的实例代码可以在我的github上找到：<a href="https://github.com/ElderJames/CoreProxy" target="_blank" rel="noopener">https://github.com/ElderJames/CoreProxy</a></p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>无显示器使用Wifi-VNC启动BerryBoot安装树莓派多系统</title>
      <link href="/boot-the-berryboot-installer-for-raspberry-pi-with-wifi-and-vnc-but-no-screen.html"/>
      <url>/boot-the-berryboot-installer-for-raspberry-pi-with-wifi-and-vnc-but-no-screen.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>网络连接部分参考官方文档：<a href="https://www.berryterminal.com/doku.php/berryboot/headless_installation" target="_blank" rel="noopener">https://www.berryterminal.com/doku.php/berryboot/headless_installation</a></p><p>网络信息中填写与当前用于远程访问树莓派的电脑处在同一局域网，同一个路由器就只是ip不同，掩码和网关都一样。</p><p>VNC下载地址：<a href="https://www.realvnc.com/en/connect/download/viewer/" target="_blank" rel="noopener">https://www.realvnc.com/en/connect/download/viewer/</a> 选择Standalone EXE单文件版本即可。</p><p>VNC中服务器ip填写在树莓派cmdline.txt文件中设置的ip，设置里选择24位颜色。即可访问。</p>]]></content>
      
      
      <categories>
          
          <category> 树莓派 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 树莓派 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>.NET Core 2.1 信任证书</title>
      <link href="/dotnet-dev-certs.html"/>
      <url>/dotnet-dev-certs.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>新安装的.NET Core Sdk 2.1.300，会提示以下信息，信任证书后能使用https访问ASP.NET Core的页面：</p><blockquote><p>已成功安装 ASP.NET Core HTTPS 开发证书。<br>要信任证书(仅限 Windows 和 macOS)，请首先通过运行 “dotnet tool install dotnet-dev-certs -g –version 2.1.0-preview1-final” 安装 dev-certs 工具，然后运行 “dotnet-dev-certs https –trust”。</p></blockquote><p>这是按提示在powershell或者cmd中执行:</p><pre class="line-numbers language-bash"><code class="language-bash">dotnet tool <span class="token function">install</span> dotnet-dev-certs -g --version 2.1.0dotnet-dev-certs https --trust<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> .NET 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Angular组件集成UEditor并支持服务端渲染</title>
      <link href="/Angular-integrating-with-UEditor-and-ssr-supporting.html"/>
      <url>/Angular-integrating-with-UEditor-and-ssr-supporting.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>PS.<a href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D">可以跳过此部分</a></p><p>Angular、React和Vue 被誉为现今最强大的前端三大框架，其中React和Vue在移动端（web、rn）开发方面如鱼得水，而Angular凭借优秀的模块化设计、工程化构建以及强类型语言Typescript加持，在大中型规模的应用开发上相比另外两个框架更能大展拳脚。</p><p>本人作为偏向后端（大部分是.NET）的开发者，对Angular的最主要需求就是中台(管理后台)应用了。随着.NET Core的开源和壮大，它以很快的速度与“现代”技术接轨，比如跨平台特性使得在微服务、容器技术以及DevOps上与其他平台有着平等的地位；更高的性能、更轻的体量使得它有着比一直以此特点著称的Node.js更加有优势……自从了解到ASP.NET Core框架下的JavascriptService项目后，我就一直在关注着他的发展，这是因为它支持了Angular、React和Vue 这类单页应用（single page application, spa）的服务端渲染（server-side rendering, ssr）的特性。服务端渲染主要是在完全支持前后端分离开发的优点的同时，弥补了spa需要在浏览器完全加载后才开始渲染页面导致的首屏加载慢、难以进行SEO优化的缺点。</p><p>所谓服务端渲染，其实并不是什么新技术，就是从服务端渲染出HTML数据返回给浏览器的过程，这在spa应用大行其道之前，随着网页的诞生就发展起来了的。到了现在，.Net、Java、PHP、Node.j、Python等等都有自己的服务端渲染模版框架，技术点也是大同小异，无非就是老掉牙的MVC模式，将后端数据与前端模版一起渲染出HTML代码输送到浏览器上再展示出图文并茂的网页来。</p><p>但是，到了Spa时代，Spa都是把模版、静态文件等都下载到本地后请求服务端数据，再结合模版渲染出html,最后才能在浏览器展示出页面。虽然首屏加载会慢，但通过页面上的内部路由（链接）去跳转页面就很快，因为已经没有了模版加载的过程，只需请求服务器获取小量的数据即可。不过，这样的应用对首屏加载速度和SEO优化要求比较苛刻的产品就无法满足需求了，于是各家都发现还是老技术好，开始了对服务端渲染的支持。其中Angular就有专门的Universal项目来做这方面的支持。</p><p>我一直在关注Angular的支持ssr中台组件库项目，但在差不多两年的时间里，我找遍整个Github的很多组件库项目，都很少有比较完整且支持ssr的，大多数都只是“Demo”、“Starter”类项目。我甚至给几个组件比较完整的项目提了issue，得到的答复大都是由于第三方组件依赖window、document等浏览器特有对象，不予实现。</p><p>没办法，得知Angular 6.0和Material2 6.0发布之际，决定自己来对某个组件库做改造吧！</p><p>早在去年的Angular 4.0版本，Angular Universal项目就组件完善了。还在beta版本的Material组件库也有消息逐步支持了。如今6.0发布，我独钟的Material已经有很漂亮的基本组件了，是时候动手啦！</p><h1 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h1><p>请大家Star一下我两天前才发布的项目<a href="https://github.com/ElderJames/aspnetcore-material-universal" target="_blank" rel="noopener">ElderJames/aspnetcore-material-universal</a></p><p>此项目修改自angular-material-app项目，因为此项目大部分组件都是来自原生的Material组件，所以让它支持SSR会比较方便。</p><p>要支持SSR，就必须不能有对window、document等浏览器对象的引用，否则就会报错无法运行。所以对存在需要引用这些对象的情况，一般会是先判断是否在浏览器环境执行。</p><p>而到了集成功能最完善的富文本编辑器UEditor时遇到了棘手问题，我花了一天时间才算是解决了。</p><h4 id="解决难点1：避免浏览器对象引用"><a href="#解决难点1：避免浏览器对象引用" class="headerlink" title="解决难点1：避免浏览器对象引用"></a>解决难点1：<em>避免浏览器对象引用</em></h4><p>UEditor的js库“日久失修”，本身就不支持模块化，window引用直接暴露在全局环境，也就是一加载就会引用……所以必须对它本身进行修改，在原有代码前加入判断。</p><p>先把js库下载并放在assets（或其他用来放置静态文件的）目录，分别在<a href="https://github.com/ElderJames/aspnetcore-material-universal/blob/master/ClientApp/assets/neditor/neditor.all.js" target="_blank" rel="noopener">neditor.all.js</a>、<a href="https://github.com/ElderJames/aspnetcore-material-universal/blob/master/ClientApp/assets/neditor/neditor.config.js" target="_blank" rel="noopener">neditor.copnfig.js</a>、<a href="https://github.com/ElderJames/aspnetcore-material-universal/blob/master/ClientApp/assets/neditor/i18n/zh-cn/zh-cn.js" target="_blank" rel="noopener">zh-cn.js</a>文件源程序前加入以下代码：</p><pre class="line-numbers language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span>  <span class="token keyword">return</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="解决难点2：模块化引用"><a href="#解决难点2：模块化引用" class="headerlink" title="解决难点2：模块化引用"></a>解决难点2：<em>模块化引用</em></h4><p>UEditor本身的使用方式是在html文件通过<code>&lt;script&gt;</code>标签引入以上3个js文件，然后操作一个由这些文件构造的<strong>UE</strong>对象。而在spa中，还使用<code>&lt;script&gt;</code>方式引入js的话，就会导致js暴露到外部，每个页面都会加载，达不到模块化的要求，所以我们必须用模块化的f方式引入这些文件。没错，就是<code>import</code>关键字。但是import之后，怎么在模块中取得UE对象呢？通过一翻查询，在<code>import</code>前先使用<code>declare</code>关键字声明这个对象，<code>import</code>后就能引用了。如下所示：</p><pre class="line-numbers language-js"><code class="language-js">declare <span class="token keyword">let</span> UE<span class="token punctuation">:</span> any<span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'../../../assets/neditor/neditor.config.js'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'../../../assets/neditor/neditor.all.js'</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token string">'../../../assets/neditor/i18n/zh-cn/zh-cn.js'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意，使用<code>import</code>方式引入js文件的话，内部对静态文件的引入就会错乱，我们需要在UEditor的配置项指定静态资源路径:</p><pre class="line-numbers language-js"><code class="language-js">UEDITOR_HOME_URL<span class="token punctuation">:</span> <span class="token string">'/assets/neditor/'</span>`<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="解决难点3：绑定Dom元素"><a href="#解决难点3：绑定Dom元素" class="headerlink" title="解决难点3：绑定Dom元素"></a>解决难点3：<em>绑定Dom元素</em></h4><p>UEditor的初始化要求传入一个元素的id，来让UEditor能绑定到指定的元素。但是Angular的模板渲染是通过虚拟Dom的方式，显然UEditor无法绑定Dom，只能等虚拟Dom渲染出真实Dom时才能绑定，那么就还要留意Angular渲染相关的生命周期钩子了。</p><p>通过注入ElementRef对象来获取当前模板的真实dom元素：</p><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UEditorComponent</span> <span class="token keyword">implements</span> <span class="token class-name">ControlValueAccessor</span><span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span> OnDestroy <span class="token punctuation">{</span>    isBowser<span class="token punctuation">:</span> <span class="token keyword">boolean</span><span class="token punctuation">;</span>    editor_text<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>    elementRef<span class="token punctuation">:</span> ElementRef<span class="token punctuation">;</span>    <span class="token keyword">constructor</span><span class="token punctuation">(</span>elementRef<span class="token punctuation">:</span> ElementRef<span class="token punctuation">,</span> render<span class="token punctuation">:</span> Renderer2<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>isBowser <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isBowser<span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>elementRef <span class="token operator">=</span> elementRef<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ngOnInit</code>钩子中进行每次组建渲染后的UEditor初始化，<code>ngOnDestroy</code>钩子进行UEditor实例的释放，防止内存泄漏。</p><pre class="line-numbers language-ts"><code class="language-ts">    <span class="token function">ngOnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isBowser<span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'destroy。。。'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ue <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ue<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>isReady <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isBowser<span class="token punctuation">)</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUTCMilliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>elementRef<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>        <span class="token keyword">let</span> con<span class="token punctuation">:</span> <span class="token keyword">any</span> <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ue <span class="token operator">=</span> UE<span class="token punctuation">.</span><span class="token function">getEditor</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> con<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>好了，先写到这里，其他对原js库的Api和事件的导出以及<a href="https://github.com/ElderJames/aspnetcore-material-universal/blob/master/ClientApp/app/forms/ueditor/ueditor.component.ts" target="_blank" rel="noopener">用例</a>已经在<a href="https://github.com/ElderJames/aspnetcore-material-universal/blob/master/ClientApp/app/component/ueditor/ueditor.component.ts" target="_blank" rel="noopener">组件源码</a>中实现，有兴趣可以clone下来看看。相信这次实践能给将来对其他类似的js库的ssr支持集成工作带来有用的经验。</p>]]></content>
      
      
      <categories>
          
          <category> Angular </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Angular </tag>
            
            <tag> Typescript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(转) TinyMCE with SSR and webpack</title>
      <link href="/TinyMCE-with-SSR-and-webpack.html"/>
      <url>/TinyMCE-with-SSR-and-webpack.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><ul><li>custom.d.ts</li></ul><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">NodeRequire</span> <span class="token punctuation">{</span>    ensure<span class="token punctuation">:</span> <span class="token punctuation">(</span>paths<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> callback<span class="token punctuation">:</span> <span class="token punctuation">(</span>require<span class="token punctuation">:</span> NodeRequireFunction<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">void</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>texteditor.component.html</li></ul><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ClientSide; then client else server<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">#client</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>!TinyMCELoaded<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Loading...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">[attr.hidden]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>TinyMCELoaded ? null : <span class="token punctuation">'</span><span class="token punctuation">'</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">(ngSubmit)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>handleSubmit()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{elementId}}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>{{text}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>!Saved<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Don't forget to save!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-template</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-template</span> <span class="token attr-name">#server</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Loading...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-template</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>texteditor.component.ts</li></ul><pre class="line-numbers language-ts"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span>    Component<span class="token punctuation">,</span>    AfterViewInit<span class="token punctuation">,</span>    EventEmitter<span class="token punctuation">,</span>    OnDestroy<span class="token punctuation">,</span>    Input<span class="token punctuation">,</span>    Output<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token keyword">declare</span> <span class="token keyword">const</span> tinymce<span class="token punctuation">:</span> <span class="token keyword">any</span>@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>    selector<span class="token punctuation">:</span> <span class="token string">'text-editor'</span><span class="token punctuation">,</span>    templateUrl<span class="token punctuation">:</span> <span class="token string">'./texteditor.component.html'</span><span class="token punctuation">,</span>    styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./texteditor.component.css'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TextEditorComponent</span> <span class="token keyword">implements</span> <span class="token class-name">AfterViewInit</span><span class="token punctuation">,</span> OnDestroy <span class="token punctuation">{</span>    ClientSide<span class="token punctuation">:</span> <span class="token keyword">boolean</span>    TinyMCELoaded<span class="token punctuation">:</span> <span class="token keyword">boolean</span>    Editor<span class="token punctuation">:</span> <span class="token keyword">any</span>    Saved<span class="token punctuation">:</span> <span class="token keyword">boolean</span>    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> elementId<span class="token punctuation">:</span> <span class="token keyword">string</span>    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> text<span class="token punctuation">:</span> <span class="token keyword">string</span>    @<span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> onSubmit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>    @<span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> onEditorContentChange <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ClientSide <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">'undefined'</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>Saved <span class="token operator">=</span> <span class="token keyword">true</span>    <span class="token punctuation">}</span>    <span class="token function">handleSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>Saved <span class="token operator">=</span> <span class="token keyword">true</span>        <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Editor<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>onSubmit<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ClientSide<span class="token punctuation">)</span> <span class="token punctuation">{</span>            require<span class="token punctuation">.</span><span class="token function">ensure</span><span class="token punctuation">(</span><span class="token punctuation">[</span>                <span class="token string">'tinymce'</span>            <span class="token punctuation">]</span><span class="token punctuation">,</span> require <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tinymce'</span><span class="token punctuation">)</span>                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tinymce/themes/modern'</span><span class="token punctuation">)</span>                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tinymce/plugins/table'</span><span class="token punctuation">)</span>                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tinymce/plugins/link'</span><span class="token punctuation">)</span>                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tinymce/plugins/lists'</span><span class="token punctuation">)</span>                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tinymce/plugins/image'</span><span class="token punctuation">)</span>                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tinymce/plugins/imagetools'</span><span class="token punctuation">)</span>                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tinymce/plugins/save'</span><span class="token punctuation">)</span>                <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'tinymce/plugins/wordcount'</span><span class="token punctuation">)</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>TinyMCELoaded <span class="token operator">=</span> <span class="token keyword">true</span>                tinymce<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>                    selector<span class="token punctuation">:</span> <span class="token string">'#'</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>elementId<span class="token punctuation">,</span>                    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'link'</span><span class="token punctuation">,</span> <span class="token string">'table'</span><span class="token punctuation">,</span> <span class="token string">'lists'</span><span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">,</span> <span class="token string">'imagetools'</span><span class="token punctuation">,</span> <span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token string">'wordcount'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>                    toolbar<span class="token punctuation">:</span> <span class="token string">'undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | save media | codesample help'</span><span class="token punctuation">,</span>                    menubar<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>                    save_onsavecallback<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    skin_url<span class="token punctuation">:</span> <span class="token string">'/assets/tinymce/skins/lightgray'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// Skins is in the wwwroot</span>                    setup<span class="token punctuation">:</span> editor <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span>Editor <span class="token operator">=</span> editor                        editor<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'keyup change undo redo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>                            <span class="token keyword">const</span> content <span class="token operator">=</span> editor<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token keyword">this</span><span class="token punctuation">.</span>Saved <span class="token operator">=</span> <span class="token keyword">false</span>                            <span class="token keyword">this</span><span class="token punctuation">.</span>onEditorContentChange<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>                        <span class="token punctuation">}</span><span class="token punctuation">)</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">ngOnDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ClientSide<span class="token punctuation">)</span> <span class="token punctuation">{</span>            tinymce<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Editor<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script src="https://gist.github.com/OskarKlintrot/8f3b684faeb93f8d2b0946f63b70bd61.js"></script>]]></content>
      
      
      <categories>
          
          <category> Angular </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Angular </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AutoMapper自动注册映射关系配置</title>
      <link href="/AutoMappers-automatic-registration-mapping-relationship-configuration.html"/>
      <url>/AutoMappers-automatic-registration-mapping-relationship-configuration.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>使用以下配置，即可免去AutoMapper每个对象映射关系都需要注册的麻烦。</p><pre class="line-numbers language-csharp"><code class="language-csharp">Mapper<span class="token punctuation">.</span><span class="token function">Initialize</span><span class="token punctuation">(</span>cfg <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    cfg<span class="token punctuation">.</span><span class="token function">ForAllMaps</span><span class="token punctuation">(</span><span class="token punctuation">(</span>typeMap<span class="token punctuation">,</span> mappingExpr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> ignoredPropMaps <span class="token operator">=</span> typeMap<span class="token punctuation">.</span><span class="token function">GetPropertyMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> map <span class="token keyword">in</span> ignoredPropMaps<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">var</span> sourcePropInfo <span class="token operator">=</span> map<span class="token punctuation">.</span>SourceMember <span class="token keyword">as</span> PropertyInfo<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sourcePropInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sourcePropInfo<span class="token punctuation">.</span>PropertyType <span class="token operator">!=</span> map<span class="token punctuation">.</span>DestinationPropertyType<span class="token punctuation">)</span>                map<span class="token punctuation">.</span>Ignored <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        mappingExpr<span class="token punctuation">.</span><span class="token function">ForAllMembers</span><span class="token punctuation">(</span>opt <span class="token operator">=</span><span class="token operator">></span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoredPropMaps<span class="token punctuation">.</span><span class="token function">All</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> opt<span class="token punctuation">.</span>DestinationMember<span class="token punctuation">.</span>Name <span class="token operator">!=</span> p<span class="token punctuation">.</span>SourceMember<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                opt<span class="token punctuation">.</span><span class="token function">Ignore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> .NET 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
            <tag> WebApi </tag>
            
            <tag> MVC </tag>
            
            <tag> AutoMapper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>.Net Core on Linux 操作笔记</title>
      <link href="/net-core-on-linux-operation-note.html"/>
      <url>/net-core-on-linux-operation-note.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本文将记录一些在Linux系统上.NET Core相关操作出问题的解决方法。不定时更新~</p><h2 id="更新sdk后dotnet命令失效："><a href="#更新sdk后dotnet命令失效：" class="headerlink" title="更新sdk后dotnet命令失效："></a>更新sdk后dotnet命令失效：</h2><p>执行以下命令创建软连接</p><p><code>ln -s /usr/share/dotnet/dotnet /usr/bin/dotnet</code></p><hr><h2 id="systemctl-配置示例"><a href="#systemctl-配置示例" class="headerlink" title="systemctl 配置示例"></a>systemctl 配置示例</h2><pre class="line-numbers language-sh"><code class="language-sh"># etc/systemctl/system/xxx.service[Unit]  Description=百银网前台  Documentation=  Wants=network.target  After=network.target  [Service]  User=rootGroup=rootNice=5  KillMode=control-group  SuccessExitStatus=0 1  Environment=ASPNETCORE_ENVIRONMENT=ProductionEnvironment=DOTNET_PRINT_TELEMETRY_MESSAGE=false  Environment=ASPNETCORE_URLS=http://10.116.150.120:1025 #服务url环境变量，应用内没指定时有效NoNewPrivileges=true  PrivateTmp=true  InaccessibleDirectories=/sys /srv -/opt /media -/lost+found  ReadWriteDirectories=/usr/local/nginx/html/jjw_cms_webWorkingDirectory=/usr/local/nginx/html/jjw_cms_webExecStart=/usr/bin/dotnet /usr/local/nginx/html/jjw_cms_web/JJW.CMS.Web.dll #执行命令[Install]  WantedBy=multi-user.target  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动命令</p><p><code>systemctl enable xxx.service</code><br><code>service xxx start</code></p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我的第一块树莓派</title>
      <link href="/my-first-respberry-pi.html"/>
      <url>/my-first-respberry-pi.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="圣诞节前，收到一块树莓派！"><a href="#圣诞节前，收到一块树莓派！" class="headerlink" title="圣诞节前，收到一块树莓派！"></a>圣诞节前，收到一块树莓派！</h1><h1 id="开箱图"><a href="#开箱图" class="headerlink" title="开箱图"></a>开箱图</h1><p><img src="/images/pi/1.png" alt=""></p><p><img src="/images/pi/2.jpg" alt=""></p><p><img src="/images/pi/3.jpg" alt=""></p><p><img src="/images/pi/4.jpg" alt=""></p><p><img src="/images/pi/5.jpg" alt=""></p><p><img src="/images/pi/6.jpg" alt=""></p><p><img src="/images/pi/7.jpg" alt=""></p><h1 id="系统界面"><a href="#系统界面" class="headerlink" title="系统界面"></a>系统界面</h1><p><img src="/images/pi/8.png" alt=""><br>（远程桌面访问桌面）</p><h1 id="起个名字"><a href="#起个名字" class="headerlink" title="起个名字"></a>起个名字</h1><p>外表可爱，内里厉害，就以漫威里的A.I.D.A命名吧！</p><h1 id="计划"><a href="#计划" class="headerlink" title="计划"></a>计划</h1><ol><li>熟悉系统</li><li>借以学习Python</li><li>学习一点硬件知识</li><li>开发成个人助手</li><li>智能家庭、影音和服务托管</li></ol>]]></content>
      
      
      <categories>
          
          <category> 树莓派 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 树莓派 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core 中的SEO优化（4）：自定义视图路径及主题切换</title>
      <link href="/Customized-View-Path-And-Theme-Switching-In-AspNetCore.html"/>
      <url>/Customized-View-Path-And-Theme-Switching-In-AspNetCore.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="系列回顾"><a href="#系列回顾" class="headerlink" title="系列回顾"></a>系列回顾</h2><ul><li><a href="A-Middleware-Implement-For-Server-Side-Static-Caching-In-AspNetCore.html">《ASP.NET Core 中的SEO优化（1）：中间件实现服务端静态化缓存》</a></li><li><a href="A-Middleware-Implement-For-Rendering-Razor-Views-In-AspNetCore.html">《ASP.NET Core 中的SEO优化（2）：中间件中渲染Razor视图》</a></li><li><a href="A-Middleware-Implement-For-Customized-Routing-In-AspNetCore.html">《ASP.NET Core 中的SEO优化（3）:自定义路由匹配和生成》</a></li></ul><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>切换主题，是博客、CMS等系统的必备功能，一般来说，有三种切换主题的需求。</p><ol><li>在管理后台上传主题包，并选择主题</li><li>前端自动按照频道、栏目等切换模版</li><li>用户在前端切换主题，并记录用户的选择</li></ol><p>这三种需求，其实核心原理都是一样，就是制定一套主题的目录，切换主题等于切换目录名。主题内的页面模版都是按照一定的规则存放的。</p><p>下面是两个主题包的目录示例:</p><pre class="line-numbers language-shell"><code class="language-shell">  .  ├── theme0  |   ├── Assets  |   |   ├── js  |   |   ├── css  |   |   └── img  |   ├── Home  |   |   ├── Index.cshtml  |   |   └── About.cshtml  |   ├── Article  |   |   ├── Index.cshtml  |   |   └── Detail.cshtml  |   └── Shared  |       ├── Page.cshtml  |       └──  _Layout.cshtml  └── theme1      ├── Assets      |   ├── js      |   ├── css      |   └── img      ├── Home      |   ├── Index.cshtml      |   └── About.cshtml      ├── Article      |   ├── Index.cshtml      |   └── Detail.cshtml      └── Shared          ├── Page.cshtml          └──  _Layout.cshtml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>  大家一定注意到了，上面每个主题包里都按照传统ASP.NET MVC的约定来划分目录：控制器名为文件夹，操作名为视图文件。其实这里只是方便起见，按照接下来介绍的方法，是可以完全地自定义这个目录划分的。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>当ASP.NET MVC从控制器处理完数据返回视图的时候，ASP.NET MVC会按照默认的多个路径去查找文件，如果文件存在，则使用该文件渲染，如果不存在，则寻找下一个路径，比如默认的路径会有<code>/{Area}/{Controller}/{Action}.cshtml</code>、<code>/{Controller}/{Action}.cshtml</code>、<code>/Shared/{Action}.cshtml</code>等等我们熟悉的约定，那么在查找视图文件时，会安装从左往右的路径去查询，如果都查询不出来，是会报错的。</p><p>而如果要做到切换主题文件夹名来切换主题，我们就需要在默认规则上加主题的目录占位符，使的查询时用主题文件夹名来替换占位符，例如<code>/{theme}/{Controller}/{Action}.cshtml</code>、<code>/{theme}/Shared/{Action}.cshtml</code>等等，这样，当查询视图文件时，就能匹配到对应的主题文件夹，并且找到相应的视图了。</p><p>总结起来，切换主题功能有两个重点需要我们去实现:</p><ol><li>在原有规则中加入占位符</li><li>每次请求都获取当前的主题名，并改变视图查询路径</li></ol><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>最简单的实现，在操作（action）的最后<code>return View(viewPath)</code>时传入视图路径，直接就能指向对应视图，但是，这样做一点都不灵活，而且每个操作都要传路径也是不够简洁，不容易维护，所以我们需要更好的解决方案。</p><h4 id="ASP-NET-MVC-实现"><a href="#ASP-NET-MVC-实现" class="headerlink" title="ASP.NET MVC 实现"></a>ASP.NET MVC 实现</h4><p>在ASP.NET MVC时代，我们可通过继承RazorViewEngine类，在基类的<code>ViewLocationFormats</code>和<code>PartialViewLocationFormats</code>两个属性中加入有主题目录名占位符的路径，并重写<code>CreateView</code>、<code>CreatePartialView</code>、<code>FileExists</code>三个方法，使每次请求都能获取最新的主题名，如下面的例子中从路由数据对象中获取主题名：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TemplateViewEngine</span> <span class="token punctuation">:</span> RazorViewEngine<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">TemplateViewEngine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        ViewLocationFormats <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>            <span class="token string">"~/Views/{1}%1/{0}.cshtml"</span><span class="token punctuation">,</span>            <span class="token string">"~/Views/{1}/{0}.cshtml"</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//默认路径</span>            <span class="token string">"~/Views/Shared%1/{0}.cshtml"</span><span class="token punctuation">,</span>            <span class="token string">"~/Views/Shared/{0}.cshtml"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        PartialViewLocationFormats <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>            <span class="token string">"~/Views/{1}%1/{0}.cshtml"</span><span class="token punctuation">,</span>            <span class="token string">"~/Views/{1}/{0}.cshtml"</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//默认路径</span>            <span class="token string">"~/Views/Shared%1/{0}.cshtml"</span><span class="token punctuation">,</span>            <span class="token string">"~/Views/Shared/{0}.cshtml"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">override</span> IView <span class="token function">CreatePartialView</span><span class="token punctuation">(</span>ControllerContext controllerContext<span class="token punctuation">,</span> <span class="token keyword">string</span> partialPath<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> template <span class="token operator">=</span> controllerContext<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"template"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"/"</span> <span class="token operator">+</span> controllerContext<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"template"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">CreatePartialView</span><span class="token punctuation">(</span>controllerContext<span class="token punctuation">,</span> partialPath<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"%1"</span><span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">override</span> IView <span class="token function">CreateView</span><span class="token punctuation">(</span>ControllerContext controllerContext<span class="token punctuation">,</span> <span class="token keyword">string</span> viewPath<span class="token punctuation">,</span> <span class="token keyword">string</span> masterPath<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> template <span class="token operator">=</span> controllerContext<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"template"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"/"</span> <span class="token operator">+</span> controllerContext<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"template"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">CreateView</span><span class="token punctuation">(</span>controllerContext<span class="token punctuation">,</span> viewPath<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"%1"</span><span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">,</span> masterPath<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">bool</span> <span class="token function">FileExists</span><span class="token punctuation">(</span>ControllerContext controllerContext<span class="token punctuation">,</span> <span class="token keyword">string</span> virtualPath<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> template <span class="token operator">=</span> controllerContext<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"template"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"/"</span> <span class="token operator">+</span> controllerContext<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"template"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">FileExists</span><span class="token punctuation">(</span>controllerContext<span class="token punctuation">,</span> virtualPath<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"%1"</span><span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>事实上，如果是需要实现不同用户不同主题的功能，主题信息可以存储在Session中，还能从<code>controllerContext</code>实例获取<code>Session</code>中存储的主题名。</p><p>那么，在ASP.NET Core中如何实现呢？</p><h4 id="ASP-NET-Core-实现"><a href="#ASP-NET-Core-实现" class="headerlink" title="ASP.NET Core 实现"></a>ASP.NET Core 实现</h4><p>ASP.NET Core 相比ASP.NET MVC框架，虽然使用上为了开发者平滑过渡，很多约定都相同，但是架构本身是做了翻天覆地的重构和优化，得益于一脉相承的MSDI框架，ASP.NET Core框架实现了组件化，很多功能都通过IoC的方式修改或扩展。例如本文介绍的主题情况功能，就是实现<code>IViewLocationExpander</code>接口来达到扩展配置的目的，而且还比ASP.NET MVC的更加简洁：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TemplateViewLocationExpander</span> <span class="token punctuation">:</span> IViewLocationExpander<span class="token punctuation">{</span>    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> <span class="token function">ExpandViewLocations</span><span class="token punctuation">(</span>ViewLocationExpanderContext context<span class="token punctuation">,</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> viewLocations<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> template <span class="token operator">=</span> context<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"template"</span><span class="token punctuation">]</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">"Default"</span><span class="token punctuation">;</span>        <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> locations <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"/Views/"</span> <span class="token operator">+</span> template <span class="token operator">+</span> <span class="token string">"/{1}/{0}.cshtml"</span><span class="token punctuation">,</span> <span class="token string">"/Views/"</span> <span class="token operator">+</span> template <span class="token operator">+</span> <span class="token string">"/{0}.cshtml"</span><span class="token punctuation">,</span> <span class="token string">"/Views/"</span> <span class="token operator">+</span> template <span class="token operator">+</span> <span class="token string">"/Shared/{0}.cshtml"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> locations<span class="token punctuation">.</span><span class="token function">Union</span><span class="token punctuation">(</span>viewLocations<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">PopulateValues</span><span class="token punctuation">(</span>ViewLocationExpanderContext context<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        context<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"template"</span><span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">.</span>ActionContext<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"Template"</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span> <span class="token string">"Default"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这个接口里面，<code>PopulateValues</code>方法主要用来获取实时的主题信息，<code>context.ActionContext</code>中除了<code>RouteData</code>可获得实时数据，还有<code>HttpContext</code>实例可获得用户信息，甚至能利用<code>RequestServices</code>实例注入服务。而只有在<code>PopulateValues</code>中修改了<code>context</code>，<code>ExpandViewLocations</code>方法才会从<code>context</code>中获得主题信息，从而达到修改视图查找路径的目的。</p><p>当我们实现了<code>IViewLocationExpander</code>接口后，还需要在<code>Startup</code>类的<code>services.AddMvc();</code>下修改MVC的配置:</p><pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//配置模版视图路径</span>services<span class="token punctuation">.</span><span class="token generic-method function">Configure<span class="token punctuation">&lt;</span>RazorViewEngineOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    options<span class="token punctuation">.</span>ViewLocationExpanders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TemplateViewLocationExpander</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><em>PS:这种修改MVC内部配置的方式很有趣，以后有空会研究一番。</em></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要介绍了在ASP.NET Core中利用修改视图查询路径实现主题切换的功能，虽然只介绍了核心部分，但是其它部分如管理主题、前端切换等功能，都是很容易实现的，以后我会在我的框架样例中实现，敬请大家关注啦！</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core 中的SEO优化（3）:自定义路由匹配和生成</title>
      <link href="/A-Middleware-Implement-For-Customized-Routing-In-AspNetCore.html"/>
      <url>/A-Middleware-Implement-For-Customized-Routing-In-AspNetCore.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前两篇文章主要总结了CMS系统两个技术点在<strong>ASP.NET Core</strong>中的应用：</p><ul><li><a href="A-Middleware-Implement-For-Server-Side-Static-Caching-In-AspNetCore.html">《ASP.NET Core 中的SEO优化（1）：中间件实现服务端静态化缓存》</a></li><li><a href="A-Middleware-Implement-For-Rendering-Razor-Views-In-AspNetCore.html">《ASP.NET Core 中的SEO优化（2）：中间件中渲染Razor视图》</a></li></ul><p>而本篇文章，继续介绍另一个技术点：自定义路由匹配和生成。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在MVC5时代，默认的路由可能就是简单的约定<code>/{controller}/{action}/{id}</code>,第一节对应控制器（Controller）名，第二节对应操作（Action）名,第三节是参数名。<br>在WebApi和ASP.NET Core时代，有了<code>Route</code>特性来指定相应操作的路由指向，可以很灵活地配置RESTful Api。</p><p>但是，路由灵活性在注重SEO的CMS系统中有更苛刻的要求。例如：</p><ul><li>栏目的列表 -&gt;<code>/{父栏目名}/{子栏目名}-{页码}/</code></li><li>文章详情页 -&gt;<code>/{栏目名}/{文章名}.html</code></li><li>标签页 -&gt;<code>/{标签名}</code></li></ul><p>这些友好的url链接使用默认的路由约定是很难实现的，当然是可以配置路由规则去传递参数：</p><pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseMvc</span><span class="token punctuation">(</span>routes <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    routes<span class="token punctuation">.</span><span class="token function">MapRoute</span><span class="token punctuation">(</span>        name<span class="token punctuation">:</span> <span class="token string">"article_list"</span><span class="token punctuation">,</span>        template<span class="token punctuation">:</span> <span class="token string">"{parentCategory}/{category}-{page}/"</span><span class="token punctuation">,</span>        defaults<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> controller <span class="token operator">=</span> <span class="token string">"Article"</span><span class="token punctuation">,</span> action <span class="token operator">=</span> <span class="token string">"Index"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    routes<span class="token punctuation">.</span><span class="token function">MapRoute</span><span class="token punctuation">(</span>        name<span class="token punctuation">:</span> <span class="token string">"article_detail"</span><span class="token punctuation">,</span>        template<span class="token punctuation">:</span> <span class="token string">"{category}/{article}.html"</span><span class="token punctuation">,</span>        defaults<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> controller <span class="token operator">=</span> <span class="token string">"Article"</span><span class="token punctuation">,</span> action <span class="token operator">=</span> <span class="token string">"Detail"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    routes<span class="token punctuation">.</span><span class="token function">MapRoute</span><span class="token punctuation">(</span>        name<span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token punctuation">,</span>        template<span class="token punctuation">:</span> <span class="token string">"{tag}/"</span><span class="token punctuation">,</span>        defaults<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> controller <span class="token operator">=</span> <span class="token string">"Article"</span><span class="token punctuation">,</span> action <span class="token operator">=</span> <span class="token string">"Tag"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但是，这样配置很繁琐，也不灵活，如果还要传入更多规则，比如不向下匹配，就显得捉襟见肘了。那有没有更灵活的方案呢？当然有，就是本文接下来要介绍的IRouter接口。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>上一节最后介绍的一般路由配置方法，其实是<code>MapRoute</code>方法创建一个个<code>IRouter</code>的实例，添加到<code>IRouteBuilder</code>实例中，具体方法可以<a href="https://github.com/aspnet/Routing/blob/032bcf43b2cefe641fc6ee9ef3ab0769024a182c/src/Microsoft.AspNetCore.Routing/MapRouteRouteBuilderExtensions.cs#L97" target="_blank" rel="noopener">看看源码</a>。</p><p>所以我们可以实现一个自定义的<code>IRouter</code>，就能不用默认的约定，去实现我们的苛刻需求。</p><p>首先要看看<code>IRouter</code>这个接口的定义，源码在<a href="https://github.com/aspnet/Routing/blob/032bcf43b2cefe641fc6ee9ef3ab0769024a182c/src/Microsoft.AspNetCore.Routing.Abstractions/IRouter.cs" target="_blank" rel="noopener"><code>aspnet/Routing/src/Microsoft.AspNetCore.Routing.Abstractions/IRouter.cs</code></a></p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Routing<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRouter</span>    <span class="token punctuation">{</span>        Task <span class="token function">RouteAsync</span><span class="token punctuation">(</span>RouteContext context<span class="token punctuation">)</span><span class="token punctuation">;</span>        VirtualPathData <span class="token function">GetVirtualPath</span><span class="token punctuation">(</span>VirtualPathContext context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p><code>IRouter</code>接口只有两个方法，本文分别给出代码示例来介绍。</p><h3 id="RouteAsync"><a href="#RouteAsync" class="headerlink" title="RouteAsync"></a><code>RouteAsync</code></h3><p>这个方法中实现路由匹配，从路由上下文中获取所需要的数据，存入RouteData字典中，再从控制器取出做相应的处理。</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">RouteAsync</span><span class="token punctuation">(</span>RouteContext context<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> requestedUrl <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">TrimStart</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> split <span class="token operator">=</span> requestedUrl<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>secoend <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> secoend<span class="token punctuation">.</span><span class="token function">EndsWith</span><span class="token punctuation">(</span><span class="token string">".html"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> split<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> title <span class="token operator">=</span> secoend<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">".html"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"controller"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Article"</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"action"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Detail"</span><span class="token punctuation">;</span>        context<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"category"</span><span class="token punctuation">]</span> <span class="token operator">=</span> first<span class="token punctuation">;</span>        context<span class="token punctuation">.</span>RouteData<span class="token punctuation">.</span>Values<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span> <span class="token operator">=</span> title<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//...对请求路径进行一系列的判断</span>    <span class="token comment" spellcheck="true">//最后注入`MvcRouteHandler`示例执行`RouteAsync`方法，表示匹配成功</span>    <span class="token keyword">await</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>MvcRouteHandler<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RouteAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样，当请求路由为<code>/news/asp.net.html</code>时，就会匹配到上面的规则，请求进入<code>Article</code>控制器中的<code>Detail</code>操作被处理，并且可以从控制器中的<code>RouteData.Values[&quot;category&quot;]?.ToString();</code>方法拿到所需的数据。</p><h3 id="GetVirtualPath"><a href="#GetVirtualPath" class="headerlink" title="GetVirtualPath"></a><code>GetVirtualPath</code></h3><p>这个方法实现路由生成，可以从路由上下文中获取RouteData字典中的数据，进行虚拟路径（区别与真实目录）的生成。</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> VirtualPathData <span class="token function">GetVirtualPath</span><span class="token punctuation">(</span>VirtualPathContext context<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>    <span class="token keyword">var</span> hasController <span class="token operator">=</span> context<span class="token punctuation">.</span>Values<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token string">"controller"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token keyword">var</span> controller<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> hasAction <span class="token operator">=</span> context<span class="token punctuation">.</span>Values<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token string">"action"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token keyword">var</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> hasCategory <span class="token operator">=</span> context<span class="token punctuation">.</span>Values<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token string">"category"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token keyword">var</span> category<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> hasTitle <span class="token operator">=</span> context<span class="token punctuation">.</span>Values<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token keyword">var</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasController <span class="token operator">&amp;&amp;</span> hasAction <span class="token operator">&amp;&amp;</span> hasCategory <span class="token operator">&amp;&amp;</span> hasTitle<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        path <span class="token operator">=</span> $<span class="token string">"/{category/{title}.html"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> path <span class="token operator">!=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">VirtualPathData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样，当调用路径生成方法<code>@Url.Action(&quot;Detail&quot;,&quot;Article&quot;,new { title=&quot;asp.net&quot;, category=&quot;news&quot; })</code>,就会生成”/news/asp.net.html”这样的路径来。</p><h3 id="IRouter的设置生效"><a href="#IRouter的设置生效" class="headerlink" title="IRouter的设置生效"></a>IRouter的设置生效</h3><p>自定义实现的<code>IRouter</code>如何设置到原有的MVC项目中呢？方法很简单，上面已经简单说道了，其实<code>app.UseMvc</code>这个方法就有添加<code>IRouter</code>的方法:</p><pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseMvc</span><span class="token punctuation">(</span>routes <span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//添加 自定义路由匹配与url生成组件</span>    routes<span class="token punctuation">.</span>Routes<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RouteProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里<code>RouteProvider</code>是<code>IRouter</code>的实现，这样自定义的路由提供对象就生效啦！</p><h2 id="相关小技巧"><a href="#相关小技巧" class="headerlink" title="相关小技巧"></a>相关小技巧</h2><ol><li><p>SEO中会有一条铁规则，就是不是有效链接的情况下只能返回404，比如，手动输入了一个路径，能匹配到文章详情的操作（action），如果数据库中查不出文章，本来应该不能匹配的，但是，如果在匹配的时候查询数据库确认是否存在的话，会加大系统的压力，所以，可以放在操作（action）中查询，查不到再返回<code>NotFound</code>，让上一篇文章<a href="A-Middleware-Implement-For-Rendering-Razor-Views-In-AspNetCore">《ASP.NET Core 中的SEO优化（2）：中间件中渲染Razor视图》</a>中介绍的中间件一并处理输出404页面。</p></li><li><p>站内链接如果使用带域名的绝对路径，能够提高优化效果，我们可以自己写一个<code>UrlHelper</code>的扩展方法:</p></li></ol><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">UrlHelperExtensions</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">string</span> <span class="token function">AbsoluteAction</span><span class="token punctuation">(</span>        <span class="token keyword">this</span> IUrlHelper helper<span class="token punctuation">,</span>        <span class="token keyword">string</span> actionName<span class="token punctuation">,</span>        <span class="token keyword">string</span> controllerName<span class="token punctuation">,</span>        <span class="token keyword">object</span> routeValues <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">string</span> scheme <span class="token operator">=</span> helper<span class="token punctuation">.</span>ActionContext<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Scheme<span class="token punctuation">;</span>        <span class="token keyword">return</span> helper<span class="token punctuation">.</span><span class="token function">Action</span><span class="token punctuation">(</span>actionName<span class="token punctuation">,</span> controllerName<span class="token punctuation">,</span> routeValues<span class="token punctuation">,</span> scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">string</span> <span class="token function">AbsoluteContent</span><span class="token punctuation">(</span>        <span class="token keyword">this</span> IUrlHelper helper<span class="token punctuation">,</span>        <span class="token keyword">string</span> contentPath<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Uri</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>ActionContext<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">GetUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> helper<span class="token punctuation">.</span><span class="token function">Content</span><span class="token punctuation">(</span>contentPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">string</span> <span class="token function">AbsoluteRouteUrl</span><span class="token punctuation">(</span>        <span class="token keyword">this</span> IUrlHelper helper<span class="token punctuation">,</span>        <span class="token keyword">string</span> routeName<span class="token punctuation">,</span>        <span class="token keyword">object</span> routeValues <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">string</span> scheme <span class="token operator">=</span> helper<span class="token punctuation">.</span>ActionContext<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Scheme<span class="token punctuation">;</span>        <span class="token keyword">return</span> helper<span class="token punctuation">.</span><span class="token function">RouteUrl</span><span class="token punctuation">(</span>routeName<span class="token punctuation">,</span> routeValues<span class="token punctuation">,</span> scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要介绍了自定义路由匹配和生成的解决方案，把路由相关的处理集中到一个类中，避免分散在各个视图进行维护。下篇文章，将会介绍自定义视图搜索目录及主题切换。</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core 中的SEO优化（2）：中间件中渲染Razor视图</title>
      <link href="/A-Middleware-Implement-For-Rendering-Razor-Views-In-AspNetCore.html"/>
      <url>/A-Middleware-Implement-For-Rendering-Razor-Views-In-AspNetCore.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一篇文章<a href="A-Middleware-Implement-For-Server-Side-Static-Caching-In-AspNetCore.html">《ASP.NET Core 中的SEO优化（1）：中间件实现服务端静态化缓存》</a>中介绍了中间件的使用方法、以及使用中间件实现服务端静态化缓存的功能。本系列文章的这些技巧都是我最近在做的公司实际项目中的一些奇怪的需求之后总结而来的……</p><h2 id="要解决的问题"><a href="#要解决的问题" class="headerlink" title="要解决的问题"></a>要解决的问题</h2><p>好了，本篇说说如何在中间件中渲染Razor视图。之所以会有这个技巧，是因为我们有个需求：</p><blockquote><p>需要在所有返回404状态的路由都输出一个特定视图。<br>比如当有id=1的文章，而没有id=2的文章时，那么<code>/url/1.html</code>展示文章详情页，<code>/url/2.html</code>展示404视图。</p></blockquote><p>所以，要实现这个需求只有两种办法：</p><blockquote><ol><li>当文章查找不到时直接执行<code>return View(&quot;404&quot;)</code>返回404视图。</li><li>在中间件中执行完MVC的处理之后检查返回状态，如果是错误状态就直接渲染视图并输出。</li></ol></blockquote><p>由于CMS系统中不止一处需要返回404状态，所以因为用代码整洁作为懒惰的借口，决定尝试第二个方法。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>实现方式很简单，就是在Configure中注入ICompositeViewEngine实例，构造视图上下文，再渲染视图为字符串，最后输出。其它的分析就在代码注释中说明吧。</p><p>直接上代码：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">,</span> IHostingEnvironment env<span class="token punctuation">,</span> ICompositeViewEngine engine<span class="token punctuation">)</span><span class="token punctuation">{</span>    app<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//因为只是在请求最后处理，所以这里直接就运行下一个中间件</span>        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//返回后检查是否出现错误的状态</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">>=</span> <span class="token number">400</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>HttpStatusCode<span class="token punctuation">.</span>NotFound<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//ContentType设置为text/html，使浏览器以正常页面的格式显示</span>            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"text/html"</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//指向特定的视图</span>            <span class="token keyword">var</span> viewResult <span class="token operator">=</span> engine<span class="token punctuation">.</span><span class="token function">GetView</span><span class="token punctuation">(</span><span class="token string">"~/"</span><span class="token punctuation">,</span> <span class="token string">"~/Views/Default/Home/Error.cshtml"</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>viewResult<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>                <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"OMG! 连错误视图都找不到了。。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//创建临时的StringWriter实例，用来配置到视图上下文中</span>            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> output <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//视图上下文对于视图渲染来说很重要，视图中的前后台交互都需要它</span>                <span class="token keyword">var</span> viewContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    HttpContext <span class="token operator">=</span> context<span class="token punctuation">,</span>                    Writer <span class="token operator">=</span> output<span class="token punctuation">,</span>                    RouteData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Routing<span class="token punctuation">.</span>RouteData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">//RouteData在这里传入视图，这样视图可以显示错误信息之类的数据</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span>                    View <span class="token operator">=</span> viewResult<span class="token punctuation">.</span>View<span class="token punctuation">,</span>                    FormContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                    ActionDescriptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc<span class="token punctuation">.</span>Abstractions<span class="token punctuation">.</span>ActionDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//渲染</span>                <span class="token keyword">await</span> viewResult<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">RenderAsync</span><span class="token punctuation">(</span>viewContext<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//输出到响应体</span>                <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>output<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//后面是Mvc的中间件，执行Mvc的处理</span>    <span class="token comment" spellcheck="true">//...app.UseMvc</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个技巧还能用于单页面应用程序的路由重定向，把所有路由都输出入口页面代码。</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core 中的SEO优化（1）：中间件实现服务端静态化缓存</title>
      <link href="/A-Middleware-Implement-For-Server-Side-Static-Caching-In-AspNetCore.html"/>
      <url>/A-Middleware-Implement-For-Server-Side-Static-Caching-In-AspNetCore.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="分享"><a href="#分享" class="headerlink" title="分享"></a>分享</h2><p>最近在公司成功落地了一个用ASP.NET Core 开发前台的CMS项目，虽然对于表层的开发是兼容MVC5的，但是作为爱好者当然要用尽量多的ASP.NET Core新功能了。</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在项目开发的过程中，为了满足需求，还是有许多功能要自己“发明”，也就是已有技术的组(qi)合ji)运(yin)用(qiao)。本例先讲讲如果用中间件开发所有CMS都需要的服务端静态缓存方法。</p><p>CMS系统的一大痛点是一个页面要查询的内容很多，所以常常为了减轻服务器压力，都会使用到各种缓存技术。比如静态文件的CDN缓存、客户端缓存、还有就是服务端静态化缓存。</p><p>服务端静态化缓存在这里指的是把页面事先生成出来保存为静态文件，当用户请求服务器时，可以直接把页面输出给用户，而不再进行查询数据库之类的操作，已达到提高响应速度、减轻服务器压力的效果。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>由于服务端静态化缓存的实现核心是需要拦截请求并且直接返回HTML内容，在MVC5时代，我们可以用过滤器（Filter）来处理，类似如下代码：</p><pre class="line-numbers language-csharp"><code class="language-csharp">    <span class="token punctuation">[</span><span class="token function">AttributeUsage</span><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>Class <span class="token operator">|</span> AttributeTargets<span class="token punctuation">.</span>Method<span class="token punctuation">,</span> AllowMultiple <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> Inherited <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StaticFileHandlerFilterAttribute</span> <span class="token punctuation">:</span> ActionFilterAttribute    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/// &lt;summary></span>        <span class="token comment" spellcheck="true">/// 过期时间，以小时为单位</span>        <span class="token comment" spellcheck="true">/// &lt;/summary></span>        <span class="token keyword">public</span> <span class="token keyword">int</span> Expiration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnResultExecuted</span><span class="token punctuation">(</span>ResultExecutedContext filterContext<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">var</span> actionResult <span class="token operator">=</span> filterContext<span class="token punctuation">.</span>Result<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>actionResult <span class="token keyword">is</span> ViewResult<span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token keyword">var</span> fileInfo <span class="token operator">=</span> <span class="token function">GetFileInfo</span><span class="token punctuation">(</span>filterContext<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>Exists <span class="token operator">&amp;&amp;</span> fileInfo<span class="token punctuation">.</span>CreationTime<span class="token punctuation">.</span><span class="token function">AddHours</span><span class="token punctuation">(</span>Expiration <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> Expiration<span class="token punctuation">)</span> <span class="token operator">></span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>Exists<span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    fileInfo<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">using</span> <span class="token punctuation">(</span>FileStream fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileStream</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>FullName<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>CreateNew<span class="token punctuation">,</span> FileAccess<span class="token punctuation">.</span>Write<span class="token punctuation">,</span> FileShare<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    <span class="token keyword">using</span> <span class="token punctuation">(</span>StreamWriter sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamWriter</span><span class="token punctuation">(</span>fs<span class="token punctuation">,</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        <span class="token keyword">var</span> viewResult <span class="token operator">=</span> actionResult <span class="token keyword">as</span> ViewResult<span class="token punctuation">;</span>                        <span class="token keyword">var</span> viewContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewContext</span><span class="token punctuation">(</span>filterContext<span class="token punctuation">.</span>Controller<span class="token punctuation">.</span>ControllerContext<span class="token punctuation">,</span> viewResult<span class="token punctuation">.</span>View<span class="token punctuation">,</span> viewResult<span class="token punctuation">.</span>ViewData<span class="token punctuation">,</span> viewResult<span class="token punctuation">.</span>TempData<span class="token punctuation">,</span> sw<span class="token punctuation">)</span><span class="token punctuation">;</span>                        viewResult<span class="token punctuation">.</span>View<span class="token punctuation">.</span><span class="token function">Render</span><span class="token punctuation">(</span>viewContext<span class="token punctuation">,</span> sw<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnActionExecuting</span><span class="token punctuation">(</span>ActionExecutingContext filterContext<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">var</span> fileInfo <span class="token operator">=</span> <span class="token function">GetFileInfo</span><span class="token punctuation">(</span>filterContext<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>Exists<span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token keyword">using</span> <span class="token punctuation">(</span>FileStream fs <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>FullName<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Open<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    <span class="token keyword">using</span> <span class="token punctuation">(</span>StreamReader sr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamReader</span><span class="token punctuation">(</span>fs<span class="token punctuation">,</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        ContentResult contentresult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContentResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        contentresult<span class="token punctuation">.</span>Content <span class="token operator">=</span> sr<span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        contentresult<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"text/html"</span><span class="token punctuation">;</span>                        filterContext<span class="token punctuation">.</span>Result <span class="token operator">=</span> contentresult<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而在ASP.NET Core中，我们也可以在Filte中实现，但是，更方便、更牛、更快的方式就是在中间件中实现了。</p><p><img src="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/_static/request-delegate-pipeline.png" alt="中间件示意图"></p><p>中间件运行在请求管道中，个人理解是可以看成是一个递归方法，只不过是调用不同的中间件，中间件中调用下一个中间件、知道最后一个执行完成，会沿路返回上一个中间件……说得可能不清楚，但是看代码和调试一下就能明白了。下面用代码层错误拦截的中间件作为一个中间件生命周期的示例：</p><pre class="line-numbers language-csharp"><code class="language-csharp">    app<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>    <span class="token punctuation">{</span>        <span class="token keyword">try</span>        <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//执行下一个中间件前执行的代码</span>            <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//上一个中间件执行后执行</span>        <span class="token punctuation">}</span>        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//执行完后会继续执行上一个中间件next委托之后的语句</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>中间件是写在Startup.cs文件的<code>Configure</code>方法中，以<code>app.Use()</code>方法的执行顺序添加中间件，然后会从上往下运行，遇到<code>next</code>委托就会跳入下一个中间件，不执行<code>next</code>委托就会返回上一个中间件。</p><p>好了，关于中间件的具体介绍可以看<a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware?tabs=aspnetcore2x" target="_blank" rel="noopener">官方文档</a></p><h2 id="实现服务端静态化缓存中间件"><a href="#实现服务端静态化缓存中间件" class="headerlink" title="实现服务端静态化缓存中间件"></a>实现服务端静态化缓存中间件</h2><p>下面介绍思路，实现静态化缓存的核心是需要<strong>从请求响应中获取内容，并且转换为字符串保存到文件中</strong>。</p><p>这个功能点用以下代码和注释进行讲解：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">//获取响应体的引用</span><span class="token keyword">var</span> originalBody <span class="token operator">=</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Body<span class="token punctuation">;</span><span class="token keyword">try</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//因为响应体实例是只读的，需要创建一个内存流实例，用来获取响应流内容</span>    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> memStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//把内存流的引用设置到Response.Body，假装是真的响应体接收数据</span>        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Body <span class="token operator">=</span> memStream<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//然后执行下一个中间件，等待有响应返回</span>        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//需要判断响应是否正确，总不能把不正确的内容缓存起来吧</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>HttpStatusCode<span class="token punctuation">.</span>OK<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//检测文件存放目录</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Directory<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>                Directory<span class="token punctuation">.</span><span class="token function">CreateDirectory</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//把内存流的当前操作位置设为0，因为响应写入的过程中位置会在末尾。</span>            memStream<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//读取内存流的内容，转换为字符串</span>            <span class="token keyword">var</span> responseBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamReader</span><span class="token punctuation">(</span>memStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//把字符串写入文件，这里还稍微压缩了一下</span>            <span class="token keyword">await</span> File<span class="token punctuation">.</span><span class="token function">WriteAllTextAsync</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> Regex<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">,</span> <span class="token string">"\\n+\\s+"</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//在此把内存流的当前操作位置设为0</span>            memStream<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//还需要把流复制到之前引用的响应体实例</span>            <span class="token keyword">await</span> memStream<span class="token punctuation">.</span><span class="token function">CopyToAsync</span><span class="token punctuation">(</span>originalBody<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//把响应体实例引用重新设置到响应体</span>    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Body <span class="token operator">=</span> originalBody<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>好了，这样响应的内容终于可以缓存起来了，下次请求直接把静态文件输出就是了。但是，好像还有问题：</p><blockquote><ol><li>如何对特定的请求的url做缓存；</li><li>如何设置过期时间。</li></ol></blockquote><p>解决这两个问题的关键就在文件名上了，对于第一点很容易理解，直接把url作为文件名不就完了。没错，但是要注意特殊字符的问题，我这里就用md5处理一下了，这样相同的请求url就会返回相同的静态文件里的内容。</p><p>但是网站要更新，不能永久都是一样的数据呀，这时就需要设置缓存时间了。这里又会产生两个问题：</p><blockquote><ol><li>如何在文件上标识产生缓存时的时间；</li><li>如何判断时间是否超时。</li></ol></blockquote><p>针对这两个问题，我也考虑了很久，总是觉得直接在文件名上记录缓存时间和判断超时就好了,这也有两种方法：</p><blockquote><ol><li>读取文件名上的时间，与当前时间比对；</li><li>在超时时间内都能产生相同的文件名，判断是否存在这个文件。</li></ol></blockquote><p>从代码简洁的考虑上，我选择挑战难度大一点的第二个方法。那么如何使程序在超时时间内都产生相同的文件名呢？其实只需要实现一个算法，在一段时间内产生的时间对象都是相同的时间，忽略中间的时间变化。这个是不是很像小学数学求近似数里的去尾法?或者我们经常用到的<code>&quot;/&quot;</code>运算符，会吧小数点去掉。而在本例中，实现利用整除发忽略一段时间中的时间变化，生成同一个时间的算法和代码如下：</p><pre class="line-numbers language-csharp"><code class="language-csharp">       <span class="token keyword">var</span> timeTicks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Ticks <span class="token operator">/</span> <span class="token number">10000000</span> <span class="token operator">/</span> expire <span class="token operator">*</span> <span class="token number">10000000</span> <span class="token operator">*</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>哈哈，只要一行代码,整除去掉多余的时间再乘回来构造一段时间内不变的时间。其实运行一下可以发现，如果超时时间设置成60秒，那么单位秒上的值会变成00。设置为3600秒，那么分秒两个单位都是0，因此会有一个弊端，真正缓存的时间很可能比设置的值短的，这个要看需求的容忍度啦！</p><p>就这样，问题一个个被解决，下面给出完整的中间件代码：</p><pre class="line-numbers language-csharp"><code class="language-csharp">    <span class="token keyword">var</span> hasExpire <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">[</span><span class="token string">"html_cache_expire_time"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token keyword">var</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasExpire <span class="token operator">&amp;&amp;</span> expire <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//文件缓存</span>        app<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>        <span class="token punctuation">{</span>            <span class="token keyword">var</span> url <span class="token operator">=</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> th <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MD5CryptoServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> data <span class="token operator">=</span> th<span class="token punctuation">.</span><span class="token function">ComputeHash</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>Unicode<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> key <span class="token operator">=</span> Convert<span class="token punctuation">.</span><span class="token function">ToBase64String</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> Base64FormattingOptions<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> path <span class="token operator">=</span> HttpUtility<span class="token punctuation">.</span><span class="token function">UrlEncode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> timeTicks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Ticks <span class="token operator">/</span> <span class="token number">10000000</span> <span class="token operator">/</span> expire <span class="token operator">*</span> <span class="token number">10000000</span> <span class="token operator">*</span> expire<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">const</span> <span class="token keyword">string</span> filePath <span class="token operator">=</span> <span class="token string">"static/cache/"</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> fileName <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> timeTicks<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"yyyyMMddHHmmss"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".html"</span><span class="token punctuation">;</span>            <span class="token keyword">var</span> fullPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">SendFileAsync</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">else</span>            <span class="token punctuation">{</span>                <span class="token keyword">var</span> originalBody <span class="token operator">=</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Body<span class="token punctuation">;</span>                <span class="token keyword">try</span>                <span class="token punctuation">{</span>                    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> memStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Body <span class="token operator">=</span> memStream<span class="token punctuation">;</span>                        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>HttpStatusCode<span class="token punctuation">.</span>OK<span class="token punctuation">)</span>                        <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Directory<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span>                                Directory<span class="token punctuation">.</span><span class="token function">CreateDirectory</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>                            memStream<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                            <span class="token keyword">var</span> responseBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamReader</span><span class="token punctuation">(</span>memStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">await</span> File<span class="token punctuation">.</span><span class="token function">WriteAllTextAsync</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> Regex<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">,</span> <span class="token string">"\\n+\\s+"</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            memStream<span class="token punctuation">.</span>Position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                            <span class="token keyword">await</span> memStream<span class="token punctuation">.</span><span class="token function">CopyToAsync</span><span class="token punctuation">(</span>originalBody<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                <span class="token keyword">finally</span>                <span class="token punctuation">{</span>                    context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Body <span class="token operator">=</span> originalBody<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>其实这个中间件还是有很多改进的地方，比如定义一套规则来给不同页面设置不同的超时时间，这样有的需要实时更新的内容就可以被区分开，而基本不变的内容就可以一直使用缓存。</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows 10 上使用 Git 时登录框问题</title>
      <link href="/the-basic-credential-prompt-for-git-on-windows-10.html"/>
      <url>/the-basic-credential-prompt-for-git-on-windows-10.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>如果在Pull或者Push时弹出的是Windows的提示框，并且输入正确的账号密码后还是现实验证不通过，解决办法如下：</p><p>在输入框点击取消，Git提示<code>Logon failed, use ctrl+c to cancel basic credential prompt</code>，此时再次在命令行输入账号密码即可。</p>]]></content>
      
      
      <categories>
          
          <category> 笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Git </tag>
            
            <tag> Windows10 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>时序数据库InfluxDB在.NET Core中的使用——（2）IoC和仓储模式实现事件存储</title>
      <link href="/influxdb-in-dotNEt-Core-2-ioc-and-repository-pattern.html"/>
      <url>/influxdb-in-dotNEt-Core-2-ioc-and-repository-pattern.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>我上一篇文章<a href="/influxdb-in-dotNEt-Core-1-Introduction.html">《InfluxDB在.NET Core中的使用——（1）InfluxDB简介》</a>中简单介绍了InfluxDB的相关概念，本文将继续介绍下半部分，就是在.NET Core中的使用方法。</p><h2 id="NET-客户端"><a href="#NET-客户端" class="headerlink" title=".NET 客户端"></a>.NET 客户端</h2><p>正因为InfluxDB是通过http请求来操作数据库，所以在.NET Core中使用很简单，只需要用HttpClient封装一个客户端、并且按照InfluxDB的数据结构去解析数据就行了。而且，已经有大神开发出了一个开源的可用于.NET Core的InfluxDB客户端项目 <a href="https://github.com/pootzko/InfluxData.Net" target="_blank" rel="noopener">InfluxData.Net</a> ，本文将利用这个客户端项目结合.NET Core自带的依赖注入框架和仓储模式，去封装一个事件存储的InfluxDB实现的类库。</p><h2 id="如何设计"><a href="#如何设计" class="headerlink" title="如何设计"></a>如何设计</h2><ol><li>把配置信息和InfluxDB客户端实例封装成一个服务。</li><li>用这个服务去实现原来定义的事件仓储接口。</li><li>遵循.NET Core的IoC风格，用<code>.Addxxx(option=&gt;{})</code>的方法配置数据库并且注册服务。</li></ol><h2 id="Show-Code"><a href="#Show-Code" class="headerlink" title="Show Code"></a>Show Code</h2><h4 id="InfluxDBOptions-cs"><a href="#InfluxDBOptions-cs" class="headerlink" title="InfluxDBOptions.cs"></a>InfluxDBOptions.cs</h4><p><code>InfluxDBOptions</code>类是一个配置类，主要有主机名<code>Host</code>( IP +端口号)，用户名 <code>UserName</code>，密码 <code>Password</code>，数据库名 <code>DatabaseName</code>。</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">/// &lt;summary></span><span class="token comment" spellcheck="true">/// InfluxDB设置</span><span class="token comment" spellcheck="true">/// &lt;/summary></span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InfluxDBOptions</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">string</span> Host <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">string</span> UserName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">string</span> Password <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">string</span> DatabaseName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="InfluxDbContext-cs"><a href="#InfluxDbContext-cs" class="headerlink" title="InfluxDbContext.cs"></a>InfluxDbContext.cs</h4><p><code>InfluxDbContext</code> 类是InfluxDB上下文的意思，里面封装了 InfluxDbClient 的一些基本组成部分，数据库对象<code>Database</code>，客户端对象<code>Client</code>(不知道为啥要在<code>InfluxDbClient</code>内定义一个Client对象)，以及我们上面设计的配置对象<code>InfluxDBOptions</code>。</p><p>另外还有<code>EnsureDbCreated</code>、<code>WriteAsync</code>和<code>QueryAsync</code>，其中<code>EnsureDbCreated</code>是确保数据库已创建，而<code>WriteAsync</code>和<code>QueryAsync</code>是对原来客户端读写方法的简化。</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InfluxDbContext</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">InfluxDbContext</span><span class="token punctuation">(</span>InfluxDBOptions options<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        Options <span class="token operator">=</span> options<span class="token punctuation">;</span>        <span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InfluxDbClient</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> options<span class="token punctuation">.</span>UserName<span class="token punctuation">,</span> options<span class="token punctuation">.</span>Password<span class="token punctuation">,</span> InfluxDbVersion<span class="token punctuation">.</span>v_1_0_0<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>Client <span class="token operator">=</span> client<span class="token punctuation">.</span>Client<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>Database <span class="token operator">=</span> client<span class="token punctuation">.</span>Database<span class="token punctuation">;</span>        <span class="token function">EnsureDbCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> IDatabaseClientModule Database <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> IBasicClientModule Client <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> InfluxDBOptions Options <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">EnsureDbCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> dbs <span class="token operator">=</span> <span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">GetDatabasesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dbs<span class="token punctuation">.</span><span class="token function">All</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span>Name <span class="token operator">!=</span> Options<span class="token punctuation">.</span>DatabaseName<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">CreateDatabaseAsync</span><span class="token punctuation">(</span>Options<span class="token punctuation">.</span>DatabaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/// &lt;summary></span>    <span class="token comment" spellcheck="true">/// 查询一个Serie</span>    <span class="token comment" spellcheck="true">/// &lt;/summary></span>    <span class="token comment" spellcheck="true">/// &lt;param name="query">&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>Serie<span class="token operator">></span> <span class="token function">QueryAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> query<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> Client<span class="token punctuation">.</span><span class="token function">QueryAsync</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> Options<span class="token punctuation">.</span>DatabaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/// &lt;summary></span>    <span class="token comment" spellcheck="true">/// 写入一个Point</span>    <span class="token comment" spellcheck="true">/// &lt;/summary></span>    <span class="token comment" spellcheck="true">/// &lt;param name="point">&lt;/param></span>    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>IInfluxDataApiResponse<span class="token operator">></span> <span class="token function">WriteAsync</span><span class="token punctuation">(</span>Point point<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">await</span> Client<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>point<span class="token punctuation">,</span> Options<span class="token punctuation">.</span>DatabaseName<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="IEventStorageRepository-cs"><a href="#IEventStorageRepository-cs" class="headerlink" title="IEventStorageRepository.cs"></a>IEventStorageRepository.cs</h4><p><code>IEventStorageRepository</code>事件仓储接口是我设计的，只有两个方法，一个存储方法<code>Store</code>，一个查询方法<code>GetEvents</code>。有这个接口，我可以设计不同的ORM和数据库仓储，如已经实现的InMemory、EFCore、MongoDB、LiteDB，以及本篇的主角InfluxDB。</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IEventStorageRepository</span><span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">Store</span><span class="token punctuation">(</span>StoredEvent theEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>    IEnumerable<span class="token operator">&lt;</span>StoredEvent<span class="token operator">></span> <span class="token function">GetEvents</span><span class="token punctuation">(</span>Guid aggregateId<span class="token punctuation">,</span> <span class="token keyword">int</span> afterVersion <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中<code>StoredEvent</code>是一个继承了Event的特殊类，用来保存事件的相关属性。关于这个类的设计在这不是重点，可以到我的项目<a href="https://github.com/ElderJames/shriek-fx/blob/master/src/Shriek/Storage/StoredEvent.cs" target="_blank" rel="noopener">【Shriek】</a>中一窥究竟。</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StoredEvent</span> <span class="token punctuation">:</span> Event<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">StoredEvent</span><span class="token punctuation">(</span>Event @<span class="token keyword">event</span><span class="token punctuation">,</span> <span class="token keyword">string</span> data<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        AggregateId <span class="token operator">=</span> @<span class="token keyword">event</span><span class="token punctuation">.</span>AggregateId<span class="token punctuation">;</span>        Data <span class="token operator">=</span> data<span class="token punctuation">;</span>        Version <span class="token operator">=</span> @<span class="token keyword">event</span><span class="token punctuation">.</span>Version<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">StoredEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>    <span class="token punctuation">[</span>Key<span class="token punctuation">]</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">protected</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//事件的序列化json字符串</span>    <span class="token keyword">public</span> <span class="token keyword">string</span> Data <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="EventStorageRepository-cs"><a href="#EventStorageRepository-cs" class="headerlink" title="EventStorageRepository.cs"></a>EventStorageRepository.cs</h4><p>仓储实现类</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventStorageRepository</span> <span class="token punctuation">:</span> IEventStorageRepository<span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">readonly</span> InfluxDbContext _dbContext<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">string</span> TableName <span class="token operator">=</span> <span class="token string">"events"</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">EventStorageRepository</span><span class="token punctuation">(</span>InfluxDbContext dbContext<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>_dbContext <span class="token operator">=</span> dbContext<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>StoredEvent<span class="token operator">></span> <span class="token function">GetEvents</span><span class="token punctuation">(</span>Guid aggregateId<span class="token punctuation">,</span> <span class="token keyword">int</span> afterVersion <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//查询语法跟普通sql是基本一致的，一定要注意，比价大小的字段一定是要在Fields中。Tags中的可以比较字符串是否相等</span>        <span class="token comment" spellcheck="true">//另外，time是默认的索引，也可以比价大小</span>        <span class="token keyword">var</span> query <span class="token operator">=</span> $<span class="token string">"SELECT * FROM {TableName} WHERE AggregateId='{aggregateId}' AND Version >= {afterVersion}"</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> result <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token function">QueryAsync</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span>Result<span class="token punctuation">;</span>        <span class="token keyword">return</span> result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">StoredEvent</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token punctuation">:</span> <span class="token function">SerieToStoredEvent</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Store</span><span class="token punctuation">(</span>StoredEvent theEvent<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//实例化一个Point</span>        <span class="token keyword">var</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//表名</span>            Name <span class="token operator">=</span> TableName<span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//用作索引的字段放到Tags里（只支持字符串，不能比较大小）</span>            Tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dictionary</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token punctuation">{</span><span class="token string">"AggregateId"</span><span class="token punctuation">,</span> theEvent<span class="token punctuation">.</span>AggregateId<span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//其他字段放到Fields里，参数值支持系统基本类型，不支持实体类</span>            Fields <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dictionary</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token punctuation">{</span><span class="token string">"Data"</span><span class="token punctuation">,</span> theEvent<span class="token punctuation">.</span>Data<span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token string">"EventType"</span><span class="token punctuation">,</span> theEvent<span class="token punctuation">.</span>MessageType<span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token string">"User"</span><span class="token punctuation">,</span> theEvent<span class="token punctuation">.</span>User<span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token string">"Version"</span><span class="token punctuation">,</span> theEvent<span class="token punctuation">.</span>Version<span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//时间戳，默认是当前时间，此处用事件的时间戳比较准确</span>            Timestamp <span class="token operator">=</span> theEvent<span class="token punctuation">.</span>Timestamp        <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> result <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">.</span>Result<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//结果返回是否写入成功</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>Success<span class="token punctuation">)</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InfluxDataException</span><span class="token punctuation">(</span><span class="token string">"事件插入失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//从Serie取数据转换为StoredEvent，需要一个个字段去取，所有字段都在Serie.Values中了</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> IEnumerable<span class="token operator">&lt;</span>StoredEvent<span class="token operator">></span> <span class="token function">SerieToStoredEvent</span><span class="token punctuation">(</span>Serie serie<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> serie<span class="token punctuation">.</span>Values<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">StoredEvent</span>        <span class="token punctuation">{</span>            AggregateId <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span>serie<span class="token punctuation">.</span>Columns<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span><span class="token string">"AggregateId"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            Version <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span>serie<span class="token punctuation">.</span>Columns<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span><span class="token string">"Version"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//这里的Replace是客户端的一个bug，已经提交Pull Request</span>            Data <span class="token operator">=</span> item<span class="token punctuation">[</span>serie<span class="token punctuation">.</span>Columns<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span><span class="token string">"Data"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">@"\", string.Empty),            User = item[serie.Columns.IndexOf("</span>User"<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            MessageType <span class="token operator">=</span> item<span class="token punctuation">[</span>serie<span class="token punctuation">.</span>Columns<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span><span class="token string">"EventType"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">@"\"</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">)</span><span class="token punctuation">,</span>            Timestamp <span class="token operator">=</span> DateTime<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="EventStorageInfluxDBExtensions-cs"><a href="#EventStorageInfluxDBExtensions-cs" class="headerlink" title="EventStorageInfluxDBExtensions.cs"></a>EventStorageInfluxDBExtensions.cs</h4><p>IoC注册及配置扩展类</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EventStorageInfluxDBExtensions</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">AddInfluxDbEventStorage</span><span class="token punctuation">(</span><span class="token keyword">this</span> IServiceCollection services<span class="token punctuation">,</span> Action<span class="token operator">&lt;</span>InfluxDBOptions<span class="token operator">></span> optionAction<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InfluxDBOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">optionAction</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>        services<span class="token punctuation">.</span><span class="token function">AddScoped</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>        services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>InfluxDbContext<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>IEventStorageRepository<span class="token punctuation">,</span> EventStorageRepository<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>IMementoRepository<span class="token punctuation">,</span> MementoRepository<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>IEventStorage<span class="token punctuation">,</span> SqlEventStorage<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h4><pre class="line-numbers language-csharp"><code class="language-csharp">    <span class="token keyword">var</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    services<span class="token punctuation">.</span><span class="token function">AddInfluxDbEventStorage</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>    <span class="token punctuation">{</span>        options<span class="token punctuation">.</span>Host <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"InfluxDBConnection:Host"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>        options<span class="token punctuation">.</span>Password <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"InfluxDBConnection:Password"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>        options<span class="token punctuation">.</span>UserName <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"InfluxDBConnection:UserName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>        options<span class="token punctuation">.</span>DatabaseName <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"InfluxDBConnection:DatabaseName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>配置文件<code>appsettings.json</code>中的配置</p><pre class="line-numbers language-json"><code class="language-json">  <span class="token property">"InfluxDBConnection"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"Host"</span><span class="token operator">:</span> <span class="token string">"http://localhost:8086"</span><span class="token punctuation">,</span>    <span class="token property">"DatabaseName"</span><span class="token operator">:</span> <span class="token string">"event_store"</span><span class="token punctuation">,</span>    <span class="token property">"UserName"</span><span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>    <span class="token property">"Password"</span><span class="token operator">:</span> <span class="token string">"admin"</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>大功告成~由于太晚了，我先贴上代码，有空再补上说明咯！</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> InfluxDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>时序数据库InfluxDB在.NET Core中的使用——（1）InfluxDB简介及使用</title>
      <link href="/influxdb-in-dotNEt-Core-1-Introduction.html"/>
      <url>/influxdb-in-dotNEt-Core-1-Introduction.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>InfluxDB是一个由InfluxData开发的开源时序型数据库。它由Go写成，着力于高性能地查询与存储时序型数据。InfluxDB被广泛应用于存储系统的监控数据，IoT行业的实时数据等场景。</p><p>——维基百科</p></blockquote><p>根据网络上的众多测评文章，同样的时序型数据，时序数据库的读写性能都比关系型数据库、NoSQL数据库要快，占用资源更少。所以，时序数据库适合数据结构固定、与时间顺序关联性强、数据量大并且读写性能要求高的使用场景，比如日志、监控数据、大数据存储等，以我这个DDD践行者来说，更是事件溯源架构中事件存储方式的最优选择。</p><h3 id="特色"><a href="#特色" class="headerlink" title="特色"></a>特色</h3><ol><li>基于时间序列，支持与时间有关的相关函数（如最大，最小，求和等）</li><li>可度量性：你可以实时对大量数据进行计算</li><li>基于事件：它支持任意的事件数据</li></ol><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol><li>无结构（无模式）：可以是任意数量的列</li><li>可拓展的，通过配套的代理插件可实现分布式</li><li>支持min, max, sum, count, mean, median 等一系列函数，方便统计</li><li>原生的HTTP支持，内置HTTP API</li><li>强大的类SQL语法</li><li>自带管理界面，方便使用</li></ol><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>只有一个，只适合固定的数据结构，如果结构有变动，变动前的数据讲很难查询到，需要从数据源重新导入，所以说是用灵活性的牺牲来换取超高的性能，但是它的应用场景依然宽泛。</p><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h5 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h5><p>数据库名，在 InfluxDB 中可以创建多个数据库，不同数据库中的数据文件是隔离存放的，存放在磁盘上的不同目录。</p><h5 id="Measurements"><a href="#Measurements" class="headerlink" title="Measurements"></a>Measurements</h5><p>相当于传统数据库的表，例如 cpu_usage 表示 cpu 的使用率。</p><h5 id="Tag-sets"><a href="#Tag-sets" class="headerlink" title="Tag sets"></a>Tag sets</h5><p>标签，tags 在 InfluxDB 中会被建立索引，且放在内存中。如果某种数据经常用来被作为查询条件，可以考虑设为Tag。</p><h5 id="Fields"><a href="#Fields" class="headerlink" title="Fields"></a>Fields</h5><p>字段，是各种数据类型的存储和查询时的主要对象。</p><h5 id="Points"><a href="#Points" class="headerlink" title="Points"></a>Points</h5><p>点，代表一条记录，由时间戳（time）、数据（field）、标签（tags）组成。</p><ul><li>time : 每个数据记录时间，是数据库中的主索引(会自动生成)</li><li>tags : 各种有索引的属性，只支持字符串</li><li>fields : 各种记录值（没有索引的属性）也就是记录的值</li></ul><h5 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h5><p>序列，以retention policy、 measurement、 tagset共同组成的定位测点作为序列的唯一标识的所有记录，每个时刻的记录就是Point。</p><h5 id="Timestamp"><a href="#Timestamp" class="headerlink" title="Timestamp"></a>Timestamp</h5><p>时间戳，每一条数据都需要指定一个时间戳，在 TSM 存储引擎中会特殊对待，以为了优化后续的查询操作。</p><h5 id="Retention-Policies"><a href="#Retention-Policies" class="headerlink" title="Retention Policies"></a>Retention Policies</h5><p>存储策略，用于设置数据保留的时间，每个数据库刚开始会自动创建一个默认的存储策略 autogen，数据保留时间为永久，之后用户可以自己设置，例如保留最近2小时的数据。插入和查询数据时如果不指定存储策略，则使用默认存储策略，且默认存储策略可以修改。InfluxDB 会定期清除过期的数据。</p><h5 id="Continuous-Queries"><a href="#Continuous-Queries" class="headerlink" title="Continuous Queries"></a>Continuous Queries</h5><p>连续查询，使用连续查询是最优的降低采样率的方式，连续查询和存储策略搭配使用将会大大降低InfluxDB的系统占用量。而且使用连续查询后，数据会存放到指定的数据表中，这样就为以后统计不同精度的数据提供了方便。</p><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>由于Tag与Field的不同特性，在编写SQL进行查询时，Tag与Field支持不同的操作，总结如下:</p><h5 id="Tag"><a href="#Tag" class="headerlink" title="Tag"></a>Tag</h5><ul><li>只能使用Tag进行Group</li><li>只能使用Tag进行正则表达式操作</li></ul><h5 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h5><ul><li>只能使用Field进行函数操作，例如sum()</li><li>只能使用Field进行比较操作</li><li>如果需要使用int,float,boolean类型进行存储,只能使用Field</li></ul><h2 id="安装与使用"><a href="#安装与使用" class="headerlink" title="安装与使用"></a>安装与使用</h2><p>安装方法很简单，除了在官方网站<a href="https://influxdata.com/downloads/#influxdb" target="_blank" rel="noopener">https://influxdata.com/downloads/#influxdb</a>下载安装程序外，官方还提供了Docker镜像，我就是在Docker Hub拉取镜像并且部署的，毕竟才14MB大小，而且还与本机环境隔离。</p><p>安装好后，数据库服务的地址是<code>http://localhost:8086</code>，初始用户名是admin，初始密码也是admin。数据库可以通过发送Http请求来操作，操作语句与sql语言基本保持一致。</p><ul><li><p>创建一个数据库：</p><p>  <code>curl -i -XPOST http://localhost:8086/query --data-urlencode &quot;q=CREATE DATABASE mydb&quot;</code></p></li><li><p>写入一个Point(记录)：</p><p>  <code>curl -i -XPOST &#39;http://localhost:8086/write?db=mydb&#39; --data-binary &#39;cpu_load_short,host=server01,region=us-west value=0.64 1434055562000000000&#39;</code></p></li><li><p>查询操作：</p><p>  <code>curl -G &#39;http://localhost:8086/query?pretty=true&#39; --data-urlencode &quot;db=mydb&quot; --data-urlencode &quot;q=SELECT \&quot;value\&quot; FROM \&quot;cpu_load_short\&quot; WHERE \&quot;region\&quot;=&#39;us-west&#39;&quot;</code></p><p>  返回的会是一段Json数据：</p></li></ul><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"results"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"statement_id"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token property">"series"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cpu_load_short"</span><span class="token punctuation">,</span>                    <span class="token property">"columns"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token string">"time"</span><span class="token punctuation">,</span>                        <span class="token string">"value"</span>                    <span class="token punctuation">]</span><span class="token punctuation">,</span>                    <span class="token property">"values"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token punctuation">[</span>                            <span class="token string">"2015-01-29T21:55:43.702900257Z"</span><span class="token punctuation">,</span>                            <span class="token number">2</span>                        <span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token punctuation">[</span>                            <span class="token string">"2015-01-29T21:55:43.702900257Z"</span><span class="token punctuation">,</span>                            <span class="token number">0.55</span>                        <span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token punctuation">[</span>                            <span class="token string">"2015-06-11T20:46:02Z"</span><span class="token punctuation">,</span>                            <span class="token number">0.64</span>                        <span class="token punctuation">]</span>                    <span class="token punctuation">]</span>                <span class="token punctuation">}</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本篇文章主要介绍了InfluxDB的基本概念以及安装和基本操作方法，更详细的介绍请参阅<a href="https://docs.influxdata.com/influxdb/v1.3/guides" target="_blank" rel="noopener">官方文档</a>以及热心开发者发表的<a href="https://www.linuxdaxue.com/series/influxdb-series/" target="_blank" rel="noopener">系列教程</a></p><p>性能测试参考：<a href="http://www.cnblogs.com/MikeZhang/p/InfluxDBTest20170212.html" target="_blank" rel="noopener">http://www.cnblogs.com/MikeZhang/p/InfluxDBTest20170212.html</a></p><p>下一篇，我将动手利用一款InfluxDB客户端结合.NET Core自带IoC框架和仓储模式实现事件存储。</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> InfluxDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core中动态为控制器类型添加特性</title>
      <link href="/dynamically-add-features-to-the-controller-type-in-dot-net-core.html"/>
      <url>/dynamically-add-features-to-the-controller-type-in-dot-net-core.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>我在上一篇文章<a href="https://yangshunjie.com/add-the-webapi-service-to-the-specified-class-in-asp-net-core.html">《ASP.NET Core中为指定类添加WebApi服务功能》</a>中介绍了如何为指定类型增加WebApi服务功能，达到了一定的解耦效果（不再需要继承Controller类，不再需要Controller后缀名），但是，<code>Route</code>、<code>HttpGet</code>之类的特性类型还是需要用Mvc的，那么今天这篇文章，就介绍如何把这些标签的依赖也消灭掉。</p><p>如果还没看上一篇文章又不了解如何指定类型为控制器的朋友，最好先看一下上一篇文章，因为要实现本文介绍的功能，是需要先实现上一篇文章所介绍的功能的。</p><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>在没有MVC引用的类库中自定义<code>RouteAttribute</code>、<code>HttpGetAttribute</code>、<code>HttpPostAttribute</code>等等跟MVC配对的特性标签类型；其次，在定义服务接口时把这些特性标记到方法声明上面；最后在ASP.NET Core 服务启动时自动按照指定的接口上的特性给相应的接口添加MVC的标签，使得动态指定的类型也能获得MVC的路由和请求方法限制的功能。</p><p>用到的技术点主要是<strong>反射</strong>和利用MVC框架给出的<strong>配置点</strong>。</p><p>MVC框架给出的配置点在<a href="https://github.com/aspnet/Mvc/blob/de1b763d963f8be612d93889e08e43f67c98d0d5/src/Microsoft.AspNetCore.Mvc.Core/ApplicationModels/IControllerModelConvention.cs" target="_blank" rel="noopener"><code>IControllerModelConvention</code></a>、<a href="https://github.com/aspnet/Mvc/blob/b6a6b50776bb1ee49c0bca1353375e964101bb8a/src/Microsoft.AspNetCore.Mvc.Core/ApplicationModels/IActionModelConvention.cs" target="_blank" rel="noopener"><code>IActionModelConvention</code></a>、<a href="https://github.com/aspnet/Mvc/blob/16c267d95eafbf310f17bc938d00048a541be0d0/src/Microsoft.AspNetCore.Mvc.Core/ApplicationModels/IParameterModelConvention.cs" target="_blank" rel="noopener"><code>IParameterModelConvention</code></a>三个接口。顾名思义，它们分别对应控制器、操作、参数的类型配置，在它们的<code>Apply</code>方法中，传入了一个MVC启动阶段扫描到的类型，开发者可以通过给这个类型添加各种MVC特性，如<code>RouteData</code>、<code>Attributes</code>、<code>Filters</code>等。但是，这些特性组合是有规则的，不能一股脑儿地都添加进去，MVC的机制中会用<code>SelectorModel</code>来将特性进行分组。</p><p>例如有以下的操作方法和它的特性：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">AcceptVerbs</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> <span class="token string">"PUT"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token function">HttpPost</span><span class="token punctuation">(</span><span class="token string">"Api/Things"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">DoThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>那么MVC中就需要把他们分为两组：</p><ol><li><code>[HttpPost(&quot;Api/Things&quot;)]</code></li><li><code>[HttpGet], [AcceptVerbs(&quot;POST&quot;, &quot;PUT&quot;)]</code></li></ol><p>所以，这个分组的规则，我们怎么去处理呢？其实，在MVC的源码中就有这样的方法<a href="https://github.com/aspnet/Mvc/blob/de389226011fb15140ee0a8d6a2429b2eb943f3a/src/Microsoft.AspNetCore.Mvc.Core/Internal/DefaultApplicationModelProvider.cs#L439" target="_blank" rel="noopener"><code>IList&lt;SelectorModel&gt; CreateSelectors(IList&lt;object&gt; attributes)</code></a>，我们把它复制过来就好了。</p><h3 id="学以致用"><a href="#学以致用" class="headerlink" title="学以致用"></a>学以致用</h3><p>回到我们的需求，我们需要把指定类型的方法都加上MVC特性，就需要自定义一些<code>ModelConvention</code>。由于我们的需求比较简单，只需特性作用按类型来使指定类型获得MVC特性，我们只需在构造方法中传入指定类型，分别为控制器、操作和参数这三个作用类型都定义一个。由于篇幅问题，下面只贴Action的实现来讲解，另外两个大家可以看我<a href="https://github.com/ElderJames/shriek-fx/tree/master/src/Shriek.ServiceProxy.Http.Server/Internal" target="_blank" rel="noopener">项目中的源码</a>。</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">using</span> HttpGet <span class="token operator">=</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc<span class="token punctuation">.</span>HttpGetAttribute<span class="token punctuation">;</span><span class="token keyword">using</span> HttpPost <span class="token operator">=</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc<span class="token punctuation">.</span>HttpPostAttribute<span class="token punctuation">;</span><span class="token keyword">using</span> Route <span class="token operator">=</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc<span class="token punctuation">.</span>RouteAttribute<span class="token punctuation">;</span><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">ActionModelConvention</span> <span class="token punctuation">:</span> IActionModelConvention<span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//构造方法传入指定接口类型</span>    <span class="token keyword">public</span> <span class="token function">ActionModelConvention</span><span class="token punctuation">(</span>Type serviceType<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceType <span class="token operator">=</span> serviceType<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> Type serviceType <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Apply</span><span class="token punctuation">(</span>ActionModel action<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//判断是否为指定接口类型的实现类</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serviceType<span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Controller<span class="token punctuation">.</span>ControllerType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> actionParams <span class="token operator">=</span> action<span class="token punctuation">.</span>ActionMethod<span class="token punctuation">.</span><span class="token function">GetParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//这串linq是查询出接口类型中与当前action相对应的方法，从中获取特性</span>        <span class="token keyword">var</span> method <span class="token operator">=</span> serviceType<span class="token punctuation">.</span><span class="token function">GetMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>mth <span class="token operator">=</span><span class="token operator">></span>        <span class="token punctuation">{</span>            <span class="token keyword">var</span> mthParams <span class="token operator">=</span> mth<span class="token punctuation">.</span><span class="token function">GetParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> action<span class="token punctuation">.</span>ActionMethod<span class="token punctuation">.</span>Name <span class="token operator">==</span> mth<span class="token punctuation">.</span>Name                   <span class="token operator">&amp;&amp;</span> actionParams<span class="token punctuation">.</span>Length <span class="token operator">==</span> mthParams<span class="token punctuation">.</span>Length                   <span class="token operator">&amp;&amp;</span> actionParams<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> mthParams<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span>Name <span class="token operator">==</span> o<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> o<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> attrs <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">GetCustomAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> actionAttrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> att <span class="token keyword">in</span> attrs<span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//下面的HttpMethodAttribute是我们自己写的特性类型</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>att <span class="token keyword">is</span> HttpMethodAttribute methodAttr<span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    <span class="token keyword">var</span> httpMethod <span class="token operator">=</span> methodAttr<span class="token punctuation">.</span>Method<span class="token punctuation">;</span>                    <span class="token keyword">var</span> path <span class="token operator">=</span> methodAttr<span class="token punctuation">.</span>Path<span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>httpMethod <span class="token operator">==</span> HttpMethod<span class="token punctuation">.</span>Get<span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">//添加的HttpGet和HttpPost使用了命名空间别名</span>                        actionAttrs<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>httpMethod <span class="token operator">==</span> HttpMethod<span class="token punctuation">.</span>Post<span class="token punctuation">)</span>                    <span class="token punctuation">{</span>                        actionAttrs<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>                 <span class="token comment" spellcheck="true">//下面的RouteAttribute是我们自己写的特性类型</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>att <span class="token keyword">is</span> RouteAttribute routeAttr<span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    actionAttrs<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Route</span><span class="token punctuation">(</span>routeAttr<span class="token punctuation">.</span>Template<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>actionAttrs<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            action<span class="token punctuation">.</span>Selectors<span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//AddRange静态方法就是从源码中复制过来的</span>            ModelConventionHelper<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>Selectors<span class="token punctuation">,</span> ModelConventionHelper<span class="token punctuation">.</span><span class="token function">CreateSelectors</span><span class="token punctuation">(</span>actionAttrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码其实还省略了其它的请求方式，我的源码中是有的，大家也可以前去查看。除了<a href="https://github.com/ElderJames/shriek-fx/blob/master/src/Shriek.ServiceProxy.Http.Server/Internal/ActionModelConvention.cs" target="_blank" rel="noopener"><code>ActionModelConvention</code></a>，还需要写<a href="https://github.com/ElderJames/shriek-fx/blob/master/src/Shriek.ServiceProxy.Http.Server/Internal/ControllerModelConvention.cs" target="_blank" rel="noopener"><code>ControllerModelConvention</code></a>和<a href="https://github.com/ElderJames/shriek-fx/blob/master/src/Shriek.ServiceProxy.Http.Server/Internal/ParameterModelConvention.cs" target="_blank" rel="noopener"><code>ParameterModelConvention</code></a>。</p><h3 id="配置到MVC框架"><a href="#配置到MVC框架" class="headerlink" title="配置到MVC框架"></a>配置到MVC框架</h3><p>核心的代码写好了，那么怎么让它起作用呢？其实官方的源码已经提供了示例：<a href="https://github.com/aspnet/Mvc/blob/760c8f38678118734399c58c2dac981ea6e47046/test/WebSites/ApplicationModelWebSite/Startup.cs#L16" target="_blank" rel="noopener">Mvc/test/WebSites/ApplicationModelWebSite/Startup.cs</a>，我们只需在<code>services.AddMvc()</code>里的<code>setupAction</code>委托中将我们的配置类型添加到<a href="https://github.com/aspnet/Mvc/blob/b4fe715c71f472180069f674bde3ef8014064d64/src/Microsoft.AspNetCore.Mvc.Core/MvcOptions.cs#L59" target="_blank" rel="noopener">MvcOptions.Conventions</a>属性里就好了，这个属性是用来添加所有模型配置的，然后MVC启动后会把这些配置都扫描处理一遍。</p><p>来看看我这里的实现：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">//假设我们定义了这样的接口</span><span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ITestService</span><span class="token punctuation">{</span>    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"{name}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HttpGet<span class="token punctuation">]</span>    <span class="token keyword">string</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//AddMvc也一样，这里用AddMvcCore只是为了减少依赖</span>services<span class="token punctuation">.</span><span class="token function">AddMvcCore</span><span class="token punctuation">(</span>opt<span class="token operator">=</span><span class="token operator">></span>    <span class="token punctuation">{</span>        opt<span class="token punctuation">.</span>Conventions<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ControllerModelConvention</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ITestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        opt<span class="token punctuation">.</span>Conventions<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActionModelConvention</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ITestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        opt<span class="token punctuation">.</span>Conventions<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ParameterModelConvention</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ITestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当然了，我这里是因为指定类型是通过反射获取的，所以用了Type类型作为参数，大家也可以用泛型，在构造方法里获取对象类型。</p><h3 id="完整代码实现"><a href="#完整代码实现" class="headerlink" title="完整代码实现"></a>完整代码实现</h3><p>接下来，除了这三个<code>ModelConvention</code>类型，我把整个实现代码贴一下，让大家看得比较直观，最后会跟上一篇文章的实现加入进来。因为，如果没有昨天的工作，我们指定的类型不被MVC识别为控制器的话，我们是无法实现为这些类型添加MVC属性的。</p><p>首先，先创建一个控制台程序，引入一下Nuget包</p><pre class="line-numbers language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Hosting<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.0.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Mvc.Core<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.0.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>接着，定义一个接口以及它的实现，接口中标记了一些自定义特性，而实现类中完全没有：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ITestService</span><span class="token punctuation">{</span>    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"{name}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HttpGet<span class="token punctuation">]</span>    <span class="token keyword">string</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token punctuation">:</span> ITestService<span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"Hello "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后在控制台程序的入口文件Program.cs的Main方法中写入一下代码：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Program</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>    <span class="token punctuation">{</span>       <span class="token keyword">new</span> <span class="token class-name">WebHostBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">UseKestrel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">UseUrls</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>services <span class="token operator">=</span><span class="token operator">></span>            <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">//使用AddMvc亦可</span>                services<span class="token punctuation">.</span><span class="token function">AddMvcCore</span><span class="token punctuation">(</span>opt<span class="token operator">=</span><span class="token operator">></span>                <span class="token punctuation">{</span>                    opt<span class="token punctuation">.</span>Conventions<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ControllerModelConvention</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ITestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    opt<span class="token punctuation">.</span>Conventions<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ActionModelConvention</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ITestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    opt<span class="token punctuation">.</span>Conventions<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ParameterModelConvention</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ITestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//下面这段是上一篇文章里的内容</span>                <span class="token punctuation">.</span><span class="token function">ConfigureApplicationPartManager</span><span class="token punctuation">(</span>manager <span class="token operator">=</span><span class="token operator">></span>                <span class="token punctuation">{</span>                    <span class="token keyword">var</span> featureProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceControllerFeatureProvider</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ITestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    manager<span class="token punctuation">.</span>FeatureProviders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>featureProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span>app <span class="token operator">=</span><span class="token operator">></span> app<span class="token punctuation">.</span><span class="token function">UseMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一切编译通过后，点击运行，在浏览器中访问”<a href="http://localhost:8080/test/elderjames" target="_blank" rel="noopener">http://localhost:8080/test/elderjames</a>”，如果看到返回了“Hello elderjames”，那么就大功告成啦！</p><p><img src="/images/add_webapi_to_class/1.png" alt=""></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这篇文章中主要介绍了通过实现<a href="https://github.com/aspnet/Mvc/blob/de1b763d963f8be612d93889e08e43f67c98d0d5/src/Microsoft.AspNetCore.Mvc.Core/ApplicationModels/IControllerModelConvention.cs" target="_blank" rel="noopener"><code>IControllerModelConvention</code></a>、<a href="https://github.com/aspnet/Mvc/blob/b6a6b50776bb1ee49c0bca1353375e964101bb8a/src/Microsoft.AspNetCore.Mvc.Core/ApplicationModels/IActionModelConvention.cs" target="_blank" rel="noopener"><code>IActionModelConvention</code></a>、<a href="https://github.com/aspnet/Mvc/blob/16c267d95eafbf310f17bc938d00048a541be0d0/src/Microsoft.AspNetCore.Mvc.Core/ApplicationModels/IParameterModelConvention.cs" target="_blank" rel="noopener"><code>IParameterModelConvention</code></a>三个接口实现为指定为控制器的类型添加MVC特性的方法。</p><p>本篇文章发现源码的部分受到<a href="https://github.com/maxzhang1985" target="_blank" rel="noopener"><em>max zhang</em></a> 和他的群里的群友<em>福州 | Today</em>的帮助，在此表示衷心的感谢。</p><p>在接下来的文章中，会介绍使用功能强大的.NTE Core开源AOP框架<a href="https://github.com/dotnetcore/AspectCore-Framework" target="_blank" rel="noopener"><strong>AspectCore</strong></a>实现的动态代理客户端，注册以上所说的接口，即可获得可以调用对应的WebApi服务的功能。这些工作的源码可以在<a href="https://github.com/ElderJames/shriek-fx/tree/master/samples/Shriek.Samples.WebApiProxy" target="_blank" rel="noopener">我的框架示例项目</a>中运行，大家有兴趣可以看看效果。</p><p><strong>感谢阅读和批评指教！</strong></p><p>[温馨提示：为方便大家看文中提到的源码，原文中有大量指向源码链接，如果您看的是没有链接的转载，可以再来看我的原文。]</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
            <tag> WebApi </tag>
            
            <tag> MVC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core中为指定类添加WebApi服务功能</title>
      <link href="/add-the-webapi-service-to-the-specified-class-in-asp-net-core.html"/>
      <url>/add-the-webapi-service-to-the-specified-class-in-asp-net-core.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>POCO Controller是 <strong>ASP.NET Core</strong> 中的一个特性，虽然在2015年刚发布的时候就有这个特性了，可是大多数开发者都只是按原有的方式去写，而没有用到这个特性。其实，如果利用这个特性进行稍微封装后，用在SOA架构中Service层的场景中是极其便利的。这篇文章主要就是说我最近在学习使用开源AOP库AspectCore写WebApi动态代理客户端的时候，实现为普通类添加WebApi服务的过程。</p><h3 id="POCO控制器简介"><a href="#POCO控制器简介" class="headerlink" title="POCO控制器简介"></a>POCO控制器简介</h3><p>POCO控制器就是ASP.NET Core项目中所有带有<code>Controller</code>后缀的类、或者标记了<code>[Controller]</code>特性的类，虽然没有像模版项目中那样继承自<strong>Controller类</strong>，也会被识别为控制器，拥有跟普通控制器一样的功能，像下面这段代码中，两个类都会被识别成控制器：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PocoController</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> IActionResult <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ContentResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Content <span class="token operator">=</span> “Hello <span class="token keyword">from</span> POCO controller<span class="token operator">!</span>” <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span>Controller<span class="token punctuation">]</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Poco</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> IActionResult <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ContentResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Content <span class="token operator">=</span> “Hello <span class="token keyword">from</span> POCO controller<span class="token operator">!</span>” <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="POCO控制器原理"><a href="#POCO控制器原理" class="headerlink" title="POCO控制器原理"></a>POCO控制器原理</h3><p>其实，在ASP.NET Core中，已经不像旧版本的 ASP.NET WebApi 那样，通过ControllerFactory来创建Controller，多亏于ASP.NET Core一脉相承的IoC框架 <code>Microsoft.Extensions.DependencyInjection</code>，ASP.NET Core中的内部实现变得更优雅。其中POCO控制器的核心原理就在<a href="https://github.com/aspnet/Mvc/blob/2bacb6003f3bc2c3b58107c1118346dca3f5fa13/src/Microsoft.AspNetCore.Mvc.Core/ApplicationParts/IApplicationFeatureProviderOfT.cs" target="_blank" rel="noopener"><code>IApplicationFeatureProvider&lt;ControllerFeature&gt;</code></a>这个接口的实现<a href="https://github.com/aspnet/Mvc/blob/760c8f38678118734399c58c2dac981ea6e47046/src/Microsoft.AspNetCore.Mvc.Core/Controllers/ControllerFeatureProvider.cs#L15" target="_blank" rel="noopener"><code>ControllerFeatureProvider</code></a>。</p><p>通过<a href="https://github.com/aspnet/Mvc/search?p=1&q=IApplicationFeatureProvider&type=&utf8=%E2%9C%93" target="_blank" rel="noopener">aspnet/Mvc项目的Github源码仓库</a>中查询得知，Mvc里把Controller、ViewComponent、TagHelper、Views等组件定义为特性(Feature)，如<code>ControllerFeature</code>，特性里就存放了应用中被识别为相组件的类型的集合，如如<code>ControllerFeature</code>中就存放了所有<code>Controller</code>类型。<code>IApplicationFeatureProvider&lt;ControllerFeature&gt;</code>这个接口是用来给MVC框架提供控制器类型识别的接口，当把这个接口的实现注册到服务配置中，就能为其中识别的类型提供控制器功能。</p><p><a href="https://github.com/aspnet/Mvc/blob/760c8f38678118734399c58c2dac981ea6e47046/src/Microsoft.AspNetCore.Mvc.Core/Controllers/ControllerFeatureProvider.cs#L15" target="_blank" rel="noopener">ControllerFeatureProvider</a>是这个接口的默认实现，其中有一个方法<code>IsController(TypeInfo typeInfo)</code>的功能就是判断某类型是否为控制器的。而接口方法<code>PopulateFeature(IEnumerable&lt;ApplicationPart&gt; parts,ControllerFeature feature)</code>则为把传入的 “Mvc应用部分（<code>ApplicationPart</code>，大概是指Mvc的作用程序集）”中的类型都一一判断，如果是控制器，那么就加入控制器特性对象中。</p><h3 id="实现自定义判断规则"><a href="#实现自定义判断规则" class="headerlink" title="实现自定义判断规则"></a>实现自定义判断规则</h3><p>通过上面的剖析，我们就知道要实现自定义的控制器判断规则，只需要重写<code>ControllerFeature</code>类或者重新实现<code>IApplicationFeatureProvider&lt;ControllerFeature&gt;</code>接口，但是由于<code>PopulateFeature</code>不是虚方法或抽象方法，所以不能被重写，那么只能重新写一个类来实现<code>IApplicationFeatureProvider&lt;ControllerFeature&gt;</code>接口了。为了兼容原来规则，我把原来的规则照搬过来，复制了<code>IsController</code>的方法（开源的好处），并且在<code>PopulateFeature</code>中加入了自己的规则。先贴代码，避免篇幅过长，<code>IsController</code>方法的实现就直接链接到<a href="https://github.com/aspnet/Mvc/blob/760c8f38678118734399c58c2dac981ea6e47046/src/Microsoft.AspNetCore.Mvc.Core/Controllers/ControllerFeatureProvider.cs#L41" target="_blank" rel="noopener">源码</a>了：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">ServiceControllerFeatureProvider</span> <span class="token punctuation">:</span> IApplicationFeatureProvider<span class="token operator">&lt;</span>ControllerFeature<span class="token operator">></span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">string</span> ControllerTypeNameSuffix <span class="token operator">=</span> <span class="token string">"Controller"</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">readonly</span> IEnumerable<span class="token operator">&lt;</span>Type<span class="token operator">></span> ServiceTypes<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ServiceControllerFeatureProvider</span><span class="token punctuation">(</span>IEnumerable<span class="token operator">&lt;</span>Type<span class="token operator">></span> ServiceTypes<span class="token punctuation">)</span>    <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>ServiceTypes <span class="token operator">=</span> ServiceTypes<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">PopulateFeature</span><span class="token punctuation">(</span>IEnumerable<span class="token operator">&lt;</span>ApplicationPart<span class="token operator">></span> parts<span class="token punctuation">,</span> ControllerFeature feature<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> type <span class="token keyword">in</span> Reflection<span class="token punctuation">.</span>CurrentAssembiles<span class="token punctuation">.</span><span class="token function">SelectMany</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> o<span class="token punctuation">.</span>DefinedTypes<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsController</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">||</span> ServiceTypes<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> type<span class="token punctuation">.</span>IsClass <span class="token operator">&amp;&amp;</span> o<span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>feature<span class="token punctuation">.</span>Controllers<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">{</span>                    feature<span class="token punctuation">.</span>Controllers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token keyword">bool</span> <span class="token function">IsController</span><span class="token punctuation">(</span>TypeInfo typeInfo<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//...</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面代码的原理，是按照我的框架的需求来改写的，构造方法传入的参数ServiceTypes是定义了服务方法的接口的类型，接口和对应实现类似于以下代码，这些代码可以写在一个.NET Core控制台项目中。</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ITestService</span><span class="token punctuation">{</span>    <span class="token keyword">string</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token punctuation">:</span> ITestService<span class="token punctuation">{</span>    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"{name}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HttpGet<span class="token punctuation">]</span>    <span class="token keyword">public</span> <span class="token keyword">string</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"Hello "</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中TestService类就是会被识别为控制器的类，但是接口和实现是可以分开在不同程序集的。通过原本<code>ControllerFeatureProvider</code>类中<code>PopulateFeature</code>方法的<code>parts</code>参数中的类型是不包括除了引用了Mvc的程序集的其它程序集的，所以我这里用自己实现的类型扫描类<code>Reflection</code>中的<code>CurrentAssembiles</code>静态变量来获取当前应用程序的所有引用的（自己创建的项目）程序集的，具体实现的代码在我的框架[Shriek]的<a href="https://github.com/ElderJames/shriek-fx/blob/master/src/Shriek/Utils/Reflection.cs" target="_blank" rel="noopener">源码中</a>。</p><h3 id="配置自定义规则"><a href="#配置自定义规则" class="headerlink" title="配置自定义规则"></a>配置自定义规则</h3><p>现在，我们拥有了自定义控制器识别规则<code>ServiceControllerFeatureProvider</code>，那么，怎么配置到Mvc中呢？又要去翻源码了！在<code>MvcCoreMvcBuilderExtensions.cs</code>扩展类中，有一个<code>IMvcBuilder</code>的扩展方法<a href="https://github.com/aspnet/Mvc/blob/1c4b0fcdf38320b2f02c0bb7c31df5bd391ace07/src/Microsoft.AspNetCore.Mvc.Core/DependencyInjection/MvcCoreMvcBuilderExtensions.cs#L93" target="_blank" rel="noopener"><code>ConfigureApplicationPartManager</code></a>（<code>IMvcCoreBuilder</code>也有这样的<a href="https://github.com/aspnet/Mvc/blob/1c4b0fcdf38320b2f02c0bb7c31df5bd391ace07/src/Microsoft.AspNetCore.Mvc.Core/DependencyInjection/MvcCoreMvcCoreBuilderExtensions.cs#L152" target="_blank" rel="noopener">扩展方法</a>），它的参数是传入<code>ApplicationPartManager</code>参数的委托，而<a href="https://github.com/aspnet/Mvc/blob/760c8f38678118734399c58c2dac981ea6e47046/src/Microsoft.AspNetCore.Mvc.Core/ApplicationParts/ApplicationPartManager.cs#L13" target="_blank" rel="noopener"><code>ApplicationPartManager</code></a>中有一个<code>FeatureProviders</code>属性，用来存储所有<code>IApplicationFeatureProvider</code>实例，会在应用第一次运行的时候，循环这些“特性提供器”提供所有上面提到的MVC特性。所以，只要我们在这里添加我们自定义的控制器特性提供器，MVC框架内部就能识别我们的指定的类型为控制器，并为他们添加控制器的相关功能。</p><p>设计有点绕，那么我们用代码来实现：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">//示例直接new ServiceCollection对象，下面有完整的能运行的示例代码。</span><span class="token keyword">var</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>services<span class="token punctuation">.</span><span class="token function">AddMvcCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">ConfigureApplicationPartManager</span><span class="token punctuation">(</span>manager <span class="token operator">=</span><span class="token operator">></span>        <span class="token punctuation">{</span>            <span class="token keyword">var</span> featureProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceControllerFeatureProvider</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ITestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            manager<span class="token punctuation">.</span>FeatureProviders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>featureProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="看看效果"><a href="#看看效果" class="headerlink" title="看看效果"></a>看看效果</h3><p>现在，在TestService类所在项目文件中引入以下Nuget包（没错，运行一个webapi只需要两个Nuget包）：</p><pre class="line-numbers language-xml"><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Hosting<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.0.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PackageReference</span> <span class="token attr-name">Include</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Microsoft.AspNetCore.Mvc.Core<span class="token punctuation">"</span></span> <span class="token attr-name">Version</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2.0.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>然后在控制台程序的入口文件Program.cs的Main方法中写入一下代码：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Program</span><span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>    <span class="token punctuation">{</span>       <span class="token keyword">new</span> <span class="token class-name">WebHostBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">UseKestrel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">UseUrls</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080"</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>services <span class="token operator">=</span><span class="token operator">></span>            <span class="token punctuation">{</span>                services<span class="token punctuation">.</span><span class="token function">AddMvcCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">ConfigureApplicationPartManager</span><span class="token punctuation">(</span>manager <span class="token operator">=</span><span class="token operator">></span>                <span class="token punctuation">{</span>                    <span class="token keyword">var</span> featureProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceControllerFeatureProvider</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>ITestService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    manager<span class="token punctuation">.</span>FeatureProviders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>featureProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span>app <span class="token operator">=</span><span class="token operator">></span> app<span class="token punctuation">.</span><span class="token function">UseMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>一切编译通过后，点击运行，在浏览器中访问”<a href="http://localhost:8080/test/elderjames" target="_blank" rel="noopener">http://localhost:8080/test/elderjames</a>”，如果看到返回了“Hello elderjames”，那么就大功告成啦！</p><p><img src="/images/add_webapi_to_class/1.png" alt=""></p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这篇文章中主要介绍了通过实现<code>IApplicationFeatureProvider&lt;ControllerFeature&gt;</code>接口实现设置指定类型为WebApi控制器的方法。</p><p>在接下来的文章中，我会介绍如何从接口获取自定义特性标签，实现从接口获得mvc特性，使得接口和实现类都不依赖MVC库的方法，只要在接口中以标记特性的方式定义了路由和http方法，实现类的操作就都按照接口的路由和http方法去提供WebApi服务，最后还要介绍使用功能强大的.NTE Core开源AOP框架<a href="https://github.com/dotnetcore/AspectCore-Framework" target="_blank" rel="noopener"><strong>AspectCore</strong></a>实现的动态代理客户端，注册以上所说的接口，即可获得可以调用对应的WebApi服务的功能。这些工作的源码可以在<a href="https://github.com/ElderJames/shriek-fx/tree/master/samples/Shriek.Samples.WebApiProxy" target="_blank" rel="noopener">我的框架示例项目</a>中运行，大家有兴趣可以看看效果。</p><p><strong>感谢阅读和批评指教！</strong></p><p>[温馨提示：为方便大家看文中提到的源码，原文中有大量指向源码链接，如果您看的是没有链接的转载，可以再来看我的原文。]</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> ASP.NET Core </tag>
            
            <tag> WebApi </tag>
            
            <tag> MVC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>更换阿里云Docker镜像源</title>
      <link href="/change-the-docker-image-origin-to-aliyun.html"/>
      <url>/change-the-docker-image-origin-to-aliyun.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>由于Docker技术比虚拟机技术更为轻便、快捷。自 2013 年 3 月以Apache 2.0授权协议开源后，到近两年成为当下分布式系统最热门的开发运维方式。由于国内网络连接Docker官方源很慢，甚至无法从官方源拉取镜像创建容器，所以这篇文章介绍如何把Docker源更换为阿里云的，使中国开发者也能学习并运用到Docker带来的DevOps变革。</p><h4 id="运行环境-与换源无关-："><a href="#运行环境-与换源无关-：" class="headerlink" title="运行环境 (与换源无关)："></a>运行环境 (与换源无关)：</h4><ul><li>Windows 10</li><li>Docker for Windows <a href="https://download.docker.com/win/stable/Docker%20for%20Windows%20Installer.exe" target="_blank" rel="noopener">下载</a></li><li>Kitematic <a href="https://github.com/docker/kitematic/releases/download/v0.17.1/Kitematic-0.17.1-Windows.zip" target="_blank" rel="noopener">下载</a></li></ul><p>安装Docker的同时，我们可以先登录阿里云管理平台，通过前台页面进入【容器服务控制台】(<a href="https://cs.console.aliyun.com/#/repo" target="_blank" rel="noopener">https://cs.console.aliyun.com/#/repo</a>)</p><h4 id="登录阿里云容器服务控制台"><a href="#登录阿里云容器服务控制台" class="headerlink" title="登录阿里云容器服务控制台"></a>登录阿里云容器服务控制台</h4><p>容器控制台的入口不是在一开始登录控制台的页面里的，所以如果以后记不住这个地址，可以按以下页面进入。</p><ol><li><p>指向阿里云首页的导航栏“产品”选项，从下拉的列表中点击“容器服务”</p><p> <img src="/images/aliyun-docker/1.png" alt=""></p></li><li><p>从容器服务页面的上宣传图中点击“管理控制台”按钮进入。</p><p> <img src="/images/aliyun-docker/2.png" alt=""></p></li></ol><h4 id="获取镜像地址"><a href="#获取镜像地址" class="headerlink" title="获取镜像地址"></a>获取镜像地址</h4><p>进入控制台后，点击副侧边栏的“镜像”选项卡，在进入的页面中点击右上方的“镜像仓库控制台”链接。</p><p><img src="/images/aliyun-docker/3.png" alt=""></p><p>再点击副侧边栏的“Docker Hub 镜像站点”选项卡，就能看到阿里云分配的“专属加速器地址”：</p><p><img src="/images/aliyun-docker/4.png" alt=""></p><h4 id="配置到Docker"><a href="#配置到Docker" class="headerlink" title="配置到Docker"></a>配置到Docker</h4><p>这个地址怎么用呢？当然是配置到Docker的设置里了。运行Docker后，右键点击Docker Logo，点击setting按钮。在进入设置面板后，点击“Daemon”选项卡，点击“Basic”左边的开关，在下边输入框中会出现空的配置json字符串，这时就把从阿里云获取到的镜像地址填入“registry-mirrors”节点，如图：</p><p><img src="/images/aliyun-docker/5.png" alt=""></p><p>然后点击Apply，大功告成！</p><p>我们可以通过在Kitematic中选择一个镜像创建一个容器试试看。</p><p><img src="/images/aliyun-docker/6.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>领域驱动设计（DDD）项目收集</title>
      <link href="/ddd-project-collection.html"/>
      <url>/ddd-project-collection.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>自从来了现在这家公司之后，就喜欢实践DDD开发程序，最近开始写一个叫做<a href="https://github.com/ElderJames/ShriekFx" target="_blank" rel="noopener">尖叫(Shriek)</a>的轻量DDD开源框架，下面列出一些在学习和开发过程中参考过的DDD开源项目。希望对淋浴驱动设计有兴趣的同行可以一起交流。</p><h1 id="NET-Core"><a href="#NET-Core" class="headerlink" title=".NET Core"></a>.NET Core</h1><ul><li><a href="https://github.com/Weapsy/Weapsy" target="_blank" rel="noopener">Weapsy</a></li><li><a href="https://github.com/EduardoPires/EquinoxProject" target="_blank" rel="noopener">EquinoxProject</a></li><li><a href="https://github.com/thangchung/magazine-website" target="_blank" rel="noopener">magazine-website</a></li><li><a href="https://github.com/daxnet/Apworks" target="_blank" rel="noopener">Apworks</a></li><li><a href="https://github.com/daxnet/we-text" target="_blank" rel="noopener">we-text</a></li><li><a href="https://github.com/mastreeno/Merp" target="_blank" rel="noopener">Merp</a></li><li><a href="https://github.com/Kation/ComBoost" target="_blank" rel="noopener">ComBoost</a></li></ul><h1 id="NET"><a href="#NET" class="headerlink" title=".NET"></a>.NET</h1><ul><li><a href="https://github.com/tangxuehua/enode" target="_blank" rel="noopener">ENode</a></li><li><a href="https://github.com/ElderJames/MyDiary.CQRS" target="_blank" rel="noopener">MyDiary.CQRS</a></li><li><a href="https://github.com/ElderJames/naa4e" target="_blank" rel="noopener">Microsoft .NET企业级应用架构设计（第2版）源码</a></li></ul><p>最近身体不适，对这些项目的介绍我会在身体好了之后补上。</p>]]></content>
      
      
      <categories>
          
          <category> DDD </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> .NET </tag>
            
            <tag> DDD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>给你的域名加把锁：免费Https申请</title>
      <link href="/how-to-request-a-free-https.html"/>
      <url>/how-to-request-a-free-https.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>关于Https的介绍，先引用一段维基百科的描述：</p><blockquote><p>超文本传输安全协议（英语：Hypertext Transfer Protocol Secure，缩写：HTTPS，常称为HTTP over TLS，HTTP over SSL或HTTP Secure）是一种通过计算机网络进行安全通信的传输协议。HTTPS经由HTTP进行通信，但利用SSL/TLS来加密数据包。HTTPS开发的主要目的，是提供对网站服务器的身份认证，保护交换数据的隐私与完整性。这个协议由网景公司（Netscape）在1994年首次提出，随后扩展到互联网上。<br>历史上，HTTPS连接经常用于万维网上的交易支付和企业信息系统中敏感信息的传输。在2000年代晚期和2010年代早期，HTTPS开始广泛使用于保护所有类型网站上的网页真实性，保护账户和保持用户通信，身份和网络浏览的私密性。</p></blockquote><p>除了平常我们看不见的安全性外，拥有Https前缀的域名被浏览器加了把锁，看起来就比没有的牛~而且，苹果在去年已经规定所有应用内链接都需要有https了！</p><p>企业级ssl证书费用高昂，如果只是个人网站没必要用企业级的，使用一些免费的就好了。接下来，我就以我的个人域名为例，介绍下申请免费https的流程。</p><p>此处炫耀一下：  <img src="/images/15.png" alt=""></p><h4 id="提前准备"><a href="#提前准备" class="headerlink" title="提前准备"></a>提前准备</h4><ol><li>一个自己的域名，可以在国内的域名注册商购买注册，如阿里云、腾讯云，然后最好是做好备案，因为微信等一些客户端的链接分享都要求备案过的域名才能正常访问。当然，不备案也不妨碍绑定Github Pages和国外服务器。</li></ol><h4 id="教程目标"><a href="#教程目标" class="headerlink" title="教程目标"></a>教程目标</h4><ol><li>给自己的域名设置 Flexible SSL 认证，即网站到解析服务器间的加密传输，让域名可以使用https</li><li>访问http域名，自动301跳转到https</li><li>访问<a href="http://www.yourdomain.com" target="_blank" rel="noopener">http://www.yourdomain.com</a> ,会自动跳转到<a href="https://yourdomain.com（当然，可以反过来）" target="_blank" rel="noopener">https://yourdomain.com（当然，可以反过来）</a></li></ol><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><h5 id="注册CloudFlare帐户，并添加域名解析"><a href="#注册CloudFlare帐户，并添加域名解析" class="headerlink" title="注册CloudFlare帐户，并添加域名解析"></a>注册CloudFlare帐户，并添加域名解析</h5><p>访问<a href="https://www.cloudflare.com/a/sign-up" target="_blank" rel="noopener">CloudFlare注册页面</a>,简单地输入邮箱和密码就能注册成功好。</p><h5 id="添加域名"><a href="#添加域名" class="headerlink" title="添加域名"></a>添加域名</h5><p>登录后，访问<a href="https://www.cloudflare.com/a/add-site" target="_blank" rel="noopener">Add Websites页面</a>添加一个域名，如我的是yangshunjie.com，然后点击【Begin Scan】扫描。大概需要等待1分钟，完成后点击【Continue Setup】继续下一步。</p><p><img src="/images/6.png" alt=""></p><h5 id="设置解析项"><a href="#设置解析项" class="headerlink" title="设置解析项"></a>设置解析项</h5><p>这时，我们需要添加域名解析了，将域名解析到指向的服务器。这跟普通的域名解析绑定是一样的。如果要绑定Github Pages，就需要参考<a href="https://help.github.com/articles/setting-up-an-apex-domain/#configuring-a-records-with-your-dns-provider" target="_blank" rel="noopener">Github Help官方指南</a>添加A记录分别指向<code>192.30.252.153</code>和<code>192.30.252.154</code>。另外再设置一个www的CNAME记录，指向yangshunjie.com。</p><p><img src="/images/7.png" alt=""></p><h5 id="修改域名解析服务器"><a href="#修改域名解析服务器" class="headerlink" title="修改域名解析服务器"></a>修改域名解析服务器</h5><p>登录你的域名注册商的控制后台，把DNS解析服务器改为CloudFlare提供的两个地址。然后等待转移完成。我的域名是在阿里云注册的，所以这里截图演示一下：</p><p><img src="/images/8.png" alt=""><br><img src="/images/9.png" alt=""></p><blockquote><p>注：官方说明，域名服务器修改最长需要72小时生效 ，用了两个域名测试，大约需要 5~30 分钟，看到 Status: Active 即可。</p></blockquote><p><img src="/images/10.png" alt=""></p><h5 id="设置加密方式"><a href="#设置加密方式" class="headerlink" title="设置加密方式"></a>设置加密方式</h5><p>回到CloudFlare，点击上部的 crypto 菜单 , 然后设置 <strong><em>Flexible SSL</em></strong> 。</p><p><img src="/images/11.png" alt=""></p><h5 id="设置页面规则"><a href="#设置页面规则" class="headerlink" title="设置页面规则"></a>设置页面规则</h5><p> 接着点击 Page Rules 菜单，添加两个规则，一个是将<code>http://yangshunjie.com/*</code>设为 Always Use HTTPS,一个是讲<code>http://www.yangshunjie.com/</code>重定向到<code>https://yangshunjie.com/</code>(如果需要默认跳转到www开头的域名，则这里就重定向到<code>https://www.yangshunjie.com/</code>即可)。</p><p><img src="/images/12.png" alt=""><br><img src="/images/13.png" alt=""><br><img src="/images/14.png" alt=""></p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ol><li>以后你需要绑定其它服务器，都需要在这里配置。DNS记录视缓存的时间一般需要5~30分钟生效。</li></ol>]]></content>
      
      
      <categories>
          
          <category> Github Pages </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Github Pages </tag>
            
            <tag> Https </tag>
            
            <tag> SSL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用AppVeyor持续集成你的Hexo博客</title>
      <link href="/Use-Appveyor-to-continuously-integrate-your-Hexo-blog.html"/>
      <url>/Use-Appveyor-to-continuously-integrate-your-Hexo-blog.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>炎热的盛夏，真的是让人难以入眠。在这种不免之夜，如果还加上停电……简直就是惨绝人寰了！</p><p>还好，今晚没停电，可以让我吹着风扇安心去写这篇文章。</p><p>距离我建立这个博客都过去一周了，一直都在做这个站点的建设。首先是找到个好看的主题，之后绑定自己的https域名，然后是寻找更多玩法，比如放了只可爱的猫咪在右下角，它会跟随者你的鼠标摇头摆尾~比如在底部贴了我的GitHub贡献马赛克，在我的朋友页面抓取我的Github followers，还有就是这篇文章的重点，用AppVeyor去持续集成Hexo博客。</p><p>AppVeyor是目前唯一支持.NET开源项目的持续集成功能，运行环境是Windows，身为.NET开发者和软粉的我，怎么不支持一下这个有情怀的服务商呢？</p><p><del>太晚了，挖坑，明天继续写。</del> </p><h4 id="第一步，创建CI项目"><a href="#第一步，创建CI项目" class="headerlink" title="第一步，创建CI项目"></a>第一步，创建CI项目</h4><p>访问<a href="https://ci.appveyor.com/projects" target="_blank" rel="noopener">AppVeyor网站</a>，注册或使用Github帐号授权登录，在PROJECTS页面点击【NEW PROJECT】，然后在右侧选择你的Hexo博客所在的仓库。</p><p><img src="/images/1.png" alt=""></p><h4 id="第二步，配置项目和环境变量"><a href="#第二步，配置项目和环境变量" class="headerlink" title="第二步，配置项目和环境变量"></a>第二步，配置项目和环境变量</h4><p>点击项目里的[SETTING]选项卡，配置以下几项：</p><ol><li>Default branch -&gt; [你存放原文件的分支名]</li><li>Branches to build -&gt; 选择Only branches specified below,并填入[你存放原文件的分支名]</li></ol><p>如下图，然后点击一下下方的Save按钮。<br><img src="/images/2.png" alt=""></p><p>点击右侧的Environment标签，添加环境变量：</p><table><thead><tr><th align="left">左对齐标题</th><th align="left">右对齐标题</th></tr></thead><tbody><tr><td align="left"><code>STATIC_SITE_REPO</code></td><td align="left">你的仓库地址</td></tr><tr><td align="left"><code>TARGET_BRANCH</code></td><td align="left">编译后文件存放的分支</td></tr><tr><td align="left"><code>GIT_USER_EMAIL</code></td><td align="left">Github的用户邮箱</td></tr><tr><td align="left"><code>GIT_USER_NAME</code></td><td align="left">Github用户名</td></tr></tbody></table><p>如下图，然后点击一下下方的Save按钮。</p><p><img src="/images/3.png" alt=""></p><h4 id="第三步，获取Access-Token"><a href="#第三步，获取Access-Token" class="headerlink" title="第三步，获取Access Token"></a>第三步，获取Access Token</h4><p>访问个人设置页面：</p><p><img src="/images/4.png" alt=""></p><p>点击边栏下方的【Personal access tokens】选项卡，并点击右上方的【Generate new token】按钮。Token description任意填写，下方的选项中全选repo即可。</p><p>最后，点击下方绿色的【Generate token】按钮。此时就能得到你的Access Token。</p><p>也可以参考<a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/" target="_blank" rel="noopener">官方文档</a></p><h4 id="第四步，加密Access-Token"><a href="#第四步，加密Access-Token" class="headerlink" title="第四步，加密Access Token"></a>第四步，加密Access Token</h4><p>由于这个AccessToken是可以直接操作你的仓库的，而且配置文件是公开的，所以这时就要求对AccessToken进行加密。可到<a href="https://ci.appveyor.com/tools/encrypt" target="_blank" rel="noopener">AppVeyor Token加密页面</a>进行加密。把加密后的字符串填入下一步中的配置文件里。</p><h4 id="第五步，配置文件"><a href="#第五步，配置文件" class="headerlink" title="第五步，配置文件"></a>第五步，配置文件</h4><p>在Hexo的<strong>根目录</strong>下新建一个<code>appveyor.yml</code>文件，写下以下内容</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">clone_depth</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token comment" spellcheck="true"># 这里是限制了只编译有源文件的分支，这样在创建了其它分支时就不会再次编译了</span><span class="token key atrule">branches</span><span class="token punctuation">:</span>  <span class="token key atrule">only</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> files<span class="token key atrule">environment</span><span class="token punctuation">:</span>  <span class="token key atrule">access_token</span><span class="token punctuation">:</span>    <span class="token key atrule">secure</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#加密后的access_token</span><span class="token key atrule">install</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">ps</span><span class="token punctuation">:</span> Install<span class="token punctuation">-</span>Product node 6.0 <span class="token comment" spellcheck="true">#原始环境的node 是4.x的版本，最好升级到最新的版本，防止Hexo的插件无法安装</span>  <span class="token punctuation">-</span> node <span class="token punctuation">-</span><span class="token punctuation">-</span>version  <span class="token punctuation">-</span> npm <span class="token punctuation">-</span><span class="token punctuation">-</span>version  <span class="token punctuation">-</span> npm install  <span class="token punctuation">-</span> npm install hexo<span class="token punctuation">-</span>cli <span class="token punctuation">-</span>g<span class="token key atrule">build_script</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> hexo generate<span class="token key atrule">artifacts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> public<span class="token key atrule">on_success</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> git config <span class="token punctuation">-</span><span class="token punctuation">-</span>global credential.helper store  <span class="token punctuation">-</span> <span class="token key atrule">ps</span><span class="token punctuation">:</span> Add<span class="token punctuation">-</span>Content "$env<span class="token punctuation">:</span>USERPROFILE\.git<span class="token punctuation">-</span>credentials" "https<span class="token punctuation">:</span>//$($env<span class="token punctuation">:</span>access_token)<span class="token punctuation">:</span>x<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>basic@github.com`n"  <span class="token punctuation">-</span> git config <span class="token punctuation">-</span><span class="token punctuation">-</span>global user.email "%GIT_USER_EMAIL%"  <span class="token punctuation">-</span> git config <span class="token punctuation">-</span><span class="token punctuation">-</span>global user.name "%GIT_USER_NAME%"  <span class="token punctuation">-</span> git clone <span class="token punctuation">-</span><span class="token punctuation">-</span>depth 5 <span class="token punctuation">-</span>q <span class="token punctuation">-</span><span class="token punctuation">-</span>branch=%TARGET_BRANCH% %STATIC_SITE_REPO% %TEMP%\static<span class="token punctuation">-</span>site  <span class="token punctuation">-</span> cd %TEMP%\static<span class="token punctuation">-</span>site  <span class="token punctuation">-</span> del * /f /q  <span class="token punctuation">-</span> for /d %%p IN (*) do rmdir "%%p" /s /q  <span class="token punctuation">-</span> SETLOCAL EnableDelayedExpansion &amp; robocopy "%APPVEYOR_BUILD_FOLDER%\public" "%TEMP%\static<span class="token punctuation">-</span>site" /e &amp; IF <span class="token tag">!ERRORLEVEL!</span> EQU 1 (exit 0) ELSE (IF <span class="token tag">!ERRORLEVEL!</span> EQU 3 (exit 0) ELSE (exit 1))  <span class="token punctuation">-</span> git add <span class="token punctuation">-</span>A  <span class="token punctuation">-</span> git commit <span class="token punctuation">-</span>m "Update Static Site"  <span class="token punctuation">-</span> git push origin %TARGET_BRANCH%  <span class="token punctuation">-</span> appveyor AddMessage "Static Site Updated"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>大致的意思是从github仓库的当前分支拉取下来，编译成静态文件后，在push到目标分支。由于AppVeyor环境中是通过Access Token访问我们的仓库的，而Hexo自带的部署则在访问的过程中需要我们输入帐号密码，所以Hexo g -d的命令就不适合在这里使用。需要先编译成静态文件，再把public文件夹的静态文件push到目标分支。</p><p>最后，把这个文件提交到Github上就可以测试了！在AppVeyor的首页可以看到部署的过程和结果~</p><p><img src="/images/5.png" alt=""></p><p>别说我没告诉你，还可以添加一枚徽章装装逼哦！<a href="https://ci.appveyor.com/project/ElderJames/elderjames-github-io/branch/files" target="_blank" rel="noopener"><img src="https://ci.appveyor.com/api/projects/status/b0wack7uxrvifijj/branch/files?svg=true" alt="Build status"></a></p><p>可以看看我的<a href="https://github.com/ElderJames/elderjames.github.io/blob/files/appveyor.yml" target="_blank" rel="noopener">配置文件</a>，以及底部的两篇参考文章~</p><p>参考文章：</p><ul><li><a href="http://www.shong.win/blog/2017/02/19/hexo-ci/" target="_blank" rel="noopener">Hexo利用AppVeyor持续集成</a></li><li><a href="https://formulahendry.github.io/2016/12/04/hexo-ci/" target="_blank" rel="noopener">Hexo的版本控制与持续集成</a></li></ul><script>console.error("Error: [hexo-tag-aplayer] Unrecognized tag argument(2): narrow:true");</script>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Appveyor </tag>
            
            <tag> CI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello Hexo! 从Ghost迁移博客到Hexo</title>
      <link href="/migrate-blog-from-ghost-to-hexo-and-github.html"/>
      <url>/migrate-blog-from-ghost-to-hexo-and-github.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>很高兴用上了hexo来搭建博客！</p><p>因为最近使用学习angular、vue、cordova等框架和技术，慢慢喜欢上了用node来构建应用程序的过程。我原来的博客系统是Ghost,部署在亚马逊AWS上。最近AWS一年免费体验准备到期了，博客也要找个别的地方安放。</p><p>早就知道了github上能搭建博客，但是之前是觉得构建起来很复杂，就没有尝试。这次，我就要尝试一下了！就是你现在看到的模样！</p><p>这篇文章要记下来整个迁移过程。从hexo的安装、构建、部署、安装主题、从Ghost迁移文章。</p><h2 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><p><em><a href="https://hexo.io/zh-cn/docs/index.html" target="_blank" rel="noopener">官方文档</a></em></p><ol start="0"><li><p>安装 <a href="http://nodejs.org/" target="_blank" rel="noopener">Node.js</a> 命令行输入 <code>npm</code>,有相关信息则安装成功 </p></li><li><p>安装 <a href="http://git-scm.com/" target="_blank" rel="noopener">Git</a> 命令行输入<code>Git</code>，有相关信息则安装成功</p></li><li><p>在命令行输入以下命令安装Hexo</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> -g hexo-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>初始化博客</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 初始化一个目录，&lt;folder>不填则为当前目录</span>$ hexo init <span class="token operator">&lt;</span>folder<span class="token operator">></span>$ <span class="token function">cd</span> <span class="token operator">&lt;</span>folder<span class="token operator">></span><span class="token comment" spellcheck="true"># 安装依赖包</span>$ <span class="token function">npm</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新建完成后，指定文件夹的目录如下：</p><pre><code>.├── _config.yml   -&gt; 全局配置文件├── package.json  -&gt; node的项目配置文件，用来配置依赖包和一些npm命令├── scaffolds     -&gt; 模板文件夹。当您新建文章或页面时，Hexo 会根据 scaffold 来建立文件├── source        -&gt; 资源文件夹是存放用户资源的地方,在里面创建文章、页面、图片等博客的内容|   ├── _drafts   -&gt; 草稿文件夹|   └── _posts    -&gt; 文章文件夹└── themes        -&gt; 主题文件夹。Hexo 会根据主题来生成静态页面</code></pre></li><li><p>输入以下命令，启动站点查看效果</p><pre class="line-numbers language-bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果想更换端口，可以在命令后追加参数</p><pre class="line-numbers language-bash"><code class="language-bash">$ hexo server -p 8080<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>此时在浏览器访问 <a href="http://localhost:4000" target="_blank" rel="noopener">http://localhost:4000</a> 就可以看到博客效果啦！</p><p>什么?默认主题不好看？别急，后面会讲如何安装主题~ 接下来介绍如何发布到Github！</p></li></ol><h2 id="发布到GitHub"><a href="#发布到GitHub" class="headerlink" title="发布到GitHub"></a>发布到GitHub</h2><p>接下来介绍如何把这个博客发布到Github Page。</p><p>Github Pages是Github为开源项目提供展示文档和示例的功能，有300M的空间，但只是放置静态文件，所以Hexo就必须先编译成静态文件，再push到Github Pages仓库。</p><ol><li><p>创建Github仓库，名称必须是[Github用户名].github.io,例如本博客的仓库 <a href="https://elderjames.github.io" target="_blank" rel="noopener">elderjames.github.io</a>,然后获得git仓库的地址，如<a href="https://github.com/ElderJames/elderjames.github.io.git" target="_blank" rel="noopener">https://github.com/ElderJames/elderjames.github.io.git</a></p></li><li><p>部署配置</p><p>在开始之前，您必须先在 _config.yml 中修改参数</p><pre class="line-numbers language-yml"><code class="language-yml">deploy: type: git repo: https://github.com/ElderJames/elderjames.github.io.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>命令行输入以下命令，安装部署工具 hexo-deployer-git</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> hexo-deployer-git --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>输入以下命令，编译并发布到Github</p><pre class="line-numbers language-bash"><code class="language-bash">$ hexo deploy --generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><em>这个命令是可以分开的，一个是编译静态文件，一个是发布，具体请<a href="https://hexo.io/zh-cn/docs/generating.html" target="_blank" rel="noopener">参阅文档</a></em></p></li><li><p>如果成功提交到Github,则可以马上访问仓库名的那个地址 <a href="https://elderjames.github.io" target="_blank" rel="noopener">https://elderjames.github.io</a></p></li></ol><h2 id="尝试写一篇新文章"><a href="#尝试写一篇新文章" class="headerlink" title="尝试写一篇新文章"></a>尝试写一篇新文章</h2><pre class="line-numbers language-bash"><code class="language-bash">  $ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="安装主题"><a href="#安装主题" class="headerlink" title="安装主题"></a>安装主题</h2><p>  主题在Github上有很多了，比如我现在安装这个，只要把主题文件复制到 themes 目录下，每个子目录代表一个主题。主题还能有很多扩展的设置，具体可能要参考主题的文档。</p><h2 id="从Ghost迁移文章"><a href="#从Ghost迁移文章" class="headerlink" title="从Ghost迁移文章"></a>从Ghost迁移文章</h2><p>  由于我之前的博客部署在 AWS 上，是 Ghost 博客系统，好处是文章用 markdown 编写，可以很好的迁移到 Hexo。</p><ol start="0"><li><p>从Ghost博客导出博客数据，几下保存的路径</p><p>访问 <a href="http://yourblog.com/ghost/debug/" target="_blank" rel="noopener">http://yourblog.com/ghost/debug/</a> , 点击 【导出】按钮下载一个 Json 文件。</p></li><li><p>安装迁移工具</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> -g hexo-migrator-ghost<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>输入以下命令导入文章到 Hexo, <code>&lt;source&gt;</code> 为第0步下载的json文件的路径。</p><pre class="line-numbers language-bash"><code class="language-bash">$ hexo migrate ghost <span class="token operator">&lt;</span>source<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><p>然后，可以愉快得看到 <code>./source/_posts</code>（如果有草稿，则包括<code>./source/_dragts</code>）文件夹里已经出现了原来在 Ghost 中的文章。</p><p>好了，再执行一次 <code>hexo deploy --generate</code> 发布文章吧！！</p><p>别忘了互相关注哦！晚安！</p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Github Pages </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Visual Studio 2017 正式版安装问题及解决方案记录</title>
      <link href="/visual-studio-2017-zheng-shi-ban-an-zhuang-wen-ti-ji-jie-jue-fang-an-ji-lu.html"/>
      <url>/visual-studio-2017-zheng-shi-ban-an-zhuang-wen-ti-ji-jie-jue-fang-an-ji-lu.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>##Visual Studio 2017正式版终于出来啦！</p><p>下载地址：<a href="https://www.visualstudio.com/zh-hans/" target="_blank" rel="noopener">请到主页</a></p><p>推荐使用安装器下载，速度比以前快了很多！必装的Web和.NET Core组件只需要15分钟就可以安装完（当然，视网速而定，15分钟是用100M/bs的宽带下载的，下载峰值在5M/s左右）</p><p>以下是记录了一些安装中遇到的问题，会不定时更新。</p><h4 id="Win7-无法安装Cordova"><a href="#Win7-无法安装Cordova" class="headerlink" title="Win7 无法安装Cordova"></a>Win7 无法安装Cordova</h4><p>因为Cordova组件需要PowerShell 6.0，而Win7是不自带的（Win8-Win10自带）,所以先下载PowerShell 6.0吧！</p><p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=34595" target="_blank" rel="noopener">PowerShell 6.0下载地址</a></p><h4 id="Cordova-无法编译成Android"><a href="#Cordova-无法编译成Android" class="headerlink" title="Cordova 无法编译成Android"></a>Cordova 无法编译成Android</h4><p>可能是Gradle压缩包损坏导致，重新下载压缩包放到目录C:\Users\Administrator.gradle\wrapper\dists[gradle-2.13-all]下<br><a href="https://services.gradle.org/distributions/" target="_blank" rel="noopener">单独下载Gradle</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Visual Studio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NPM 国内镜像</title>
      <link href="/n.html"/>
      <url>/n.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>npm由于很多时候都需要从国外的服务器下载组件，由于<strong>众所周知</strong>的原因，国内安装时往往会很慢甚至卡住安装不上的情况，这时就需要替换一下安装源，使用国内服务商提供的镜像：</p><ul><li><a href="http://npm.hacknodejs.com/" target="_blank" rel="noopener">http://npm.hacknodejs.com/</a></li><li><a href="http://registry.npmjs.vitecho.com/" target="_blank" rel="noopener">http://registry.npmjs.vitecho.com/</a></li><li><a href="https://registry.npm.taobao.org" target="_blank" rel="noopener">https://registry.npm.taobao.org</a></li></ul><p>####使用方法<br>永久使用镜像命令： </p><p><code>npm config set registry https://registry.npm.taobao.org</code></p><p>临时使用镜像命令：</p><p><code>npm --registry &quot;http://npm.hacknodejs.com/&quot; install underscore</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> NPM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core中使用依赖注入获得请求生命周期内唯一的DbContext</title>
      <link href="/asp-net-corezhong-shi-yong-qing-qiu-sheng-ming-zhou-qi-nei-wei-yi-de-dbcontext.html"/>
      <url>/asp-net-corezhong-shi-yong-qing-qiu-sheng-ming-zhou-qi-nei-wei-yi-de-dbcontext.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>很高兴，我的博客又回来了。</p><p>在使用.NET Core来开发项目已经有两个多月了，想在这里记录一些在.NET Core中比较方便的知识。</p><p>这里讲一讲在ASP.NET Core中使用依赖注入的方式请求生命周期内唯一的DbContext。<br>按照以往.NET Framework中的Web应用程序使用EF，我们会把DbContext实例放入CallContext中，这是在一个线程周期中可共享的存储对象，来达到获得线程内唯一的DbContext等其它对象。但是在.NET Core时代，已经不需要CallContext了，而是使用最突出的特点——依赖注入。</p><p>首先，我们在Startup.cs中配置好EF Core:</p><pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddDbContext<span class="token punctuation">&lt;</span>YourContext<span class="token punctuation">></span></span><span class="token punctuation">(</span>option <span class="token operator">=</span><span class="token operator">></span>     option<span class="token punctuation">.</span><span class="token function">UseMySql</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">"YunGoConllection"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后，在需要的类中以构造方法注入的方式注入YourContext即可。注意：不管是在MVC项目中还是被应用的类库中，都可以使用注入方法！这就是.NET Core的强大~</p><pre class="line-numbers language-csharp"><code class="language-csharp">  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">:</span> Controller    <span class="token punctuation">{</span>        YourContext _db<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">TestController</span><span class="token punctuation">(</span>YourContext db<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            _db<span class="token operator">=</span>db<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>IActionResult<span class="token operator">></span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">{</span>            <span class="token keyword">var</span> _users<span class="token operator">=</span><span class="token keyword">await</span> _db<span class="token punctuation">.</span>Users<span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>_users<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>     <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实在services.AddDbContext()内部，是已经用services.AddScoped()方法注册了YourContext，用这种方式注册后可以在一次请求生命周期内获得同一个实例，所以，我们可以把所有的注入都使用这种方式，节省因为每次都new对象（等同于注册方法services.AddTransient()）而带来的内存占用~</p>]]></content>
      
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> .NET </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EF Core For Mysql 的DataBase First（基于已有数据库）方式连接数据库</title>
      <link href="/ef-core-for-mysql-de-databasefang-shi-lian-jie-shu-ju-ku.html"/>
      <url>/ef-core-for-mysql-de-databasefang-shi-lian-jie-shu-ju-ku.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>.NET要跨平台，就一定要使用同样可以跨平台的数据库，而轻量的MySQL自然是首选。.NET Core发展到现在，虽然官方的Entity Framework还没发布MySQL版本，但是刚认识的柚子大神已经首先把它做出来了（<a href="http://www.1234.sh/post/pomelo-data-mysql" target="_blank" rel="noopener">他的博客</a>）。</p><p>同时，他也开源了它使用MySql for Entity Framework Core写的轻量博客系统，可惜在数据库连接是使用Code First。Code First当时是好，也是微软官方推荐的数据操作方式，可是，对于已有数据库的项目，希望创建基于已有数据库的.NET Core应用，或者对已有项目进行移植的开发者，就显得力不从心了。</p><p>虽然官方有从数据库创建模型的方法（<a href="https://docs.efproject.net/en/latest/platforms/aspnetcore/existing-db.html" target="_blank" rel="noopener">地址</a>），但是它使用了下面这三个只适用于SqlServer的工具包：</p><ul><li>Microsoft.EntityFrameworkCore.SqlServer</li><li>Microsoft.EntityFrameworkCore.Tools</li><li>Microsoft.EntityFrameworkCore.SqlServer.Design</li></ul><p>目前MySQL方面还没有这些工具包，就自然不能执行从数据库创建模型的命令（如下）了。</p><pre class="line-numbers language-bash"><code class="language-bash">Scaffold-DbContext <span class="token string">"Server=(localdb)\mssqllocaldb;Database=Blogging;Trusted_Connection=True;"</span> Microsoft.EntityFrameworkCore.SqlServer -OutputDir Models<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>因此，我们目前只能手动创建模型，并且在DbContext中将模型与数据库中相应的表绑定起来，具体方法就是在DbContext中重写OnModelCreating方法：</p><pre class="line-numbers language-aspnet"><code class="language-aspnet">        protected override void OnModelCreating(ModelBuilder builder)        {            builder.Entity<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>SliderPicture</span><span class="token punctuation">></span></span>(e =>            {                e.HasKey(x => x.Id);                e.ToTable("yg_slider");            });            builder.Entity<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ClientVersion</span><span class="token punctuation">></span></span>(e =>            {                e.HasKey(x => x.Id);                e.ToTable("yg_version")                .HasIndex(x => x.CreateTime);            });        }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>希望.NET Core能尽快完善并增加更强大的特性，我想这也是所以.NETer的希望。</p>]]></content>
      
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>.NET Core以依赖注入的方式配置MySql的DbContext</title>
      <link href="/yi-zhu-ru-de-fang-shi.html"/>
      <url>/yi-zhu-ru-de-fang-shi.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>使用ASP.NET Core开发Web项目，在很多方面都跟之前的.NET版本有很大不同，在Startup.cs的配置方面,一言不合就使用依赖注入。当然，这对于整个项目的解耦是极好的。这次踩的坑在DbContext的配置上。</p><p>在<a href="http://www.1234.sh/post/pomelo-data-mysql" target="_blank" rel="noopener">柚子大神的博客</a>中,有介绍他移植过来的mysql for ef core的使用方法是在Startup中注册服务：</p><pre class="line-numbers language-aspnet"><code class="language-aspnet">services.AddDbContext<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>YourContext</span><span class="token punctuation">></span></span>(x => x.UseMySql("server=localhost;database=yourdb;uid=root;pwd=yourpwd"));<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>但是，这样配置之后，又需要在YourContext中配置：<br><img src="/content/images/2016/07/0e1ef77c-b03e-439f-a894-cb1de1811695.png" alt=""></p><p>这样的话，其实是等于配置了两次，在DbContext中是直接写ConnectionString的，不能（我还不会）从配置文件中读取。因此，需要寻找一个从Startup中配置的有效方法。</p><p>通过对比MVC6项目模版的sqlserver配置方式，和<a href="https://docs.efproject.net/en/latest/miscellaneous/configuring-dbcontext.html" target="_blank" rel="noopener">官方文档的介绍</a>，发现DbContext里是可以通过注入的方式注册ConnectionString的，方法就是设置构造函数注入DbContextOptions：</p><pre class="line-numbers language-aspnet"><code class="language-aspnet">  public YourContext(DbContextOptions<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>YourContext</span><span class="token punctuation">></span></span> options)            : base(options)        { }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用SecureCRT连接免费的亚马逊云服务器</title>
      <link href="/shi-yong-securecrtlian-jie-ya-ma-xun-yun-fu-wu-qi.html"/>
      <url>/shi-yong-securecrtlian-jie-ya-ma-xun-yun-fu-wu-qi.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>亚马逊AWS有一年的免费体验，相比国内的阿里云、腾讯云的优惠政策更实在，而且又不用认证、也不用备案，一个邮箱帐号就能获得，简直就是我等学生（虽然已经不是了，但刚出来工作没几个钱呀！）的福利！</p><p>在亚马逊中，选择“新加坡”、“首尔”、“东京”这几个位于亚洲的节点响应速度都算是比较快的，虽然比不上国内，但是结合七牛等CDN云服务一样可以做到不错的响应速度。</p><p>而本篇的主题，就是因AWS的特殊连接方式而产生的，虽然网上已经有很多前辈给了教程，但是始终不如自己写一下，等以后可以方便地查到更方便。</p><h6 id="连接服务器"><a href="#连接服务器" class="headerlink" title="连接服务器"></a>连接服务器</h6><ol><li>创建AWS实例的时候，会得到一个.pem后缀的密钥文件，我们需要通过这个文件去连接服务器。</li><li>打开SecureCRT，点击菜单栏“工具”–&gt;“转换密钥为OpenSHH格式”,然后在弹出的文件选择框中选择pem文件，然后在接下来的文件选项框中选择保存转换后密钥对文件的保存路径，这样密钥就保存完了。</li><li>点击“快速连接”按钮，在弹出的“快速连接”窗口中，输入“服务器ip地址”，不输入用户名，在“鉴权”一栏，把“公钥”移动到第一位，即“密码”上面。</li><li>选择“公钥”，然后点击“属性”，再选择“使用会话公钥设置”，在会话设置中选择“使用身份或证书文件”，并点击“…”按钮选择第2步生成的.pub文件。</li><li>最后点击“确定”，并在“快速连接”窗口中点击“连接”，然后在弹出的提示框中点击“是”，此时就已经可以成功连接到服务器了。</li></ol><h6 id="改为使用密码登录"><a href="#改为使用密码登录" class="headerlink" title="改为使用密码登录"></a>改为使用密码登录</h6><p>使用密钥文件连接，虽然是大大加强安全性了，但是对于个人服务器来说就很不方便了，所以，这里把前辈们给出的方法搬过来。</p><ol><li><p>修改ROOT密码<br><code>sudo passwd root</code></p></li><li><p>修改sshd_config文件的限权，用完再把权限改回来<br><code>sudo chmod 777 /etc/ssh/sshd_config</code></p></li><li><p>使用vi编辑<code>vi /etc/ssh/sshd_config</code> </p><ul><li><code>PermitRootLogin</code> 改为 PermitRootLogin yes</li><li><code>PasswordAuthentication no</code>  no 改为 yes</li><li><code>UsePAM yes</code> yes改为no （CentOS此步不需做）</li></ul></li><li><p>执行<code>/etc/init.d/sshd restart</code>或到AWS控制台重启服务器。</p></li></ol><p>这样就搞定啦！！</p><h6 id="使用WinSCP连接"><a href="#使用WinSCP连接" class="headerlink" title="使用WinSCP连接"></a>使用WinSCP连接</h6><p>对于不习惯命令行的我，文件操作还是使用GUI比较方便，在这方面，WinSCP有绝对的口碑，而使用密钥文件来连接的话，还是要多一些步骤。</p><ol><li>新建站点，点击高级按钮，在弹出的“高级站点设置”窗口中，选择“验证”设置项，在“验证参数”选项中点击“…”按钮，选择.pem文件，此时会有将.pem文件转换为PuTTY格式的密钥文件的提示，点击“确定”就好了。</li><li>在弹出的“PuTTY Key Generator”窗口中，如果希望使用密钥文件登录时还需要密码才能登录，可以在“KeyPassphrase”输入框中输入密码和确认密码，然后点击“Save Private Key”按钮，在不填密码时会弹出提示，如果确定不用密码就可以直接点击“是”，这时会保存一个.ppk文件到选定的目录。</li><li>然后回到“高级站点设置”窗口，重复第一步，不过此时选择的是刚刚生成的.ppk文件，点击“确定”按钮回到登录界面。</li><li>登录界面输入主机名，最后点击“登录”按钮即可成功登录。</li></ol><p>好啦，关于亚马逊AWS的使用就写到这吧~~</p>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Amazon AWS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>.NET Core 资料整理</title>
      <link href="/net-core-zi-liao-zheng-li.html"/>
      <url>/net-core-zi-liao-zheng-li.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>##工具下载</p><ul><li><p><a href="http://download.microsoft.com/download/c/2/6/c26892d8-6a5d-4871-9d46-629f4d430146/vs2015.3.vsu.iso" target="_blank" rel="noopener">Visual Studio 2015 Update3 升级包</a></p></li><li><p><a href="ed2k://|file|cn_visual_studio_professional_2015_with_update_3_x86_x64_dvd_8923256.iso|7745202176|DD35D3D169D553224BE5FB44E074ED5E|/">Visual Studio Professional 2015 Update3</a></p></li><li><p><a href="http://download.microsoft.com/download/7/c/f/7cf151c3-b735-4e35-a1bb-9a48224f4a95/vs2015.3.ent_chs.iso" target="_blank" rel="noopener">Visual Studio Enterprise 2015 Update3</a> </p></li><li><p><a href="http://download.microsoft.com/download/5/d/1/5d1ec81e-bc59-448f-9ab6-27636d5cc18a/vs2015.3.com_chs.iso" target="_blank" rel="noopener">Visual Studio Community 2015 Update3</a></p></li><li><p><a href="http://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/DotNetCore.1.0.0-VS2015Tools.Preview2.exe" target="_blank" rel="noopener">.NET Core for VS Tools</a></p></li><li><p><a href="https://az764295.vo.msecnd.net/stable/e724f269ded347b49fcf1657fc576399354e6703/VSCodeSetup-stable.exe" target="_blank" rel="noopener">Visual Studio Code</a></p></li><li><p><a href="https://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/packages/DotNetCore.1.0.0-SDK.Preview2-x64.exe" target="_blank" rel="noopener">.NET Core SDK</a></p></li></ul><p>##文档</p><ul><li><a href="http://www.cnblogs.com/dotNETCoreSG/p/aspnetcore-index.html" target="_blank" rel="noopener">ASP.NET Core 中文文档</a></li></ul><p>##部署</p><ul><li><a href="http://www.cnblogs.com/yunei/p/5662642.html" target="_blank" rel="noopener">Jexus 5.8.2 Beta1发布：为Asp.Net Core进入生产环境提供平台支持</a></li><li><a href="http://www.cnblogs.com/gaobing/p/5663012.html" target="_blank" rel="noopener">ASP.NET Core “完整发布,自带运行时” 到jexus</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记在Mono 4.2 上EF使用Select操作时会发生的错误</title>
      <link href="/yun-xing-zai-monoshang-de-efyun-xing-cuo-wu.html"/>
      <url>/yun-xing-zai-monoshang-de-efyun-xing-cuo-wu.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>错误提示：The classes in the module cannot be loaded.</p><p>代码还原：</p><pre class="line-numbers language-aspnet"><code class="language-aspnet"> var data = await db.Set<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FormulaCarType</span><span class="token punctuation">></span></span>().Where(c => c.Status == (int)CommonStatus.启用).Select(c => new FormulaCarModel            {                Id = c.Id,                Type = c.CardType,                Seats = c.Seats,                FuelConsumption = c.FuelConsumption,                MaintainFee = c.MaintainFee,                CreateTime = c.CreateTime,                Status = (CommonStatus)c.Status            }).ToListAsync();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在查询中，在查询方法（ToListAsync）执行前进行了select的操作，则在执行的时候就会出错（在Windows上运行时不会发生），因此，需要在select前执行查询，再对查询结果进行select的操作。如下则不会出错：</p><pre class="line-numbers language-aspnet"><code class="language-aspnet">var result = await db.Set<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FormulaCarType</span><span class="token punctuation">></span></span>().Where(c => c.Status == (int)CommonStatus.启用).ToListAsync(); var data = result.Select(c => new FormulaCarModel            {                Id = c.Id,                Type = c.CardType,                Seats = c.Seats,                FuelConsumption = c.FuelConsumption,                MaintainFee = c.MaintainFee,                CreateTime = c.CreateTime,                Status = (CommonStatus)c.Status            });<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> .NET </tag>
            
            <tag> mono </tag>
            
            <tag> EF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET Core使用Session方法</title>
      <link href="/as.html"/>
      <url>/as.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><ul><li><p>在project.json配置文件中引入程序集：<code>&quot;Microsoft.AspNetCore.Session&quot;: &quot;1.0.0&quot;</code></p></li><li><p>在Startup.cs的ConfigureService方法中加入以下代码：</p></li></ul><pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddSession</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    options<span class="token punctuation">.</span>IdleTimeout <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>在Configure方法中加： <code>app.UseSession();</code></li></ul><p>于是，Session就可以用啦！</p>]]></content>
      
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> .NET </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从旧版.NET Core 升级到.NET Core 1.0正式版</title>
      <link href="/cong-jiu-ban-net-core-sheng-ji-dao-net-core-1-0zheng-shi-ban.html"/>
      <url>/cong-jiu-ban-net-core-sheng-ji-dao-net-core-1-0zheng-shi-ban.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>6月28日凌晨，RedHat 开发者大会上微软正式发布.NET Core正式版，我作为.NET爱好者，马上就想安装来玩玩，不过因为之前电脑上就装有旧版本，在这次正式版的安装中遇到了一些坑，装了n遍，死活装不上，停留在旧版本。</p><p>下载地址：</p><ol><li><a href="https://go.microsoft.com/fwlink/?LinkId=817245" target="_blank" rel="noopener">.NET Core for Visual Studio official MSI Installer</a><br>(需要先安装<a href="https://www.visualstudio.com/downloads/download-visual-studio-vs" target="_blank" rel="noopener">Visual Studio 2015 Update 3</a>)</li><li><a href="https://go.microsoft.com/fwlink/?LinkID=809122" target="_blank" rel="noopener">.NET Core SDK for Windows</a></li></ol><p>然后，如果你电脑之前没安装过.NET Core,有装了Visual Studio 2015 的话，需要把VS升级到Update3，再安装.NET Core for Visual Studio official MSI Installer（里面已经包含.NET Core SDK）； 如果没装VS，也不打算使用VS的话，可以只安装.NET Core SDK。</p><p>但是，如果以前安装过旧版的.NET Core，就需要先在【控制面板\所有控制面板项\程序和功能】中卸载以前的版本，并且==需要删除所有的环境变量==，在【控制面板\所有控制面板项\系统】中的左侧边栏中点击【高级系统设计】，在弹出的窗口中点击下方的环境变量按钮，在弹出的【环境变量】窗口中的【系统变量】一栏中找到“Path”变量，删除所有指向dotnet、dnx、dnu、dnvm目录的值，然后按“确定”保存退出。</p><p>这样，安装程序才能重新安装新版的.NET Core SDK。在命令提示符窗口中输入<code>dotnet</code>命令即可查看到当前版本是否为正式版1.0.1。</p><p>谢谢大家！</p>]]></content>
      
      
      <categories>
          
          <category> .NET Core </category>
          
      </categories>
      
      
        <tags>
            
            <tag> .NET Core </tag>
            
            <tag> .NET </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git 操作笔记</title>
      <link href="/git-cao-zuo-bi-ji.html"/>
      <url>/git-cao-zuo-bi-ji.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><code>$ cd myproject</code>  你建立的项目文件夹</p><p><code>$ git init</code>   执行git的本地初始化</p><p><code>$ git add .</code>  将所有的文件添加到版本控制系统</p><p><code>$ git commit -m &quot;initial commit&quot;</code>  在本地提交到版本库</p><p><code>$ git remote add origin git@116.255.160.144://srv/gitserver/jewels.git</code> 添加远程仓库(jewels是服务器端项目管理到名字，与本地项目名字无关)</p><p><code>$ git push origin master</code> 将本地版本库推送到远程仓库</p><p><code>git checkout master</code> //进入master分支</p><p><code>git checkout -b frommaster</code> //以master为源创建分支frommaster</p><p>// 把本地仓库提交到远程仓库的master分支中</p><p><code>git push ssh://git@dev.lemote.com/rt4ls.git master</code> </p><p>或使用标记</p><p><code>$ git remote add origin ssh://git@dev.lemote.com/rt4ls.git</code></p><p><code>$ git push origin master</code></p><p><code>$ git push origin test:master</code>         // 提交本地test分支作为远程的master分支</p><p><code>$ git push origin test:test</code>             // 提交本地test分支作为远程的test分支</p><p><code>$ git push origin :test</code>              // 刚提交到远程的test将被删除，但是本地还会保存的，不用担心</p><p>文章来源：<a href="http://www.cnblogs.com/wangkangluo1/archive/2011/09/02/2164313.html" target="_blank" rel="noopener">git 远程分支创建与推送</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu 搭建Gogs ：轻量Git Web端管理系统</title>
      <link href="/ubuntu-da-jian-gogs-qing-liang-git-webduan-guan-li-xi-tong.html"/>
      <url>/ubuntu-da-jian-gogs-qing-liang-git-webduan-guan-li-xi-tong.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Gogs是国人开发的开源git管理系统，类似gitlab，可在服务器上搭建私人的git版本管理系统。内建很多功能，但俾比gitlab安装更方便，占用更少的资源。<br>详细介绍还是看看官方网站吧：<a href="https://gogs.io" target="_blank" rel="noopener">https://gogs.io</a></p><p>现在结合本人的安装过程，在这里做一个记录。适合小白参考。</p><p>安装方法有三种：二进制安装，源码安装，包管理安装，我认为最方便的还是二进制安装。</p><p>首先下载<a href="https://gogs.io/docs/installation/install_from_binary" target="_blank" rel="noopener">二进制包</a>，在这个页面上也有安装教程。</p><p>然后在解压后进入目录，执行 ./gogs web ，则能够启动服务进程，但这时的服务是临时的，一退出就会关闭，所以需要持续化进程配置。</p><p>因为gogs的安装设置页面里的设置只能设置一次，以后要修改则要新建一个文件，所以这里最好先做好准备工作。</p><ul><li>反向代理 代理ip为 <a href="http://localhost:3000/" target="_blank" rel="noopener">http://localhost:3000/</a></li><li>持续进程 使用supervisor</li></ul><p><code>sudo apt-get -y install supervisor</code></p><p><code>sudo mkdir -p /var/log/gogs</code></p><p><code>sudo nano /etc/supervisor/supervisord.conf</code></p><p>在这个文件最下面添加应用信息</p><pre><code>[program:gogs]directory=/home/gogs/command=/home/gogs/gogs webautostart=trueautorestart=truestartsecs=10stdout_logfile=/var/log/gogs/stdout.logstdout_logfile_maxbytes=1MBstdout_logfile_backups=10stdout_capture_maxbytes=1MBstderr_logfile=/var/log/gogs/stderr.logstderr_logfile_maxbytes=1MBstderr_logfile_backups=10stderr_capture_maxbytes=1MBenvironment = HOME=&quot;/home/git&quot;, USER=&quot;git&quot;user = git</code></pre><p>其中directory和command中的路径是gogs目录的路径</p><p>最后执行重启服务<br><code>sudo service supervisor restart</code></p><p>提示Starting supervisor: supervisord.</p><p>然后执行<code>ps -ef | grep gogs</code>查看服务是否已经启动</p><p>如果有如下类似信息则表示服务启动成功：</p><p>root      1344  1343  0 08:55 ?        00:00:00 /home/gogs/gogs web</p><p>这个时候，可以在浏览器上访问<code>http://your_server_ip:3000/</code>或者在反向代理中设置好的地址，自动跳转到/install设置页面。其中要注意的是网址设置，如果已经使用反向代理，则添加设置的地址，应用域名不需要http:// ，而后面的应用url则需要http:// ，否则路由会出错。</p>]]></content>
      
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> gogs </tag>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>修复apt-get包管理</title>
      <link href="/xiu-fu-apt-getbao-guan-li.html"/>
      <url>/xiu-fu-apt-getbao-guan-li.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>1.通过<code>wget http://oss.aliyuncs.com/aliyunecs/update_source.tgz</code> 下载update_source的压缩包。</p><p>2.<code>tar xvf update_source.tgz</code>解压后予执行权限<code>chmod 777 update_source.sh</code>。</p><p>3.执行该脚本<code>./update_source.sh</code>进行自动变更源操作。</p><p><img src="https://img.alicdn.com/tps/TB1tGPGJFXXXXbwXVXXXXXXXXXX-878-324.jpg" alt=""><br><img src="https://img.alicdn.com/tps/TB1Fsr1JFXXXXcFXpXXXXXXXXXX-810-184.jpg" alt=""></p><p>更新成功会提示”Success, exit now!“</p><p>如问题还未解决,请联系售后技术支持。</p><p>来源：<a href="http://www.iisiis.com/web/vps/1884.html" target="_blank" rel="noopener">http://www.iisiis.com/web/vps/1884.html</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C#利用反射机制动态创建泛型接口实例</title>
      <link href="/dong-tai-chuang-jian-fan-xing-jie-kou-shi-li.html"/>
      <url>/dong-tai-chuang-jian-fan-xing-jie-kou-shi-li.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>我很懒，不希望写重复的copy代码，所以希望在写代码时能尽量简化和重用，一些设计上有但没必要的能不写就不写，但当然必须要实现。</p><p>最近学会用C#的反射机制，觉得非常好，可以通过类名实例化一个对应的对象。于是我就想到了在设计业务层时，一些通用的数据库操作是以泛型基类的形式供给各个模型使用的，只需替换传入的模型的类型参数，即刻操作相应的模型，而对于一些模型需要的特殊操作，则以这个基类派生出包含特殊方法的子类来实现。</p><p>但是这里会出现一些问题，就是在各层透明的情况下，其他层是不知道模型是否包含有特殊的方法，最初的解决方法是为每个模型都写一个继承业务基类的子类，就算它里面是空的（没有特殊方法）。而现在，通过反射，我们可以很好地实现统一的业务实例化操作，实现自动判断该模型是否拥有对应的业务子类。</p><p>先设计一个泛型接口<code>IService&lt;T&gt;</code>,声明两个方法：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Service<span class="token punctuation">{</span>   <span class="token keyword">public</span> Interface <span class="token class-name">IService</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span>   <span class="token punctuation">{</span>      IRepository<span class="token operator">&lt;</span>T<span class="token operator">></span> _repo <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>      <span class="token keyword">void</span> <span class="token function">SetRespository</span><span class="token punctuation">(</span>IRepository<span class="token operator">&lt;</span>T<span class="token operator">></span> repo<span class="token punctuation">)</span><span class="token punctuation">;</span>      T <span class="token function">Add</span><span class="token punctuation">(</span>T entity<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">bool</span> <span class="token function">Update</span><span class="token punctuation">(</span>T entity<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后再写一个基础类，继承这个接口：</p><pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Service<span class="token punctuation">{</span>      <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseService</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">:</span> IService<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span>    <span class="token punctuation">{</span>        IRepository<span class="token operator">&lt;</span>T<span class="token operator">></span> _repo <span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">SetRespository</span><span class="token punctuation">(</span>IRepository<span class="token operator">&lt;</span>T<span class="token operator">></span> repo<span class="token punctuation">)</span>        <span class="token punctuation">{</span>            _repo<span class="token operator">=</span>repo<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> T <span class="token function">Add</span><span class="token punctuation">(</span>T entity<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Update</span><span class="token punctuation">(</span>T entity<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>设计业务工厂类，提供统一的实例化出口</p><pre class="line-numbers language-csharp"><code class="language-csharp">    <span class="token comment" spellcheck="true">/// &lt;summary></span>    <span class="token comment" spellcheck="true">/// 业务工厂类</span>    <span class="token comment" spellcheck="true">/// &lt;para>所有业务类都必须从这里产生&lt;/para></span>    <span class="token comment" spellcheck="true">/// &lt;/summary></span>    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceFactory</span>    <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//获取当前程序集中的所有类的类型</span>        <span class="token keyword">static</span> Type<span class="token punctuation">[</span><span class="token punctuation">]</span> ts <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/// &lt;summary></span>        <span class="token comment" spellcheck="true">/// 动态映射创建实现了IService&lt;T>接口的实例</span>        <span class="token comment" spellcheck="true">/// &lt;para>如果字符集中已有继承了BaseService&lt;T>的类，则返回该类的实例,</span>        <span class="token comment" spellcheck="true">/// 否则返回BaseService&lt;T> 的实例&lt;/para></span>        <span class="token comment" spellcheck="true">/// &lt;/summary></span>        <span class="token comment" spellcheck="true">/// &lt;typeparam name="T">数据模型&lt;/typeparam></span>        <span class="token comment" spellcheck="true">/// &lt;param name="repo">仓储实例&lt;/param></span>        <span class="token comment" spellcheck="true">/// &lt;returns>实现IService&lt;T>接口的实例对象&lt;/returns></span>        <span class="token keyword">public</span> <span class="token keyword">static</span> IService<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span>IRepository repo<span class="token punctuation">)</span> <span class="token keyword">where</span> T <span class="token punctuation">:</span> <span class="token keyword">class</span>        <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">//获取传入类型的 System.Type 对象</span>            Type TType <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//取当前线程内存块中可能已存储的Service对象</span>            <span class="token keyword">var</span> _service <span class="token operator">=</span> CallContext<span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span>$<span class="token string">"BaseService&lt;{TType.Name}>"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> IService<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>_service <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> _service<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//查询扩展业务类是否存在于程序集中</span>            Type _class <span class="token operator">=</span> ts<span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> o<span class="token punctuation">.</span>Name<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>TType<span class="token punctuation">.</span>Name <span class="token operator">+</span> <span class="token string">"Service"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span>            <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>_class <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>                <span class="token punctuation">{</span>                    _service <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>_class<span class="token punctuation">)</span> <span class="token keyword">as</span> IService<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">else</span>                <span class="token punctuation">{</span>                    _service <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>BaseService<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> IService<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>            <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span>$<span class="token string">"无法实例化{typeof(BaseService&lt;T>).Name}:{ex.Message}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">//获取泛型类定义的type类型</span>            <span class="token keyword">var</span> _repoType <span class="token operator">=</span> repo<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetGenericTypeDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//传入泛型类型参数</span>            _repoType <span class="token operator">=</span> _repoType<span class="token punctuation">.</span><span class="token function">MakeGenericType</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//实例化仓储类</span>            <span class="token keyword">var</span> _repo <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>_repoType<span class="token punctuation">)</span> <span class="token keyword">as</span> IRepository<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//注入DbContext</span>            _repo<span class="token punctuation">.</span><span class="token function">SetDbContext</span><span class="token punctuation">(</span>repo<span class="token punctuation">.</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//注入仓储类</span>            _service<span class="token punctuation">.</span><span class="token function">SetRespository</span><span class="token punctuation">(</span>_repo<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//将对象保存到当前线程的内存块中</span>            CallContext<span class="token punctuation">.</span><span class="token function">SetData</span><span class="token punctuation">(</span>$<span class="token string">"BaseService&lt;{TType.Name}>"</span><span class="token punctuation">,</span> _service<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> _service<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> .NET </tag>
            
            <tag> C# </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntu安装mono 4.2.1 最新版教程</title>
      <link href="/the-lastest-way-to-install-mono-4-2-1-on-ubuntu.html"/>
      <url>/the-lastest-way-to-install-mono-4-2-1-on-ubuntu.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>现在安装mono已经不用make命令来编译，可以直接执行<code>apt-get mono-complete</code>来安装最新的mono版本。</p><p>下面看看怎么安装：</p><ul><li>首先，在mono-project的安装指南页面获得最新的注册信息，<br><a href="http://www.mono-project.com/docs/getting-started/install/linux/#debian-ubuntu-and-derivatives" target="_blank" rel="noopener">这是地址</a>。</li></ul><p>然后按照上面的命令执行</p><p><code>sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF</code></p><p><code>echo &quot;deb http://download.mono-project.com/repo/debian wheezy main&quot; | sudo tee /etc/apt/sources.list.d/mono-xamarin.list</code></p><p><code>sudo apt-get update</code></p><p>然后，再执行</p><p><code>sudo apt-get install mono-complete</code></p><p>OK,完成。不用再等久久的编译咯！</p>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
            <tag> mono </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET 连接 Mysql 支持中文编码</title>
      <link href="/make-mysql-support-chinese-encoding.html"/>
      <url>/make-mysql-support-chinese-encoding.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>1、关闭mysql服务<br><code>service mysql stop</code></p><p>2、修改 /etc/mysql/my.cnf  （默认的安装路径）<br><code>vim /etc/mysql/my.cnf</code></p><p>3、打开my.cnf后，在文件内的[mysqld]下增加如下两行设置:</p><pre><code>character-set-server=utf8collation-server=utf8_general_ci</code></pre><p><img src="http://" alt=""></p><p>保存并退出。</p><p>4、重新启动mysql服务<br><code>service mysql start</code></p><p>5、连接字符串加入<code>CharSet=utf8;</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ASP.NET MVC 中UEditor 1.4.3 前台直接上传文件到七牛云存储</title>
      <link href="/use-qiniu-upload-file-service-on-ueditor-for-asp-net-mvc.html"/>
      <url>/use-qiniu-upload-file-service-on-ueditor-for-asp-net-mvc.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最近在做一个ASP.NET MVC 的项目，当然是离不开富文本编辑器，这里我选择的是百度的UEditor，虽然不够轻量，界面也不好看，但是功能还是挺多的。而因为项目主要面对移动端的用户，所以为了减轻低配服务器的压力，也为了用户体验更佳，决定在项目中接入七牛云存储。</p><p>选择七牛是看重他的CDN、上传加速和图片处理功能，最神奇的是在获取图片时只需在Url中加入几个参数即刻，而且还可以自己定图片的大小，大大减少了服务器在图片处理上的压力。</p><p>好吧，在这里就不继续安利了。</p><p>我第一次直接在项目中接入七牛，所以还是碰到了很多障碍。过程我就先不说了，我直接说怎么修改UEditor的相关代码吧。</p><p>###前台部分</p><ul><li><p>在配置文件config.json中，修改替换所有的<code>upfile</code> 为<code>file</code>，这里是因为七牛的上传接口要求文件上传控件（input）的name为file。</p></li><li><p>然后在最后加上几个配置项：</p></li></ul><pre class="line-numbers language-js"><code class="language-js">    <span class="token comment" spellcheck="true">/*七牛配置*/</span>    <span class="token string">"access_key"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token string">"secret_key"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>    <span class="token string">"bucket"</span><span class="token punctuation">:</span> <span class="token string">"mybucket"</span><span class="token punctuation">,</span>    <span class="token string">"domain"</span><span class="token punctuation">:</span> <span class="token string">"http://xxx.com/"</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//七牛默认域名或者自定义域名</span>    <span class="token string">"uploadUrl"</span><span class="token punctuation">:</span><span class="token string">"http://upload.qiniu.com/"</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//七牛上传文件的域名</span>    <span class="token string">"imageFieldName"</span><span class="token punctuation">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* 提交的图片表单名称 */</span>    <span class="token string">"tokenAction"</span><span class="token punctuation">:</span> <span class="token string">"/Admin/Attachment/Token"</span><span class="token punctuation">,</span><span class="token comment" spellcheck="true">//获取上传凭证token的Action</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在路径 ueditor/dialogs/image/image.js 中找到<code>header[&#39;X_Requested_With&#39;] = &#39;XMLHttpRequest&#39;;</code> 在下面添加以下代码：</li></ul><pre class="line-numbers language-js"><code class="language-js">  <span class="token keyword">var</span> filename <span class="token operator">=</span> file<span class="token punctuation">.</span>file<span class="token punctuation">.</span>name<span class="token punctuation">;</span>  <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>  $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>       dataType<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>       <span class="token keyword">async</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>       url<span class="token punctuation">:</span> editor<span class="token punctuation">.</span><span class="token function">getOpt</span><span class="token punctuation">(</span><span class="token string">'tokenAction'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"?file="</span> <span class="token operator">+</span> filename<span class="token operator">+</span><span class="token string">"&amp;type=img"</span><span class="token punctuation">,</span>       success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>           oken <span class="token operator">=</span> data<span class="token punctuation">;</span>       <span class="token punctuation">}</span>   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   data<span class="token punctuation">[</span><span class="token string">'token'</span><span class="token punctuation">]</span> <span class="token operator">=</span> token<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>在这段代码的上面，找到<code>uploader.option(&#39;server&#39;, url);</code><br>注释并修改为<code>uploader.option(&#39;server&#39;,editor.getOpt(&#39;uploadUrl&#39;));</code></p></li><li><p>在这段代码下面寻找<code>uploader.on(&#39;uploadSuccess&#39;, function (file, ret) {</code>，并在这个方法中的<code>if (json.state == &#39;SUCCESS&#39;) {</code>增加一行代码：</p></li></ul><pre class="line-numbers language-js"><code class="language-js">      <span class="token comment" spellcheck="true">//在返回的地址加上七牛设置里的域名</span>      json<span class="token punctuation">.</span>url <span class="token operator">=</span> editor<span class="token punctuation">.</span><span class="token function">getOpt</span><span class="token punctuation">(</span><span class="token string">'domain'</span><span class="token punctuation">)</span> <span class="token operator">+</span> json<span class="token punctuation">.</span>url<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>另外在attachment.js、video.js 的相同地方按上面所说的修改。</li></ul><p>###后台部分</p><ul><li><p>引入Qiniu SDK,添加一个获取token的服务:</p></li><li><p>添加获取token的Action（事先已经含有UEditor SDK的代码）：</p></li></ul><p><img src="http://cdn.blog.yangshunjie.com/image/2/80/e2d2079f10dae2c8d51d0b96fe131.png" alt=" "></p><ul><li>OssService.cs 中相关代码</li></ul><p><img src="http://cdn.blog.yangshunjie.com/image/d/b4/cbafea85536df7484629196a29cd6.png" alt=""><br><img src="http://cdn.blog.yangshunjie.com/image/4/18/4538ae76b6e196c09489c059a8651.png" alt=""></p><p>这样就基本可以实现将图片上传到七牛的空间了。而如果想在自己的服务器保留一份文件，可以在token中加如CallbackUrl 和 CallbackBody，使七牛在上传完成后对本地的服务器发出请求，把文件的参数发到本地服务器，这时本地服务器即刻按照返回的文件路径将文件抓取到本地服务器中。这部分我还没着手做，下次再继续写吧！</p>]]></content>
      
      
      
        <tags>
            
            <tag> .NET </tag>
            
            <tag> 七牛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ghost博客邮件SMTP服务配置</title>
      <link href="/the-smtp-setting-for-ghost-blog.html"/>
      <url>/the-smtp-setting-for-ghost-blog.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>前天由于回到学校，用回了我的Pocker2机械键盘，在输入密码时连续不知道大小写切换键换了地方，连续输错了密码，帐号被封了……</p><p>Ghost也是的，连博客主人的号都能封，还不能（也可能是我不会）通过操作服务器（比如Wordpress能通过删除配置文件）来重置密码，只能通过发送邮件，好吧，之前就一直配置不成功，现在好了，只能硬着头皮给它设置好了。</p><p>看过几篇关于配置邮箱的文章，但还是不行，我就以为是我人品不好了。但是今天重新看了配置文件之后，终于发现了我错在哪，所以现在记录一下吧。</p><p>其实问题就在于<strong>填写mail配置的地方不对</strong></p><p>之前我是替换了<code>development</code>节点里的配置。其实，正确的地方是在开头第一个节点<code>production</code>里的<code>mail:{}</code>,把它替换成配置的信息就好了。（这可能跟node.js运行模式的选择有关，我在第一篇文章里有提过，在守护进程里设置的是<strong>production</strong>）</p><p>配置代码片段如下：</p><pre><code>mail: {         transport: &#39;SMTP&#39;,         from: &#39;杨舜杰博客 &lt;blog@yangshunjie.com&gt;&#39;, //发件人         options: {              host: &#39;smtp.yangshunjie.com&#39;,//我已经将自己的域名绑定到了阿里云的企业邮箱              secureConnection: false, //不使用SSL                                   port: 25,//端口              auth: {                  user: &#39;blog@yangshunjie.com&#39;, //邮箱地址                  pass: &#39;********&#39;  //密码              }          }      },</code></pre><p>最后重启一下ghost,一按找回密码，好了，收到邮件了，密码重置了，这篇博文也写完了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> ghost </tag>
            
            <tag> smtp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Framework7多视图（View）工具栏布局</title>
      <link href="/the-multiple-views-structure-on-framework7.html"/>
      <url>/the-multiple-views-structure-on-framework7.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>HiApp 可以算是一个比较完整的App，其中有很多能够学习的地方，比如它用的RequireJS 、它的界面交互等等，而对于初学者来说，它的布局结构是很值得学习的。因为它的结构是目前绝大多数App的常用布局，分为顶部导航栏Navbar，中 部多个视图View，底部是切换view的工具栏Toolbar。</p><p>它的特殊之处在于在界面首层显示了工具栏，而且4个view的底部都是给工具栏空出了位置，而进入到第二层以后，就自动隐藏了工具栏，view内的页 面没有给工具栏留出位置。这是一个很巧妙的结构。</p><p>在文档里，介绍的布局实例里都没有提及这种布局，所以我才说应该去学习。</p><p>但是由于HiApp的模块化结构使得它不易看懂，经过我自己的试验，终于做出了效果大致相同的结构。</p><p>用到的结构html是：</p><pre><code>&lt;div class=&quot;views  navbar-through tabs&quot;&gt;    &lt;div id=&quot;view-1&quot; class=&quot;view tab active&quot;&gt;        &lt;div class=&quot;navbar&quot;&gt;        &lt;/div&gt;        &lt;div class=&quot;pages&quot;&gt;        &lt;/div&gt;    &lt;/div&gt;    &lt;div id=&quot;view-2&quot; class=&quot;view tab&quot;&gt;        &lt;div class=&quot;navbar&quot;&gt;        &lt;/div&gt;        &lt;div class=&quot;pages&quot;&gt;        &lt;/div&gt;    &lt;/div&gt;    &lt;div id=&quot;view-3&quot; class=&quot;view tab&quot;&gt;        &lt;div class=&quot;navbar&quot;&gt;        &lt;/div&gt;        &lt;div class=&quot;pages&quot;&gt;        &lt;/div&gt;    &lt;/div&gt;    &lt;div id=&quot;view-4&quot; class=&quot;view tab&quot;&gt;        &lt;div class=&quot;navbar&quot;&gt;        &lt;/div&gt;        &lt;div class=&quot;pages&quot;&gt;        &lt;/div&gt;    &lt;/div&gt;    &lt;!-- Bottom Toolbar--&gt;    &lt;div class=&quot;bottom-toolbar toolbar tabbar tabbar-labels toolbar-hidden&quot;&gt;        &lt;div class=&quot;toolbar-inner&quot;&gt;            &lt;a href=&quot;#view-1&quot; class=&quot;link tab-link active&quot;&gt;                &lt;i class=&quot;icon-table icon-2x&quot;&gt;&lt;/i&gt;                &lt;span class=&quot;tabbar-label&quot;&gt;课表&lt;/span&gt;            &lt;/a&gt;            &lt;a href=&quot;#view-2&quot; class=&quot;link tab-link&quot;&gt;                &lt;i class=&quot;icon icon-book icon-2x&quot;&gt;                    &lt;span class=&quot;badge bg-red&quot;&gt;4&lt;/span&gt;                &lt;/i&gt;                &lt;span class=&quot;tabbar-label&quot;&gt;读书&lt;/span&gt;            &lt;/a&gt;            &lt;a href=&quot;#view-3&quot; class=&quot;link tab-link&quot;&gt;                &lt;i class=&quot;icon icon-compass icon-2x&quot;&gt;&lt;/i&gt;                &lt;span class=&quot;tabbar-label&quot;&gt;发现&lt;/span&gt;            &lt;/a&gt;            &lt;a href=&quot;#view-4&quot; class=&quot;link tab-link&quot;&gt;                &lt;i class=&quot;icon icon-user icon-2x&quot;&gt;&lt;/i&gt;                &lt;span class=&quot;tabbar-label&quot;&gt;我&lt;/span&gt;            &lt;/a&gt;        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;</code></pre><p>这里注意几个地方：</p><ul><li><p>views里添加 navbar-through类,这使得各个view中的页面默认有工具栏布局</p></li><li><p>toolbar里添加 toolbar-hidden类，这使得toolbar默认关闭，可以给欢迎页面或者登陆页面有全屏的效果。</p></li></ul><p>那么，如何使进入第二层以上的页面隐藏工具栏呢？</p><p>首先看看页面布局：</p><pre><code>&lt;div class=&quot;pages navbar-through&quot;&gt;    &lt;div class=&quot;navbar&quot;&gt;        &lt;div class=&quot;navbar-inner&quot;&gt;            &lt;div class=&quot;center&quot;&gt;Framework7&lt;/div&gt;        &lt;/div&gt;    &lt;/div&gt;    &lt;div id=&quot;me&quot; data-page=&quot;Me&quot; class=&quot;page navbar-through no-swipeback&quot;&gt;        &lt;div class=&quot;page-content contacts-content&quot;&gt;            ...        &lt;/div&gt;    &lt;/div&gt;&lt;/div&gt;</code></pre><p>page中添加no-toolbar类，这使得这个页面有无工具栏布局（底部没有留空），而这仅仅是对page布局有作用，而不会有文档中说的自动隐 藏toolbar效果，因为no-toolbar只会对跟该页面同view下的toolbar起作用，而我们的toolbar不是在view内，而是在各个view之外，所以要隐藏toolbar，还是要靠JS来实现。</p><p>因为本人是初学者，看不懂RequireJS ，所以JS部分是我自己写的。<br>而JS的重点就在于，如何监听当前页面是否在首层呢？很容易想到，要Page添加事件，检验一下当前页是否为第一层的页面。但是要监听什么事件呢？</p><p>如果是pageInit事件，那么在后退时会出现问题，因为F7为了呈现页面动画切换效果，在返回时会提前初始化前一个页面，比如，页面跳转顺序是A —&gt;B—&gt;C，现在要从C返回B，在返回前，view内会有BC两个页面以供切换，而切换到B的时候，F7会销毁C页面，加载A页面，这时会触发pageInit事件，如果用在pageInit触发时隐藏工具栏，那么当你从C切换到B时，工具栏就隐藏了，显然不符合我们要在A页面隐藏的要求。<br>而pageAfterBack事件是在返回动作完成后触发，这就会使得动画效果不连贯，不美观。</p><p>那么，应该用哪个事件呢？</p><p>我这里用的是pageBeforeAnimation，在页面加载完成后不触发，等要切换了动画要开始前才触发。这样，我们就能够在进行页面切换 动画的同时进行工具栏显示动画。</p><p>而另一个重点是，如何检测页面是否为第一层的页面？</p><p>大家都知道，页面事件会传入一个参数e，通过e.detail.page获得pageData，里面包括了name，url等。但是，这个e传的是触发事件的参数，比如从B切换到A，传入的是B页面的参数，所以用name、url等都不能检测出要切换到的页面是否为A页面。但是，当然这个是有解决的办法的。我们从文档中可以找到，PageData中的page.view可以获取当前view，而Views中的View.activePage属性却可以获取当前view的活动页面，也就是说，B切换到A，在动画是在A页面上进行的，活动页是A，所以，这样就能获取到我们要切换到的那个页面的数据了，再进行检验，就OK啦！</p><p>好啦，分析完，下面是JS代码</p><pre><code> //初始化后动画开始前检测当前视图的活动页，如果是第一层的4个页面，则显示工具栏$$(document).on(&#39;pageBeforeAnimation&#39;, function (e) {    var page = e.detail.page.view.activePage;    if (page.name === &#39;Course&#39; || page.name == &#39;Book&#39; || page.name == &#39;Discover&#39; || page.name == &#39;Me&#39;) {        myApp.showToolbar(&#39;.toolbar&#39;);    }    else {        myApp.hideToolbar(&#39;.toolbar&#39;);    }});</code></pre><p>好啦，这个问题就解决啦！希望大家多多分享你的经验哦！另外，有问题的话记得先看看文档，因为文档会解决很多问题的！</p>]]></content>
      
      
      
        <tags>
            
            <tag> Framework7 </tag>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在Jexus环境部署Ghost博客系统</title>
      <link href="/install-ghost-blog-on-jexus-successfully.html"/>
      <url>/install-ghost-blog-on-jexus-successfully.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>###建博感言<br>很久以前就想有自己的博客，但由于无暇顾及而荒废了。之前使用过WordPress，它的功能十分强大，安装之后就一直手痒弄着主题和插件。但是这实在太麻烦了，也不是我最终需要的，。我自认不是一个设计师，不能做出个漂亮的东西，但我喜欢什么样的博客我还是知道的。</p><p>###本文主题<br>Ghost博客系统由node.js写成，它的轻便以及高性能不言而喻，界面用bootstrap风格，原生多种客户端，默认使用Markdown编辑器，完全就是为书写而打造，实在是漂亮，很早之前就想使用，但由于没有自己的服务器，所以一直没用上，现在阿里云有学生优惠，买了配置很低的服务器，就打算使用Ghost来作为我的博客。</p><p>而我的服务器环境有点特殊。</p><p>我本身是个.NET开发者，但由于还是学生，囊中羞涩，又因为相对与Windows服务器，Linux在性能和安全性上确更胜一筹，而.NET的跨平台技术已经进行很长一段时间了，微软去年也宣布了.NET开源和在跨平台上努力着，所以我认为.NET跨平台将是一个行业的趋势，希望能学习在Linux服务器上运行我的.NET程序。</p><p>于是我用的服务器程序是Jexus，一个强大的.NET服务器。</p><p>可能使用Jexus的.NET极客们大多使用自己写的.NET博客系统（已经有大神写出一个开源系统）或者是WordPress，网上并没有关于在Jexus上部署Ghost的教程，但是可以发现网上的教程有一个共通点，就是都使用Web Server的反向代理，而不是直接运行在其之上（而是运行在node.js上的），正好Jexus上有强大的反向代理功能，正好这个功能没使用过，于是今天我就在Jexus上部署了Ghost博客程序。</p><p>###过程<br>node.js和Ghost的安装步骤在官网上都有，我们只需要安装ghost的部骤，不安装和配置服务器程序，因为我们已经安装好jexus了。其中要注意的是，如果直接下载node.js最新版本，就会下载版本号为4.1.1的node.js，而Ghost只能是0.10.* - 0.12.*,官方推荐使用0.10.40，所以记得下载特定版本。</p><p>###步骤</p><p> <strong>安装必要的Ubuntu软件包：</strong></p><pre><code>sudo apt-get updatesudo apt-get upgrade -ysudo aptitude install -y build-essential zip vim wget</code></pre><p><strong>获取node.js</strong></p><pre><code>sudo wget http://nodejs.org/dist/v0.10.40/node-v0.10.40.tar.gztar -zxf node-v0.10.40.tar.gz cd node-v0.10.40$ ./configure $ make $ sudo make install </code></pre><p><strong>安装Ghost中文版</strong></p><pre><code>cd /var/www/myblog/wget http://dl.ghostchina.com/Ghost-0.7.0-zh-full.zipunzip -d ghost Ghost-0.7.0-zh-full.zipcd ghostsudo npm install --productionnpm start</code></pre><p>此时Ghost已安装完成，但是一旦使用<code>Ctrl+C</code>退出到控制台，Ghost进程就会关闭。为了使我们的程序一直保持在后台运行，我们需要使用进程保护程序<em>PM2</em>。</p><pre><code>//需要先进入上面Ghost的安装目录，执行：  sudo npm install pm2 -g//创建一个守护进程，其中“ghost”是对这个进程的命名，可自行修改  NODE_ENV=production pm2 start index.js --name &quot;ghost&quot;//让PM2知道在开机后自动运行我们的网站  pm2 startup ubuntu  pm2 save</code></pre><p><strong>pm2相关命令:</strong></p><p><code>pm2 kill ghost</code>（清除所有ghost进程）</p><p><code>pm2 &lt;start|stop|restart&gt; ghost</code>（启动|停止|重启ghost进程）</p><p><code>pm2 startup &lt;centos|ubuntu|amazon&gt;</code> （让pm2能够在这3个系统上自动启动）</p><p>至此，pm2 已经可以守护 Ghost 博客永远在线。</p><p><strong>Jexus配置</strong></p><p>等Ghost安装之后，就到了Jexus出场了！我们在这里使用的是Jexus强大的的反向代理功能。将我们自己的域名绑定到Ghost在服务器上的本地IP，只需在Jexus新建一个配置文件，并加入一行：<code>reproxy=/  http://127.0.0.1:2368</code>即可，完整的配置是：</p><pre><code>port=80root=/ /var/www/ghost/ghost #ghost所在目录hosts=yangshunjie.com #你需要的域名reproxy=/  http://127.0.0.1:236</code></pre><p>最后记得在配置文件<code>config.js</code>里设置你的域名哦！</p><p>###总结</p><p>这个部署过程让我学会node.js的部署，以及Jexus反向代理的一个用处，就是绑定域名到其他web Server的程序上，这样以后就可以在同一服务器上运行多种语言的程序了（我的服务器目前是.NET+PHP+Node.js）</p><blockquote><p><a href="http://www.applecho.com/installing-ghost-ubuntu/" target="_blank" rel="noopener">Ghost博客平台：在Ubuntu上安装Ghost</a></p></blockquote><blockquote><p><a href="http://www.applecho.com/installing-ghost-pm2/" target="_blank" rel="noopener">Ghost博客平台：安装pm2</a></p></blockquote><blockquote><p><a href="http://www.cnblogs.com/shanyou/archive/2013/05/04/3059950.html" target="_blank" rel="noopener">Jexus 负载均衡</a></p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 环境部署 </tag>
            
            <tag> Jexus </tag>
            
            <tag> Blog </tag>
            
        </tags>
      
    </entry>
    
    
  
  
    
    
    <entry>
      <title>关于我</title>
      <link href="/about.html"/>
      <url>/about.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="博客历程"><a href="#博客历程" class="headerlink" title="博客历程"></a>博客历程</h3><h4 id="2003-2012"><a href="#2003-2012" class="headerlink" title="2003 - 2012"></a>2003 - 2012</h4><p>微信朋友圈上线之前，都是QQ空间为主，只有熟悉的人能看，里面有相册、和自己的一些作品、生活随笔等等。还小嘛，都是青葱往事，基本没有上去看了。</p><h4 id="2013"><a href="#2013" class="headerlink" title="2013"></a>2013</h4><p>在新浪云搭过Wordpress，没正经写什么。</p><h4 id="2014"><a href="#2014" class="headerlink" title="2014"></a>2014</h4><p>注册了阿里云学生服务器，开始把写的程序放上去跑，有了自己的域名yangshunjie.com，搭了个wordpress，尝试各种插件。</p><h4 id="2015-2016"><a href="#2015-2016" class="headerlink" title="2015 - 2016"></a>2015 - 2016</h4><p>注册了AWS，并且用两个邮箱申请了两年的试用服务器。搭载ghost博客系统，开始写一些技术博客了。</p><h4 id="2017"><a href="#2017" class="headerlink" title="2017"></a>2017</h4><p>之前用的虚拟信用卡被注销了，没有信用卡，不能再申请AWS了，于是就在github用Hexo搭建现在这个博客。除了简单免费，还能增加commit数，并且不时为Material主题项目提一下pr。</p><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p><img src="/images/cat/2.jpg" alt=""></p><ul><li>杨舜杰</li><li>男</li><li>2016年于广东海洋大学计算机科学与技术专业毕业</li><li>联系方式：<a href="mailto:shunjiey@hotmail.com">shunjiey@hotmail.com</a></li><li>Github: <a href="http://github.com/elderjames" target="_blank" rel="noopener">github.com/elderjames</a></li></ul><h3 id="兴趣"><a href="#兴趣" class="headerlink" title="兴趣"></a>兴趣</h3><ul><li>喜欢接触新鲜事物，尤其是最新科技</li><li>时刻关注国内外科技动态，尤爱数码产品</li><li>《哈利波特》是童年，周杰伦是青春，大学后迷上美剧</li><li>以前喜欢动手做东西，后来喜欢动手写程序</li></ul><h3 id="大学经历"><a href="#大学经历" class="headerlink" title="大学经历"></a>大学经历</h3><ul><li>大一爱上了轮滑，在轮协认识了很多朋友</li><li>曾任校学生会网络信息部委员、部长</li><li>开发校园助手爱海大，公众号8000+关注，毕业后就弃坑了。</li></ul><h3 id="理想"><a href="#理想" class="headerlink" title="理想"></a>理想</h3><ul><li>据说每个程序员都有一个要用代码改变世界的理想</li></ul><h3 id="目前"><a href="#目前" class="headerlink" title="目前"></a>目前</h3><ul><li>就职于<a href="http://www.100cb.cn/" target="_blank" rel="noopener">广州百财帮网络金融信息服务有限公司</a> 任.NET开发工程师</li><li>业余喜欢学习前端、.NET Core、Docker、Cordova 等技术</li><li>终于有猫了！！起名巴克比克，来自哈利波特里的神奇动物，灰白色，最喜欢舔自己的羽毛。</li></ul><p><img src="/images/cat/1.jpg" alt=""></p>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>分类</title>
      <link href="/categories.html"/>
      <url>/categories.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>留言板</title>
      <link href="/contact.html"/>
      <url>/contact.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>有什么想说，就到这里留言吧！我会很快给你答复！</p>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>朋友们</title>
      <link href="/friends.html"/>
      <url>/friends.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>相册</title>
      <link href="/gallery/index.html"/>
      <url>/gallery/index.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>标签</title>
      <link href="/tags.html"/>
      <url>/tags.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>时间轴</title>
      <link href="/timeline.html"/>
      <url>/timeline.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script>]]></content>
      
    </entry>
    
    
    
    <entry>
      <title>欢迎使用 Ghost 博客系统</title>
      <link href="/welcome-to-ghost-2.html"/>
      <url>/welcome-to-ghost-2.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Yeah，博客上线了！这篇文章的目的是向你介绍 Ghost 编辑器并帮你快速上手。通过 <code>&lt;your blog URL&gt;/ghost/</code> 链接就可以登录系统后台管理你的博客内容了。当你进入后台，你就能看到左侧文章列表处列出的这篇文章，右侧就是这篇文章的预览效果。点击预览栏右上角的铅笔图标就能进入内容编辑页面。 </p><h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>Ghost 使用 Markdown 语法书写内容。简单来说，Markdown 就是一种简化的书写格式！</p><p>用 Markdown 语法写作是很容易的。在编辑界面的左侧就是你写作的地方。在你认为需要的时候，可以使用以下这些语法来格式化你的内容。例如下面这个无序列表：</p><ul><li>Item number one</li><li>Item number two<ul><li>A nested item</li></ul></li><li>A final item</li></ul><p>还可以是有序列表：</p><ol><li>Remember to buy some milk</li><li>Drink the milk</li><li>Tweet that I remembered to buy the milk, and drank it</li></ol><h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><p>如果要链接其它页面，可以直接把页面的 URL 粘贴过来，例如 <a href="http://www.ghostchina.com" target="_blank" rel="noopener">http://www.ghostchina.com</a> - 会被自动识别为链接。但是，如果你想自定义链接文本，可以像这样： <a href="http://www.ghostchina.com" target="_blank" rel="noopener">Ghost 中文网</a>。很简单吧！</p><h3 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h3><p>插入图片也没问题！前提是你事先知道图片的 URL，然后像下面这样：</p><p><img src="http://static.ghostchina.com/image/3/fe/34a9831916be9db1381ecb320491e.png" alt="The Ghost Logo"></p><p>如果图片在本地的硬盘里怎么办？也很简单！像下面这样书写就能为图片预留一个位置，然后你可以继续写作，回头再通过拖拽的方式把图片上传到服务器上。</p><p>![一张图片]</p><h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>有些时候我们需要引用别人说的话，可以这样：</p><blockquote><p>Wisdomous - it’s definitely a word.</p></blockquote><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>或许你是个码农，需要贴一些代码到文章里，可以通过两个引号（Tab 键上面的那个键）加入行内代码 <code>&lt;code&gt;</code>。如果需要加入大段的代码，可以在代码前加 4 个空格缩进，这就是 Markdown 的语法。</p><pre><code>.awesome-thing {    display: block;    width: 100%;}</code></pre><h3 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h3><p>在任一新行输入 3 个或更多的短横线（减号）就是一条分隔线了。</p><hr><h3 id="高级用法"><a href="#高级用法" class="headerlink" title="高级用法"></a>高级用法</h3><p>Markdown 还有一个特别用法，就是在你需要的时候可以直接书写 HTML 代码。</p><input type="text" placeholder="这是个输入框！" /><p>只要掌握了上面的这些介绍，你就已经入门了！继续写作吧！</p>]]></content>
      
    </entry>
    
    
  
</search>
